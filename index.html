<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿ≥Ÿàÿ®ÿ± ŸÖÿßÿ±ŸäŸà - 50 ŸÖÿ≥ÿ™ŸàŸâ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }

        .screen.active {
            display: flex;
        }

        /* Level Select Screen - ZigZag Path Design */
        .level-select-screen {
            background: linear-gradient(180deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .game-header {
            text-align: center;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        .game-title {
            font-size: 36px;
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255,215,0,0.5);
            margin-bottom: 10px;
            font-weight: 900;
        }

        .progress-container {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 15px;
            margin: 0 auto;
            max-width: 300px;
        }

        .progress-bar {
            height: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            border-radius: 5px;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        .progress-text {
            color: white;
            font-size: 14px;
            font-weight: 700;
        }

        /* ZigZag Path Container */
        .path-container {
            position: relative;
            padding: 40px 20px;
            min-height: 3000px;
        }

        /* SVG Path Line */
        .path-line {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 100%;
            z-index: 1;
        }

        .path-line path {
            fill: none;
            stroke: url(#pathGradient);
            stroke-width: 20;
            stroke-linecap: round;
            filter: drop-shadow(0 0 10px rgba(100,200,255,0.5));
        }

        /* Level Nodes Container */
        .levels-wrapper {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column-reverse;
            gap: 80px;
            padding-bottom: 100px;
        }

        .level-row {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            height: 100px;
        }

        /* Alternate sides for zigzag effect */
        .level-row:nth-child(even) {
            justify-content: flex-start;
            padding-left: 15%;
        }

        .level-row:nth-child(odd) {
            justify-content: flex-end;
            padding-right: 15%;
        }

        /* Level Button Styles */
        .level-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid rgba(255,255,255,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            font-weight: 900;
            font-size: 24px;
            color: white;
        }

        .level-btn:active {
            transform: scale(0.95);
        }

        /* Current Level - Green with glow */
        .level-btn.current {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border-color: #90EE90;
            box-shadow: 0 0 30px rgba(72,187,120,0.8), inset 0 0 20px rgba(255,255,255,0.3);
            animation: pulse-glow 2s infinite;
            transform: scale(1.1);
            z-index: 10;
        }

        @keyframes pulse-glow {
            0%, 100% { transform: scale(1.1); box-shadow: 0 0 30px rgba(72,187,120,0.8); }
            50% { transform: scale(1.15); box-shadow: 0 0 50px rgba(72,187,120,1); }
        }

        /* Completed Level - Blue */
        .level-btn.completed {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            border-color: #63b3ed;
        }

        /* Locked Level - Gray */
        .level-btn.locked {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            border-color: #718096;
            color: #a0aec0;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Stars for completed levels */
        .stars {
            position: absolute;
            top: -15px;
            display: flex;
            gap: 2px;
        }

        .star {
            color: #FFD700;
            font-size: 14px;
            text-shadow: 0 0 5px rgba(255,215,0,0.8);
        }

        /* FREE Badge */
        .free-badge {
            position: absolute;
            bottom: -10px;
            background: linear-gradient(135deg, #FF6B6B 0%, #FC8181 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 900;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* M√°rio Character on current level */
        .mario-icon {
            position: absolute;
            top: -25px;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            border-radius: 50%;
            border: 3px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Lock icon for locked levels */
        .lock-icon {
            font-size: 20px;
            opacity: 0.5;
        }

        /* Game Screen Styles */
        .game-screen {
            background: #1a202c;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 15px;
            border: 4px solid #FFD700;
            width: 100%;
            max-width: 800px;
        }

        .game-ui-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            border-radius: 15px;
            color: white;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 900;
        }

        .level-tag {
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 20px;
        }

        canvas {
            border: 4px solid #4A5568;
            border-radius: 10px;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 50%, #90EE90 50%, #228B22 100%);
            width: 100%;
            height: auto;
            aspect-ratio: 2/1;
            display: block;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 10px;
        }

        .joystick-area {
            width: 120px;
            height: 120px;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
            position: relative;
            border: 3px solid rgba(0,0,0,0.2);
        }

        .joystick-knob {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 2px solid white;
        }

        .jump-btn {
            width: 100px;
            height: 60px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            border-radius: 30px;
            border: 3px solid white;
            color: white;
            font-size: 24px;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(238,90,111,0.4);
            font-family: 'Tajawal', sans-serif;
            cursor: pointer;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-weight: 700;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 90%;
            border: 4px solid #FFD700;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal h2 {
            font-size: 28px;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .btn {
            background: linear-gradient(135deg, #48BB78 0%, #38A169 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 900;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            margin: 5px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .secret-capsule {
            width: 120px;
            height: 70px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 35px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: #c53030;
            font-size: 18px;
            animation: float 2s infinite ease-in-out;
            box-shadow: 0 0 30px rgba(255,215,0,0.6);
            cursor: pointer;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @media (max-width: 480px) {
            .level-btn {
                width: 60px;
                height: 60px;
                font-size: 18px;
            }
            .game-title {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>

    <!-- Level Select Screen -->
    <div id="levelSelectScreen" class="screen active level-select-screen">
        <div class="game-header">
            <h1 class="game-title">üçÑ ÿ≥Ÿàÿ®ÿ± ŸÖÿßÿ±ŸäŸà üçÑ</h1>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="totalProgress" style="width: 2%"></div>
                </div>
                <div class="progress-text">ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ <span id="currentLevelNum">1</span> ŸÖŸÜ 50</div>
            </div>
        </div>

        <div class="path-container">
            <!-- SVG Path for the snake-like road -->
            <svg class="path-line" viewBox="0 0 100 3000" preserveAspectRatio="none">
                <defs>
                    <linearGradient id="pathGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#4a5568;stop-opacity:1" />
                        <stop offset="50%" style="stop-color:#2b6cb0;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#4a5568;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <path d="M 50 0 Q 80 150, 20 300 Q 80 450, 20 600 Q 80 750, 20 900 Q 80 1050, 20 1200 Q 80 1350, 20 1500 Q 80 1650, 20 1800 Q 80 1950, 20 2100 Q 80 2250, 20 2400 Q 80 2550, 20 2700 Q 80 2850, 50 3000" />
            </svg>

            <div class="levels-wrapper" id="levelsContainer">
                <!-- Levels will be generated here -->
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen game-screen">
        <div class="game-container">
            <div class="game-ui-header">
                <div style="display: flex; gap: 15px;">
                    <div class="stat">‚ù§Ô∏è <span id="lives">3</span></div>
                    <div class="stat">ü™ô <span id="coins">0</span></div>
                    <div class="stat">‚≠ê <span id="score">0</span></div>
                </div>
                <div class="level-tag" id="gameLevelTag">ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 1</div>
                <button class="back-btn" onclick="backToMenu()">ÿÆÿ±Ÿàÿ¨</button>
            </div>
            
            <canvas id="gameCanvas" width="800" height="400"></canvas>
            
            <div class="controls">
                <div class="joystick-area" id="joystick">
                    <div class="joystick-knob" id="joystickKnob"></div>
                </div>
                <div class="jump-btn" id="jumpBtn">ŸÇŸÅÿ≤</div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="secretModal" class="modal">
        <div class="modal-content">
            <h2>üöá ÿßŸÑŸÖŸáŸÖÿ© ÿßŸÑÿ≥ÿ±Ÿäÿ©!</h2>
            <p>ÿ¨ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÖŸÑÿßÿ™ ŸÑŸÅÿ™ÿ≠ ÿßŸÑÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ≥ÿ±Ÿä!</p>
            <div class="progress-bar" style="margin: 15px 0;">
                <div class="progress-fill" id="secretProgress" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div id="capsuleModal" class="modal">
        <div class="modal-content">
            <h2>üéâ Ÿàÿ¨ÿØÿ™ ÿßŸÑŸÉÿ®ÿ≥ŸàŸÑÿ©!</h2>
            <div class="secret-capsule">ÿ®ÿ±ŸÖÿ¨ŸÜŸä</div>
            <p>ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿßŸÑŸä</p>
            <button class="btn" onclick="nextLevel()">ÿßŸÑÿ™ÿßŸÑŸä</button>
        </div>
    </div>

    <div id="gameOverModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #e53e3e;">ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÑÿπÿ®ÿ©</h2>
            <p>ÿßŸÑŸÜŸÇÿßÿ∑: <span id="finalScore">0</span></p>
            <button class="btn" onclick="retryLevel()">ÿ•ÿπÿßÿØÿ©</button>
            <button class="btn" onclick="backToMenu()">ÿÆÿ±Ÿàÿ¨</button>
        </div>
    </div>

    <div id="levelCompleteModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #48bb78;">üéâ ŸÖÿ®ÿ±ŸàŸÉ!</h2>
            <p>ÿ£ŸÉŸÖŸÑÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿ®ŸÜÿ¨ÿßÿ≠!</p>
            <button class="btn" onclick="startSecret()">ÿßŸÑŸÖŸáŸÖÿ© ÿßŸÑÿ≥ÿ±Ÿäÿ©</button>
        </div>
    </div>

    <script>
        // Game State
        let currentLevel = 1;
        let maxUnlocked = 1;
        let gameRunning = false;
        let inSecret = false;
        let coins = 0;
        let lives = 3;
        let score = 0;
        let levelCoins = [];
        let enemies = [];
        let platforms = [];
        let particles = [];
        let player = {
            x: 50, y: 200, width: 30, height: 40,
            vx: 0, vy: 0, speed: 5, jump: 12, gravity: 0.5,
            grounded: false, facingRight: true, big: false
        };
        let cameraX = 0;

        // Generate Level Select
        function initLevelSelect() {
            const container = document.getElementById('levelsContainer');
            container.innerHTML = '';
            
            for (let i = 50; i >= 1; i--) {
                const row = document.createElement('div');
                row.className = 'level-row';
                
                const btn = document.createElement('div');
                btn.className = 'level-btn';
                
                if (i === currentLevel) {
                    btn.className += ' current';
                    btn.innerHTML = `
                        <div class="mario-icon">üßë</div>
                        <span>${i}</span>
                    `;
                    btn.onclick = () => startLevel(i);
                } else if (i < currentLevel) {
                    btn.className += ' completed';
                    // Random stars 1-3
                    const stars = Math.floor(Math.random() * 3) + 1;
                    let starsHtml = '<div class="stars">';
                    for(let s=0; s<3; s++) {
                        starsHtml += `<span class="star" style="opacity: ${s<stars?1:0.3}">‚≠ê</span>`;
                    }
                    starsHtml += '</div>';
                    
                    btn.innerHTML = `${starsHtml}<span>${i}</span>`;
                    
                    // FREE badge on some levels
                    if (i % 10 === 0) {
                        btn.innerHTML += '<div class="free-badge">FREE</div>';
                    }
                    
                    btn.onclick = () => startLevel(i);
                } else {
                    btn.className += ' locked';
                    btn.innerHTML = '<span class="lock-icon">üîí</span>';
                }
                
                row.appendChild(btn);
                container.appendChild(row);
            }
            
            document.getElementById('totalProgress').style.width = (currentLevel/50*100) + '%';
            document.getElementById('currentLevelNum').textContent = currentLevel;
        }

        function startLevel(level) {
            if (level > maxUnlocked) return;
            currentLevel = level;
            inSecret = false;
            coins = 0;
            lives = 3;
            score = 0;
            player.big = false;
            
            generateLevelData(level);
            
            document.getElementById('levelSelectScreen').classList.remove('active');
            document.getElementById('gameScreen').classList.add('active');
            document.getElementById('gameLevelTag').textContent = `ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ${level}`;
            
            gameRunning = true;
            gameLoop();
        }

        function generateLevelData(level) {
            platforms = [{x: 0, y: 350, width: 2000 + (level*100), height: 50}];
            levelCoins = [];
            enemies = [];
            
            // Add platforms and coins
            for (let i = 0; i < 5 + level; i++) {
                const x = 200 + i * 150;
                const y = 250 - (i % 3) * 50;
                platforms.push({x, y, width: 80, height: 20});
                
                // Coins
                levelCoins.push(
                    {x: x + 20, y: y - 40, collected: false},
                    {x: x + 40, y: y - 40, collected: false},
                    {x: x + 60, y: y - 40, collected: false}
                );
                
                // Enemies
                if (i % 2 === 0) {
                    enemies.push({
                        x: x + 40, y: 320, width: 30, height: 30,
                        vx: 2 + (level * 0.2), start: x, end: x + 80, alive: true
                    });
                }
            }
        }

        // Controls
        let joystickActive = false;
        let joystickX = 0;
        const joystick = document.getElementById('joystick');
        const knob = document.getElementById('joystickKnob');

        joystick.addEventListener('touchstart', handleTouchStart, {passive: false});
        joystick.addEventListener('touchmove', handleTouchMove, {passive: false});
        joystick.addEventListener('touchend', handleTouchEnd, {passive: false});

        function handleTouchStart(e) {
            e.preventDefault();
            joystickActive = true;
            updateJoystick(e.touches[0]);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (joystickActive) updateJoystick(e.touches[0]);
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            joystickActive = false;
            joystickX = 0;
            knob.style.transform = `translate(-50%, -50%)`;
        }

        function updateJoystick(touch) {
            const rect = joystick.getBoundingClientRect();
            const center = rect.left + rect.width / 2;
            const max = 30;
            let dx = touch.clientX - center;
            if (Math.abs(dx) > max) dx = max * Math.sign(dx);
            joystickX = dx / max;
            knob.style.transform = `translate(calc(-50% + ${dx}px), -50%)`;
        }

        document.getElementById('jumpBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (player.grounded) {
                player.vy = -player.jump;
                player.grounded = false;
            }
        });

        // Game Loop
        function update() {
            if (!gameRunning) return;
            
            // Movement
            if (joystickActive) {
                player.vx = joystickX * player.speed;
                if (joystickX > 0) player.facingRight = true;
                if (joystickX < 0) player.facingRight = false;
            } else {
                player.vx *= 0.8;
            }
            
            player.vy += player.gravity;
            player.x += player.vx;
            player.y += player.vy;
            
            // Platform collision
            player.grounded = false;
            platforms.forEach(plat => {
                if (player.x < plat.x + plat.width &&
                    player.x + player.width > plat.x &&
                    player.y + player.height > plat.y &&
                    player.y + player.height < plat.y + plat.height + 20 &&
                    player.vy >= 0) {
                    player.grounded = true;
                    player.vy = 0;
                    player.y = plat.y - player.height;
                }
            });
            
            // Fall
            if (player.y > 400) {
                lives--;
                if (lives <= 0) {
                    gameRunning = false;
                    document.getElementById('finalScore').textContent = score;
                    document.getElementById('gameOverModal').classList.add('active');
                } else {
                    player.x = 50;
                    player.y = 200;
                }
            }
            
            // Camera
            cameraX = player.x - 200;
            if (cameraX < 0) cameraX = 0;
            
            // Coins
            levelCoins.forEach(coin => {
                if (!coin.collected) {
                    if (Math.abs(player.x + 15 - coin.x) < 20 &&
                        Math.abs(player.y + 20 - coin.y) < 20) {
                        coin.collected = true;
                        coins++;
                        score += 100;
                        updateUI();
                        
                        if (levelCoins.every(c => c.collected)) {
                            setTimeout(() => {
                                gameRunning = false;
                                document.getElementById('levelCompleteModal').classList.add('active');
                            }, 500);
                        }
                    }
                }
            });
            
            // Enemies
            enemies.forEach(enemy => {
                if (enemy.alive) {
                    enemy.x += enemy.vx;
                    if (enemy.x <= enemy.start || enemy.x >= enemy.end) enemy.vx *= -1;
                    
                    if (player.x < enemy.x + enemy.width &&
                        player.x + player.width > enemy.x &&
                        player.y < enemy.y + enemy.height &&
                        player.y + player.height > enemy.y) {
                        if (player.vy > 0 && player.y + player.height - player.vy < enemy.y) {
                            enemy.alive = false;
                            player.vy = -8;
                            score += 200;
                        } else {
                            lives--;
                            if (lives <= 0) {
                                gameRunning = false;
                                document.getElementById('finalScore').textContent = score;
                                document.getElementById('gameOverModal').classList.add('active');
                            }
                        }
                    }
                }
            });
        }

        function draw() {
            const ctx = document.getElementById('gameCanvas').getContext('2d');
            const canvas = document.getElementById('gameCanvas');
            
            // Background
            const grad = ctx.createLinearGradient(0, 0, 0, 400);
            grad.addColorStop(0, '#87CEEB');
            grad.addColorStop(0.5, '#E0F6FF');
            grad.addColorStop(0.5, '#90EE90');
            grad.addColorStop(1, '#228B22');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, 800, 400);
            
            if (inSecret) {
                ctx.fillStyle = 'rgba(26,26,46,0.8)';
                ctx.fillRect(0, 0, 800, 400);
            }
            
            ctx.save();
            ctx.translate(-cameraX, 0);
            
            // Platforms
            platforms.forEach(p => {
                ctx.fillStyle = inSecret ? '#4a4a4a' : '#8B4513';
                ctx.fillRect(p.x, p.y, p.width, p.height);
                if (!inSecret && p.y < 300) {
                    ctx.fillStyle = '#228B22';
                    ctx.fillRect(p.x, p.y, p.width, 15);
                }
            });
            
            // Coins
            const float = Math.sin(Date.now()/200) * 5;
            levelCoins.forEach(c => {
                if (!c.collected) {
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(c.x, c.y + float, 12, 0, Math.PI*2);
                    ctx.fill();
                    ctx.strokeStyle = '#FF8C00';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            });
            
            // Enemies
            enemies.forEach(e => {
                if (e.alive) {
                    ctx.fillStyle = '#8B4513';
                    ctx.beginPath();
                    ctx.arc(e.x + 15, e.y + 15, 15, 0, Math.PI*2);
                    ctx.fill();
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(e.x + 10, e.y + 10, 4, 0, Math.PI*2);
                    ctx.arc(e.x + 20, e.y + 10, 4, 0, Math.PI*2);
                    ctx.fill();
                }
            });
            
            // Player
            ctx.fillStyle = player.big ? '#FF0000' : '#FF4444';
            ctx.fillRect(player.x, player.y, player.big?35:30, player.big?40:30);
            ctx.fillStyle = '#0000FF';
            ctx.fillRect(player.x, player.y + (player.big?30:25), player.big?35:30, player.big?20:15);
            
            ctx.restore();
        }

        function gameLoop() {
            if (gameRunning) {
                update();
                draw();
                requestAnimationFrame(gameLoop);
            }
        }

        function updateUI() {
            document.getElementById('lives').textContent = lives;
            document.getElementById('coins').textContent = coins;
            document.getElementById('score').textContent = score;
        }

        function backToMenu() {
            gameRunning = false;
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('levelSelectScreen').classList.add('active');
            initLevelSelect();
        }

        function retryLevel() {
            document.getElementById('gameOverModal').classList.remove('active');
            startLevel(currentLevel);
        }

        function startSecret() {
            document.getElementById('levelCompleteModal').classList.remove('active');
            inSecret = true;
            platforms = [{x: 0, y: 350, width: 1500, height: 50}];
            for (let i = 0; i < 8; i++) {
                platforms.push({
                    x: 150 + i * 170,
                    y: 250 - (i % 4) * 40,
                    width: 100, height: 20
                });
            }
            player.x = 50;
            player.y = 200;
            gameRunning = true;
            gameLoop();
            
            // Check for capsule
            setInterval(() => {
                if (player.x > 1300 && inSecret) {
                    gameRunning = false;
                    document.getElementById('capsuleModal').classList.add('active');
                }
            }, 1000);
        }

        function nextLevel() {
            document.getElementById('capsuleModal').classList.remove('active');
            if (currentLevel < 50) {
                maxUnlocked = Math.max(maxUnlocked, currentLevel + 1);
                currentLevel++;
                backToMenu();
            }
        }

        // Init
        initLevelSelect();
    </script>
</body>
</html>