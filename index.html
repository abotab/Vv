<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>الهروب من الشرطة - Police Chase 3D</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            touch-action: none;
        }

        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
            cursor: grab;
        }

        #gameCanvas:active {
            cursor: grabbing;
        }

        /* شاشة البداية */
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .logo-building {
            width: 300px;
            height: 400px;
            position: relative;
            margin-bottom: 40px;
            perspective: 1000px;
        }

        .building-3d {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            animation: rotateBuilding 6s infinite ease-in-out;
        }

        @keyframes rotateBuilding {
            0%, 100% { transform: rotateY(-15deg) rotateX(5deg); }
            50% { transform: rotateY(15deg) rotateX(-5deg); }
        }

        .building-face {
            position: absolute;
            background: linear-gradient(145deg, #1e3c72, #2a5298);
            border: 3px solid #4a90e2;
            box-shadow: 0 0 40px rgba(74, 144, 226, 0.6),
                        inset 0 0 60px rgba(74, 144, 226, 0.3);
        }

        .building-front {
            width: 200px;
            height: 350px;
            left: 50px;
            top: 25px;
            transform: translateZ(100px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(145deg, #1a2980, #26d0ce);
        }

        .building-side {
            width: 200px;
            height: 350px;
            left: 50px;
            top: 25px;
            transform: rotateY(90deg) translateZ(100px);
            background: linear-gradient(145deg, #134e5e, #71b280);
        }

        .building-text {
            font-size: 48px;
            font-weight: 900;
            background: linear-gradient(45deg, #fff, #ffd700, #fff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            letter-spacing: 3px;
            animation: glowText 2s ease-in-out infinite;
            text-align: center;
            line-height: 1.2;
        }

        @keyframes glowText {
            0%, 100% { filter: brightness(1) drop-shadow(0 0 10px gold); }
            50% { filter: brightness(1.3) drop-shadow(0 0 20px gold); }
        }

        .windows {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 20px;
            width: 100%;
        }

        .window {
            width: 30px;
            height: 40px;
            background: linear-gradient(180deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            animation: windowBlink 3s infinite ease-in-out;
            animation-delay: calc(var(--i) * 0.2s);
        }

        @keyframes windowBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .game-title {
            font-size: 56px;
            font-weight: 900;
            background: linear-gradient(90deg, #ff6b6b, #ee5a6f, #c44569);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 20px rgba(255, 107, 107, 0.4);
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        .start-button {
            padding: 20px 60px;
            font-size: 28px;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            letter-spacing: 1px;
        }

        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        .start-button:active {
            transform: translateY(0);
        }

        /* عناصر التحكم */
        #controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 40px;
            align-items: flex-end;
            z-index: 100;
            pointer-events: none;
        }

        .joystick-container {
            position: relative;
            width: 160px;
            height: 160px;
            pointer-events: all;
        }

        .joystick-base {
            width: 160px;
            height: 160px;
            background: radial-gradient(circle, rgba(0,0,0,0.4), rgba(0,0,0,0.7));
            border-radius: 50%;
            position: relative;
            border: 4px solid rgba(255,255,255,0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3),
                        inset 0 4px 16px rgba(255,255,255,0.1);
        }

        .joystick-stick {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid rgba(255,255,255,0.5);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5),
                        inset 0 2px 8px rgba(255,255,255,0.3);
            cursor: grab;
            transition: all 0.1s ease;
        }

        .joystick-stick:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(0.95);
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            pointer-events: all;
        }

        .control-button {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 4px solid rgba(255,255,255,0.4);
            font-size: 18px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            box-shadow: 0 6px 24px rgba(0,0,0,0.3),
                        inset 0 2px 8px rgba(255,255,255,0.2);
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        #jumpBtn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        #boostBtn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .control-button:active {
            transform: scale(0.9);
            box-shadow: 0 3px 12px rgba(0,0,0,0.4),
                        inset 0 2px 8px rgba(0,0,0,0.2);
        }

        /* معلومات اللعبة */
        #gameInfo {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 100;
            pointer-events: none;
        }

        .info-box {
            background: rgba(0,0,0,0.6);
            padding: 15px 25px;
            border-radius: 15px;
            color: white;
            font-size: 20px;
            font-weight: 700;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }

        .speed-value {
            color: #4facfe;
            font-size: 28px;
        }

        .distance-value {
            color: #f5576c;
            font-size: 28px;
        }

        @media (max-width: 768px) {
            .logo-building {
                width: 250px;
                height: 330px;
            }

            .building-front {
                width: 160px;
                height: 280px;
            }

            .building-text {
                font-size: 36px;
            }

            .game-title {
                font-size: 42px;
            }

            .start-button {
                padding: 18px 50px;
                font-size: 24px;
            }

            .joystick-container {
                width: 140px;
                height: 140px;
            }

            .joystick-base {
                width: 140px;
                height: 140px;
            }

            .joystick-stick {
                width: 70px;
                height: 70px;
            }

            .control-button {
                width: 80px;
                height: 80px;
                font-size: 16px;
            }
        }

        /* شاشة نهاية اللعبة */
        #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(15, 12, 41, 0.95), rgba(48, 43, 99, 0.95));
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .game-over-content {
            text-align: center;
            padding: 40px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 30px;
            border: 3px solid rgba(255, 107, 107, 0.5);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .game-over-title {
            font-size: 56px;
            font-weight: 900;
            color: #ff6b6b;
            margin-bottom: 30px;
            text-shadow: 0 4px 20px rgba(255, 107, 107, 0.6);
        }

        .game-over-stats {
            margin: 30px 0;
        }

        .stat-item {
            font-size: 28px;
            color: white;
            margin: 15px 0;
            font-weight: 600;
        }

        .stat-value {
            color: #4facfe;
            font-size: 36px;
            font-weight: 900;
        }

        .restart-button {
            padding: 18px 50px;
            font-size: 26px;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .restart-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        /* تحسين عمارة برمجني بألوان علم العراق */
        .iraq-building {
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, 
                #ce1126 0%, #ce1126 33%,
                #ffffff 33%, #ffffff 66%,
                #000000 66%, #000000 100%);
            position: relative;
            overflow: hidden;
        }

        .iraq-star-top {
            position: absolute;
            top: 16%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #007a3d;
            font-size: 60px;
            text-shadow: 0 0 20px rgba(0, 122, 61, 0.8);
        }

        .iraq-star-bottom {
            position: absolute;
            bottom: 16%;
            left: 50%;
            transform: translate(-50%, 50%);
            color: #007a3d;
            font-size: 60px;
            text-shadow: 0 0 20px rgba(0, 122, 61, 0.8);
        }

        .building-logo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: 900;
            color: #000000;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3),
                        0 0 20px rgba(0, 122, 61, 0.4);
            letter-spacing: 2px;
            z-index: 10;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <!-- شاشة البداية -->
    <div id="startScreen">
        <div class="logo-building">
            <div class="building-3d">
                <div class="building-face building-front">
                    <div class="iraq-building">
                        <div class="iraq-star-top">★ ★ ★</div>
                        <div class="building-logo">برمجني</div>
                        <div class="iraq-star-bottom">★ ★ ★</div>
                    </div>
                </div>
                <div class="building-face building-side"></div>
            </div>
        </div>
        <h1 class="game-title">الهروب من الشرطة</h1>
        <button class="start-button" onclick="startGame()">ابدأ اللعبة</button>
    </div>

    <!-- شاشة نهاية اللعبة -->
    <div id="gameOverScreen">
        <div class="game-over-content">
            <div class="game-over-title">تم القبض عليك!</div>
            <div class="game-over-stats">
                <div class="stat-item">
                    نقاطك: <span class="stat-value" id="finalScore">0</span>
                </div>
                <div class="stat-item">
                    المسافة: <span class="stat-value" id="finalDistance">0</span> م
                </div>
                <div class="stat-item">
                    الوقت: <span class="stat-value" id="finalTime">0</span> ثانية
                </div>
            </div>
            <button class="restart-button" onclick="restartGame()">ابدأ لعبة جديدة</button>
        </div>
    </div>

    <!-- معلومات اللعبة -->
    <div id="gameInfo" style="display: none;">
        <div class="info-box">
            السرعة: <span class="speed-value" id="speedDisplay">0</span> كم/س
        </div>
        <div class="info-box">
            المسافة: <span class="distance-value" id="distanceDisplay">0</span> م
        </div>
    </div>

    <!-- عناصر التحكم -->
    <div id="controls" style="display: none;">
        <div class="joystick-container">
            <div class="joystick-base">
                <div class="joystick-stick" id="joystick"></div>
            </div>
        </div>
        <div class="action-buttons">
            <button class="control-button" id="jumpBtn">قفز</button>
            <button class="control-button" id="boostBtn">تسريع</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, player, policeCars = [];
        let buildings = [], obstacles = [];
        let moveForward = 0, moveRight = 0;
        let playerVelocity = { x: 0, y: 0, z: 0 };
        let isJumping = false, isBoosting = false;
        let speed = 0, distance = 0;
        let joystickActive = false;
        let cameraAngleX = 0, cameraAngleY = Math.PI / 6;
        let isDragging = false, previousMouseX = 0, previousMouseY = 0;
        let gameStartTime = 0;
        let isGameOver = false;

        const GRAVITY = -0.8;
        const JUMP_FORCE = 18;
        const MOVE_SPEED = 1.2;
        const BOOST_MULTIPLIER = 2.8;
        const CITY_SIZE = 4000;
        const BUILDING_COUNT = 150;

        // الموسيقى - موسيقى خلفية بسيطة
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let musicPlaying = false;

        function playBackgroundMusic() {
            if (musicPlaying) return;
            musicPlaying = true;
            
            const notes = [
                { freq: 261.63, duration: 0.5 }, // C
                { freq: 293.66, duration: 0.5 }, // D
                { freq: 329.63, duration: 0.5 }, // E
                { freq: 349.23, duration: 0.5 }, // F
                { freq: 392.00, duration: 1.0 }, // G
                { freq: 349.23, duration: 0.5 }, // F
                { freq: 329.63, duration: 0.5 }, // E
                { freq: 293.66, duration: 1.0 }, // D
            ];

            let currentTime = audioContext.currentTime;

            function playMusicLoop() {
                notes.forEach(note => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = note.freq;
                    oscillator.type = 'sine';

                    gainNode.gain.setValueAtTime(0.1, currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, currentTime + note.duration);

                    oscillator.start(currentTime);
                    oscillator.stop(currentTime + note.duration);

                    currentTime += note.duration;
                });

                setTimeout(playMusicLoop, notes.reduce((sum, n) => sum + n.duration, 0) * 1000);
            }

            playMusicLoop();
        }

        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameInfo').style.display = 'flex';
            document.getElementById('controls').style.display = 'flex';
            
            // طلب صلاحيات الدوران التلقائي للجوال
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        }
                    })
                    .catch(console.error);
            }
            
            // طلب تشغيل كامل الشاشة (fullscreen)
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(() => {});
            } else if (document.documentElement.webkitRequestFullscreen) {
                document.documentElement.webkitRequestFullscreen().catch(() => {});
            }
            
            // قفل الشاشة في وضع أفقي على الجوال
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(() => {});
            }
            
            // تشغيل الموسيقى
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            playBackgroundMusic();
            
            // بدء اللعبة
            gameStartTime = Date.now();
            isGameOver = false;
            distance = 0;
            
            init();
            animate();
        }

        function handleOrientation(event) {
            // يمكن استخدام بيانات الدوران للتحكم بالكاميرا
            // const alpha = event.alpha; // Z-axis rotation
            // const beta = event.beta;   // X-axis rotation
            // const gamma = event.gamma; // Y-axis rotation
        }

        function restartGame() {
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('gameInfo').style.display = 'flex';
            document.getElementById('controls').style.display = 'flex';
            
            // إعادة تعيين المتغيرات
            gameStartTime = Date.now();
            isGameOver = false;
            distance = 0;
            speed = 0;
            
            // إعادة موضع اللاعب
            player.position.set(0, 10, 0);
            playerVelocity = { x: 0, y: 0, z: 0 };
            
            // إعادة موضع الشرطة
            policeCars.forEach(car => {
                car.mesh.position.set(
                    (Math.random() - 0.5) * 200,
                    2,
                    (Math.random() - 0.5) * 200 - 100
                );
            });
        }

        function gameOver() {
            if (isGameOver) return;
            isGameOver = true;
            
            const playTime = Math.floor((Date.now() - gameStartTime) / 1000);
            const finalScore = Math.floor(distance * 10);
            
            document.getElementById('finalScore').textContent = finalScore;
            document.getElementById('finalDistance').textContent = Math.floor(distance);
            document.getElementById('finalTime').textContent = playTime;
            
            document.getElementById('gameOverScreen').style.display = 'flex';
            document.getElementById('gameInfo').style.display = 'none';
            document.getElementById('controls').style.display = 'none';
        }

        function init() {
            // المشهد
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 50, 1500);

            // الكاميرا
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2500);
            camera.position.set(0, 25, -35);

            // المُصيِّر
            const canvas = document.getElementById('gameCanvas');
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // الإضاءة
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);

            const sunLight = new THREE.DirectionalLight(0xffffff, 0.9);
            sunLight.position.set(200, 300, 200);
            sunLight.castShadow = true;
            sunLight.shadow.camera.left = -400;
            sunLight.shadow.camera.right = 400;
            sunLight.shadow.camera.top = 400;
            sunLight.shadow.camera.bottom = -400;
            sunLight.shadow.camera.far = 1000;
            sunLight.shadow.mapSize.width = 1024;
            sunLight.shadow.mapSize.height = 1024;
            scene.add(sunLight);

            // الأرضية
            const groundGeometry = new THREE.PlaneGeometry(CITY_SIZE, CITY_SIZE, 10, 10);
            const groundMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x2d2d2d,
                roughness: 0.8,
                metalness: 0.1
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = 0;
            ground.receiveShadow = true;
            scene.add(ground);

            // الشوارع
            createStreets();

            // اللاعب (كبسولة ملونة)
            const capsuleBody = new THREE.CylinderGeometry(3, 3, 8, 16);
            const capsuleTop = new THREE.SphereGeometry(3, 16, 16);
            const capsuleBottom = new THREE.SphereGeometry(3, 16, 16);
            
            const capsuleMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xff1493,
                emissive: 0xff1493,
                emissiveIntensity: 0.4,
                roughness: 0.2,
                metalness: 0.8
            });
            
            player = new THREE.Group();
            
            const body = new THREE.Mesh(capsuleBody, capsuleMaterial);
            const top = new THREE.Mesh(capsuleTop, capsuleMaterial);
            const bottom = new THREE.Mesh(capsuleBottom, capsuleMaterial);
            
            top.position.y = 4;
            bottom.position.y = -4;
            
            player.add(body);
            player.add(top);
            player.add(bottom);
            
            player.position.set(0, 10, 0);
            player.castShadow = true;
            player.receiveShadow = true;
            scene.add(player);

            // إضافة خطوط للكبسولة
            const edgesGeometry = new THREE.EdgesGeometry(capsuleBody);
            const edgesMaterial = new THREE.LineBasicMaterial({ color: 0x00ffff, linewidth: 2 });
            const edges = new THREE.LineSegments(edgesGeometry, edgesMaterial);
            body.add(edges);

            // المدينة
            createCity();
            
            // عمارة برمجني الكبيرة
            createBarmajniBuilding();

            // سيارات الشرطة
            createPoliceCars(4);

            // أحداث التحكم
            setupControls();
            setupMouseControls();
            
            console.log('Game initialized successfully');
        }

        function createStreets() {
            const streetMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x404040,
                roughness: 0.9
            });
            
            const streetWidth = 20;
            const streetSpacing = 120;

            for (let i = -20; i <= 20; i++) {
                // شوارع أفقية
                const streetH = new THREE.Mesh(
                    new THREE.PlaneGeometry(CITY_SIZE, streetWidth),
                    streetMaterial
                );
                streetH.rotation.x = -Math.PI / 2;
                streetH.position.set(0, 0.1, i * streetSpacing);
                streetH.receiveShadow = true;
                scene.add(streetH);

                // شوارع عمودية
                const streetV = new THREE.Mesh(
                    new THREE.PlaneGeometry(streetWidth, CITY_SIZE),
                    streetMaterial
                );
                streetV.rotation.x = -Math.PI / 2;
                streetV.position.set(i * streetSpacing, 0.1, 0);
                streetV.receiveShadow = true;
                scene.add(streetV);

                // خطوط الشارع
                if (i % 2 === 0) {
                    const lineMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00 });
                    for (let j = -40; j <= 40; j++) {
                        const line = new THREE.Mesh(
                            new THREE.BoxGeometry(8, 0.2, 1),
                            lineMaterial
                        );
                        line.position.set(j * 50, 0.2, i * streetSpacing);
                        scene.add(line);
                    }
                }
            }
        }

        function createCity() {
            // ألوان جميلة ومتناسقة
            const beautifulColors = [
                { h: 0.95, s: 0.7, l: 0.6 },  // وردي
                { h: 0.55, s: 0.6, l: 0.5 },  // أزرق سماوي
                { h: 0.15, s: 0.7, l: 0.6 },  // برتقالي
                { h: 0.75, s: 0.6, l: 0.55 }, // بنفسجي
                { h: 0.35, s: 0.6, l: 0.5 },  // أخضر
                { h: 0.85, s: 0.7, l: 0.6 },  // وردي فاتح
                { h: 0.50, s: 0.7, l: 0.55 }, // تركواز
            ];

            for (let i = 0; i < BUILDING_COUNT; i++) {
                const width = Math.random() * 35 + 25;
                const height = Math.random() * 180 + 60;
                const depth = Math.random() * 35 + 25;

                const buildingGeometry = new THREE.BoxGeometry(width, height, depth);
                
                // اختيار لون جميل عشوائي
                const colorChoice = beautifulColors[Math.floor(Math.random() * beautifulColors.length)];
                const buildingMaterial = new THREE.MeshStandardMaterial({ 
                    color: new THREE.Color().setHSL(colorChoice.h, colorChoice.s, colorChoice.l),
                    roughness: 0.6,
                    metalness: 0.4,
                    emissive: new THREE.Color().setHSL(colorChoice.h, colorChoice.s * 0.3, 0.1),
                    emissiveIntensity: 0.2
                });

                const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
                
                let x, z;
                do {
                    x = (Math.random() - 0.5) * CITY_SIZE * 0.85;
                    z = (Math.random() - 0.5) * CITY_SIZE * 0.85;
                } while ((Math.abs(x) < 50 && Math.abs(z) < 50) || (Math.abs(x) < 80 && Math.abs(z - 150) < 80));

                building.position.set(x, height / 2, z);
                building.castShadow = true;
                building.receiveShadow = true;
                
                buildings.push(building);
                obstacles.push(building);
                scene.add(building);

                // نوافذ مضيئة بألوان دافئة
                const windowColors = [0xffff00, 0xffaa00, 0xffffff, 0x333333];
                const windowColor = windowColors[Math.floor(Math.random() * windowColors.length)];
                const windowMaterial = new THREE.MeshBasicMaterial({ color: windowColor });
                
                const windowsPerFloor = Math.floor(width / 6);
                const floors = Math.floor(height / 10);

                for (let f = 0; f < floors; f++) {
                    for (let w = 0; w < windowsPerFloor; w++) {
                        if (Math.random() > 0.2) { // 80% نوافذ مضيئة
                            const windowGeometry = new THREE.BoxGeometry(2.5, 4, 0.5);
                            const windowMesh = new THREE.Mesh(windowGeometry, windowMaterial);
                            windowMesh.position.set(
                                -width/2 + (w + 0.5) * (width / windowsPerFloor),
                                -height/2 + (f + 0.5) * (height / floors),
                                depth/2 + 0.3
                            );
                            building.add(windowMesh);
                        }
                    }
                }
            }
        }

        function createBarmajniBuilding() {
            const width = 60;
            const height = 250;
            const depth = 60;

            const buildingGroup = new THREE.Group();
            
            // الجزء الأحمر (أعلى)
            const redPart = new THREE.Mesh(
                new THREE.BoxGeometry(width, height / 3, depth),
                new THREE.MeshStandardMaterial({ color: 0xce1126 })
            );
            redPart.position.y = height / 3;
            buildingGroup.add(redPart);

            // الجزء الأبيض (وسط)
            const whitePart = new THREE.Mesh(
                new THREE.BoxGeometry(width, height / 3, depth),
                new THREE.MeshStandardMaterial({ color: 0xffffff })
            );
            whitePart.position.y = 0;
            buildingGroup.add(whitePart);

            // الجزء الأسود (أسفل)
            const blackPart = new THREE.Mesh(
                new THREE.BoxGeometry(width, height / 3, depth),
                new THREE.MeshStandardMaterial({ color: 0x000000 })
            );
            blackPart.position.y = -height / 3;
            buildingGroup.add(blackPart);

            // النجوم الخضراء
            const starGeometry = new THREE.SphereGeometry(3, 8, 8);
            const starMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x007a3d,
                emissive: 0x007a3d,
                emissiveIntensity: 0.8
            });

            // نجوم الجزء الأحمر
            for (let i = -1; i <= 1; i++) {
                const star = new THREE.Mesh(starGeometry, starMaterial);
                star.position.set(i * 15, height / 3, depth / 2 + 1);
                buildingGroup.add(star);
            }

            // نجوم الجزء الأسود
            for (let i = -1; i <= 1; i++) {
                const star = new THREE.Mesh(starGeometry, starMaterial);
                star.position.set(i * 15, -height / 3, depth / 2 + 1);
                buildingGroup.add(star);
            }

            // نص "برمجني"
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 80px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('برمجني', 256, 128);

            const textTexture = new THREE.CanvasTexture(canvas);
            const textMaterial = new THREE.MeshBasicMaterial({ 
                map: textTexture, 
                transparent: true 
            });
            const textPlane = new THREE.Mesh(
                new THREE.PlaneGeometry(40, 20),
                textMaterial
            );
            textPlane.position.set(0, 0, depth / 2 + 0.5);
            buildingGroup.add(textPlane);

            buildingGroup.position.set(0, height / 2, 150);
            buildingGroup.castShadow = true;
            buildingGroup.receiveShadow = true;

            obstacles.push(buildingGroup);
            scene.add(buildingGroup);
        }

        function createPoliceCars(count) {
            for (let i = 0; i < count; i++) {
                const carBody = new THREE.Mesh(
                    new THREE.BoxGeometry(6, 4, 12),
                    new THREE.MeshStandardMaterial({ 
                        color: 0x0000ff,
                        emissive: 0x0000ff,
                        emissiveIntensity: 0.2
                    })
                );
                
                const carTop = new THREE.Mesh(
                    new THREE.BoxGeometry(5, 2, 6),
                    new THREE.MeshStandardMaterial({ color: 0x4444ff })
                );
                carTop.position.y = 3;
                carBody.add(carTop);

                const lightGeometry = new THREE.BoxGeometry(2, 0.5, 2);
                const redLight = new THREE.Mesh(lightGeometry, new THREE.MeshBasicMaterial({ color: 0xff0000 }));
                const blueLight = new THREE.Mesh(lightGeometry, new THREE.MeshBasicMaterial({ color: 0x0000ff }));
                redLight.position.set(-1, 4, 0);
                blueLight.position.set(1, 4, 0);
                carBody.add(redLight);
                carBody.add(blueLight);

                carBody.position.set(
                    (Math.random() - 0.5) * 200,
                    2,
                    (Math.random() - 0.5) * 200 - 100
                );
                carBody.castShadow = true;
                
                policeCars.push({
                    mesh: carBody,
                    velocity: { x: 0, z: 0 }
                });
                
                scene.add(carBody);
            }
        }

        function setupControls() {
            const joystick = document.getElementById('joystick');
            const joystickBase = joystick.parentElement;
            const baseRect = joystickBase.getBoundingClientRect();
            const maxDistance = 40;

            function handleJoystickMove(clientX, clientY) {
                const deltaX = clientX - (baseRect.left + baseRect.width / 2);
                const deltaY = clientY - (baseRect.top + baseRect.height / 2);
                
                const distance = Math.min(Math.sqrt(deltaX * deltaX + deltaY * deltaY), maxDistance);
                const angle = Math.atan2(deltaY, deltaX);
                
                const x = Math.cos(angle) * distance;
                const y = Math.sin(angle) * distance;
                
                joystick.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
                
                moveRight = x / maxDistance;
                moveForward = -y / maxDistance;
            }

            function resetJoystick() {
                joystick.style.transform = 'translate(-50%, -50%)';
                moveRight = 0;
                moveForward = 0;
                joystickActive = false;
            }

            joystick.addEventListener('touchstart', (e) => {
                e.preventDefault();
                joystickActive = true;
            });

            joystick.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (joystickActive) {
                    handleJoystickMove(e.touches[0].clientX, e.touches[0].clientY);
                }
            });

            joystick.addEventListener('touchend', (e) => {
                e.preventDefault();
                resetJoystick();
            });

            // أزرار القفز والتسريع
            document.getElementById('jumpBtn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (!isJumping && player.position.y <= 10.1) {
                    playerVelocity.y = JUMP_FORCE;
                    isJumping = true;
                }
            });

            document.getElementById('boostBtn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                isBoosting = true;
            });

            document.getElementById('boostBtn').addEventListener('touchend', (e) => {
                e.preventDefault();
                isBoosting = false;
            });
        }

        function setupMouseControls() {
            const canvas = document.getElementById('gameCanvas');

            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMouseX = e.clientX;
                previousMouseY = e.clientY;
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - previousMouseX;
                    const deltaY = e.clientY - previousMouseY;

                    cameraAngleX -= deltaX * 0.005;
                    cameraAngleY -= deltaY * 0.005;

                    cameraAngleY = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, cameraAngleY));

                    previousMouseX = e.clientX;
                    previousMouseY = e.clientY;
                }
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });

            canvas.addEventListener('mouseleave', () => {
                isDragging = false;
            });

            // للأجهزة اللمسية
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    isDragging = true;
                    previousMouseX = e.touches[0].clientX;
                    previousMouseY = e.touches[0].clientY;
                }
            });

            canvas.addEventListener('touchmove', (e) => {
                if (isDragging && e.touches.length === 1) {
                    const deltaX = e.touches[0].clientX - previousMouseX;
                    const deltaY = e.touches[0].clientY - previousMouseY;

                    cameraAngleX -= deltaX * 0.005;
                    cameraAngleY -= deltaY * 0.005;

                    cameraAngleY = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, cameraAngleY));

                    previousMouseX = e.touches[0].clientX;
                    previousMouseY = e.touches[0].clientY;
                }
            });

            canvas.addEventListener('touchend', () => {
                isDragging = false;
            });
        }

        function updatePlayer() {
            // الحركة
            const currentSpeed = isBoosting ? MOVE_SPEED * BOOST_MULTIPLIER : MOVE_SPEED;
            
            const moveAngle = cameraAngleX;
            const forwardX = Math.sin(moveAngle);
            const forwardZ = Math.cos(moveAngle);
            const rightX = Math.cos(moveAngle);
            const rightZ = -Math.sin(moveAngle);

            playerVelocity.x = (forwardX * moveForward + rightX * moveRight) * currentSpeed;
            playerVelocity.z = (forwardZ * moveForward + rightZ * moveRight) * currentSpeed;

            // الجاذبية والقفز
            playerVelocity.y += GRAVITY;
            player.position.y += playerVelocity.y;

            if (player.position.y <= 10) {
                player.position.y = 10;
                playerVelocity.y = 0;
                isJumping = false;
            }

            // تطبيق السرعة
            const newX = player.position.x + playerVelocity.x;
            const newZ = player.position.z + playerVelocity.z;

            // فحص التصادم مع المباني
            let collision = false;
            const playerRadius = 4;
            
            for (let building of obstacles) {
                const bBox = new THREE.Box3().setFromObject(building);
                
                // تحقق بسيط من التصادم
                if (newX + playerRadius > bBox.min.x && newX - playerRadius < bBox.max.x &&
                    newZ + playerRadius > bBox.min.z && newZ - playerRadius < bBox.max.z &&
                    player.position.y < bBox.max.y) {
                    collision = true;
                    break;
                }
            }

            if (!collision) {
                player.position.x = newX;
                player.position.z = newZ;
            } else {
                // إيقاف الحركة عند التصادم
                playerVelocity.x *= -0.5;
                playerVelocity.z *= -0.5;
            }

            // حساب السرعة والمسافة
            speed = Math.sqrt(playerVelocity.x ** 2 + playerVelocity.z ** 2) * 10;
            distance += speed * 0.016;

            document.getElementById('speedDisplay').textContent = Math.round(speed);
            document.getElementById('distanceDisplay').textContent = Math.round(distance);
        }

        function updatePolice() {
            if (isGameOver) return;
            
            policeCars.forEach(car => {
                const dx = player.position.x - car.mesh.position.x;
                const dz = player.position.z - car.mesh.position.z;
                const distance = Math.sqrt(dx * dx + dz * dz);

                // فحص التصادم مع اللاعب
                if (distance < 8) {
                    gameOver();
                    return;
                }

                if (distance > 5) {
                    car.velocity.x = (dx / distance) * 1.2;
                    car.velocity.z = (dz / distance) * 1.2;

                    car.mesh.position.x += car.velocity.x;
                    car.mesh.position.z += car.velocity.z;

                    car.mesh.rotation.y = Math.atan2(dx, dz);
                }
            });
        }

        function updateCamera() {
            const distance = 40;
            const height = 20;

            const targetX = player.position.x - Math.sin(cameraAngleX) * distance * Math.cos(cameraAngleY);
            const targetY = player.position.y + height + Math.sin(cameraAngleY) * distance;
            const targetZ = player.position.z - Math.cos(cameraAngleX) * distance * Math.cos(cameraAngleY);

            // تنعيم حركة الكاميرا
            camera.position.x += (targetX - camera.position.x) * 0.1;
            camera.position.y += (targetY - camera.position.y) * 0.1;
            camera.position.z += (targetZ - camera.position.z) * 0.1;

            camera.lookAt(player.position.x, player.position.y + 5, player.position.z);
        }

        function animate() {
            requestAnimationFrame(animate);

            if (!isGameOver) {
                updatePlayer();
                updatePolice();
                updateCamera();
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
