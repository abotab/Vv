<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø£Ù†Ù…ÙŠØ´Ù† Ø§Ù„Ø¹Ø±Ø¨ - Ø§Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù„Ø´Ø®ØµÙŠØ§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    
    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <script src="https://cdn.jsdelivr.net/npm/@rive-app/canvas@latest/rive.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/Draggable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --secondary: #ec4899;
            --accent: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f8fafc;
            --glass: rgba(15, 23, 42, 0.95);
            --glass-border: rgba(99, 102, 241, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--darker);
            color: var(--light);
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }
        
        /* ===== HEADER ===== */
        .header {
            height: 60px;
            background: linear-gradient(135deg, var(--dark) 0%, #1e293b 100%);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .logo {
            font-size: 20px;
            font-weight: 900;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-btns {
            display: flex;
            gap: 8px;
        }
        
        .header-btn {
            width: 40px;
            height: 40px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .header-btn:hover, .header-btn.active {
            background: var(--primary);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
        }
        
        /* ===== MAIN LAYOUT ===== */
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding-top: 60px;
            padding-bottom: 80px;
        }
        
        /* ===== TOP TOOLBAR ===== */
        .top-toolbar {
            height: 70px;
            background: var(--dark);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 10px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        
        .top-toolbar::-webkit-scrollbar {
            display: none;
        }
        
        .tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            color: var(--light);
            cursor: pointer;
            min-width: 60px;
            transition: all 0.3s;
        }
        
        .tool-btn i {
            font-size: 20px;
        }
        
        .tool-btn span {
            font-size: 10px;
            font-weight: 600;
        }
        
        .tool-btn:hover, .tool-btn.active {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        /* ===== CANVAS AREA ===== */
        .canvas-area {
            flex: 1;
            position: relative;
            background: 
                linear-gradient(45deg, #0f172a 25%, transparent 25%), 
                linear-gradient(-45deg, #0f172a 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #0f172a 75%), 
                linear-gradient(-45deg, transparent 75%, #0f172a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #1e293b;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        #mainCanvas {
            max-width: 100%;
            max-height: 100%;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
        }
        
        /* ===== BOTTOM CONTROL PANEL ===== */
        .control-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: var(--glass);
            border-top: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 10px;
            z-index: 1000;
        }
        
        .control-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 10px;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        .control-btn i {
            font-size: 24px;
        }
        
        .control-btn span {
            font-size: 11px;
            font-weight: 600;
        }
        
        .control-btn:hover, .control-btn.active {
            color: var(--primary);
            transform: translateY(-3px);
        }
        
        .control-btn.primary {
            color: var(--secondary);
        }
        
        /* ===== MODALS ===== */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            flex-direction: column;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-header {
            height: 60px;
            background: var(--dark);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }
        
        .modal-close {
            width: 40px;
            height: 40px;
            background: rgba(239, 68, 68, 0.2);
            border: none;
            border-radius: 10px;
            color: var(--danger);
            cursor: pointer;
            font-size: 20px;
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* ===== PARTS GRID ===== */
        .parts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .part-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .part-card:hover, .part-card.active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.2);
        }
        
        .part-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .part-name {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .part-status {
            font-size: 11px;
            color: #64748b;
        }
        
        .part-card.has-image .part-status {
            color: var(--success);
        }
        
        /* ===== BONE CONTROLLER ===== */
        .bone-controller {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 280px;
            background: var(--glass);
            border: 2px solid var(--primary);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            box-shadow: var(--neon);
        }
        
        .bone-controller.show {
            display: flex;
        }
        
        .controller-pad {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            position: relative;
        }
        
        .controller-knob {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.8);
            cursor: grab;
            touch-action: none;
        }
        
        .controller-knob:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.2);
        }
        
        .controller-label {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            font-weight: 700;
            white-space: nowrap;
        }
        
        /* ===== ANIMATIONS LIST ===== */
        .anim-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .anim-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .anim-item:hover {
            background: rgba(99, 102, 241, 0.2);
            transform: translateX(-5px);
        }
        
        .anim-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .anim-info {
            flex: 1;
        }
        
        .anim-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 3px;
        }
        
        .anim-desc {
            font-size: 12px;
            color: #94a3b8;
        }
        
        /* ===== TIMELINE ===== */
        .timeline-container {
            position: fixed;
            bottom: 80px;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--dark);
            border-top: 1px solid var(--glass-border);
            display: none;
            align-items: center;
            padding: 0 15px;
            gap: 15px;
        }
        
        .timeline-container.show {
            display: flex;
        }
        
        .timeline-track {
            flex: 1;
            height: 40px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .timeline-progress {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 0%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.1s;
        }
        
        .keyframe-markers {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
        
        .keyframe-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--warning);
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* ===== EXPORT MODAL ===== */
        .export-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .export-option {
            padding: 20px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .export-option:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.2);
        }
        
        .export-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .export-desc {
            font-size: 13px;
            color: #94a3b8;
        }
        
        /* ===== PROGRESS ===== */
        .progress-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 300px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            z-index: 3000;
            display: none;
        }
        
        .progress-container.show {
            display: block;
        }
        
        .progress-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(99, 102, 241, 0.3);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .progress-text {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
        }
        
        /* ===== SAVE ANIMATION MODAL ===== */
        .save-anim-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-input {
            padding: 15px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--light);
            font-family: inherit;
            font-size: 16px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .saved-anims {
            margin-top: 20px;
        }
        
        .saved-anim-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 12px;
            margin-bottom: 10px;
        }
        
        /* ===== UTILITIES ===== */
        .hidden { display: none !important; }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--darker);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(99, 102, 241, 0.3);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            margin-top: 20px;
            font-size: 18px;
            color: var(--primary);
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loader">
        <div class="loading-spinner"></div>
        <div class="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="logo">Ø£Ù†Ù…ÙŠØ´Ù† Ø§Ù„Ø¹Ø±Ø¨</div>
        <div class="header-btns">
            <button class="header-btn" onclick="undo()" title="ØªØ±Ø§Ø¬Ø¹">
                <i class="fas fa-undo"></i>
            </button>
            <button class="header-btn" onclick="redo()" title="Ø¥Ø¹Ø§Ø¯Ø©">
                <i class="fas fa-redo"></i>
            </button>
            <button class="header-btn" onclick="showModal('partsModal')" title="Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø´Ø®ØµÙŠØ©">
                <i class="fas fa-puzzle-piece"></i>
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        
        <!-- Top Toolbar -->
        <div class="top-toolbar">
            <button class="tool-btn active" onclick="setTool('select')" id="toolSelect">
                <i class="fas fa-mouse-pointer"></i>
                <span>Ø§Ø®ØªÙŠØ§Ø±</span>
            </button>
            <button class="tool-btn" onclick="setTool('move')" id="toolMove">
                <i class="fas fa-arrows-alt"></i>
                <span>ØªØ­Ø±ÙŠÙƒ</span>
            </button>
            <button class="tool-btn" onclick="setTool('bone')" id="toolBone">
                <i class="fas fa-bone"></i>
                <span>Ø¹Ø¸Ù…</span>
            </button>
            <button class="tool-btn" onclick="setTool('rotate')" id="toolRotate">
                <i class="fas fa-sync-alt"></i>
                <span>Ø¯ÙˆØ±Ø§Ù†</span>
            </button>
            <button class="tool-btn" onclick="setTool('scale')" id="toolScale">
                <i class="fas fa-expand"></i>
                <span>Ø­Ø¬Ù…</span>
            </button>
            <button class="tool-btn" onclick="toggleTimeline()" id="toolTimeline">
                <i class="fas fa-film"></i>
                <span>ÙØ±ÙŠÙ…Ø§Øª</span>
            </button>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-area" id="canvasArea">
            <canvas id="mainCanvas"></canvas>
        </div>

        <!-- Timeline -->
        <div class="timeline-container" id="timelineBar">
            <button class="control-btn" onclick="goToPrevFrame()" style="color: var(--light);">
                <i class="fas fa-step-backward"></i>
            </button>
            <div class="timeline-track" id="timelineTrack" onclick="seekTimeline(event)">
                <div class="timeline-progress" id="timelineProgress"></div>
                <div class="keyframe-markers" id="keyframeMarkers"></div>
            </div>
            <span id="frameDisplay" style="font-family: monospace; font-size: 18px; color: var(--primary); min-width: 50px; text-align: center;">1</span>
            <button class="control-btn" onclick="goToNextFrame()" style="color: var(--light);">
                <i class="fas fa-step-forward"></i>
            </button>
        </div>

        <!-- Bone Controller (Floating) -->
        <div class="bone-controller" id="boneController">
            <div class="controller-pad" id="controllerPad">
                <div class="controller-knob" id="controllerKnob"></div>
            </div>
            <div class="controller-label" id="controllerLabel">Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø±ÙŠÙƒ</div>
        </div>

        <!-- Progress -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-spinner"></div>
            <div class="progress-text" id="progressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</div>
        </div>
    </div>

    <!-- Bottom Control Panel -->
    <div class="control-panel">
        <button class="control-btn" onclick="showModal('partsModal')">
            <i class="fas fa-puzzle-piece"></i>
            <span>Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡</span>
        </button>
        <button class="control-btn" onclick="showModal('bonesModal')">
            <i class="fas fa-bone"></i>
            <span>Ø§Ù„Ø¹Ø¸Ø§Ù…</span>
        </button>
        <button class="control-btn" onclick="showModal('animsModal')">
            <i class="fas fa-running"></i>
            <span>Ø§Ù„Ø­Ø±ÙƒØ§Øª</span>
        </button>
        <button class="control-btn primary" onclick="togglePlayback()" id="playBtn">
            <i class="fas fa-play"></i>
            <span>ØªØ´ØºÙŠÙ„</span>
        </button>
        <button class="control-btn" onclick="showModal('saveAnimModal')">
            <i class="fas fa-save"></i>
            <span>Ø­ÙØ¸</span>
        </button>
        <button class="control-btn" onclick="showModal('exportModal')">
            <i class="fas fa-file-export"></i>
            <span>ØªØµØ¯ÙŠØ±</span>
        </button>
    </div>

    <!-- Parts Modal -->
    <div class="modal" id="partsModal">
        <div class="modal-header">
            <h3 class="modal-title">Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø´Ø®ØµÙŠØ©</h3>
            <button class="modal-close" onclick="closeModal('partsModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="parts-grid" id="partsGrid">
                <!-- Parts will be generated by JS -->
            </div>
        </div>
    </div>

    <!-- Bones Modal -->
    <div class="modal" id="bonesModal">
        <div class="modal-header">
            <h3 class="modal-title">Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¹Ø¸Ø§Ù…</h3>
            <button class="modal-close" onclick="closeModal('bonesModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="anim-list" id="bonesList">
                <!-- Bones will be listed here -->
            </div>
            <button class="action-btn" onclick="autoRig()" style="margin-top: 20px;">
                <i class="fas fa-magic"></i>
                ØªÙÙƒÙŠÙƒ ØªÙ„Ù‚Ø§Ø¦ÙŠ
            </button>
        </div>
    </div>

    <!-- Animations Modal -->
    <div class="modal" id="animsModal">
        <div class="modal-header">
            <h3 class="modal-title">Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©</h3>
            <button class="modal-close" onclick="closeModal('animsModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="anim-list">
                <div class="anim-item" onclick="playPreset('waveRight')">
                    <div class="anim-icon">ğŸ‘‹</div>
                    <div class="anim-info">
                        <div class="anim-name">ØªÙ„ÙˆÙŠØ­ Ø¨Ø§Ù„ÙŠØ¯ Ø§Ù„ÙŠÙ…Ù†Ù‰</div>
                        <div class="anim-desc">ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙŠØ¯ Ø§Ù„ÙŠÙ…Ù†Ù‰ Ù„Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ§Ù„Ø£Ø³ÙÙ„</div>
                    </div>
                </div>
                <div class="anim-item" onclick="playPreset('waveLeft')">
                    <div class="anim-icon">ğŸ‘‹</div>
                    <div class="anim-info">
                        <div class="anim-name">ØªÙ„ÙˆÙŠØ­ Ø¨Ø§Ù„ÙŠØ¯ Ø§Ù„ÙŠØ³Ø±Ù‰</div>
                        <div class="anim-desc">ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙŠØ¯ Ø§Ù„ÙŠØ³Ø±Ù‰ Ù„Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ§Ù„Ø£Ø³ÙÙ„</div>
                    </div>
                </div>
                <div class="anim-item" onclick="playPreset('walk')">
                    <div class="anim-icon">ğŸš¶</div>
                    <div class="anim-info">
                        <div class="anim-name">Ù…Ø´ÙŠ</div>
                        <div class="anim-desc">Ø­Ø±ÙƒØ© Ù…Ø´ÙŠ ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø´Ø®ØµÙŠØ©</div>
                    </div>
                </div>
                <div class="anim-item" onclick="playPreset('sit')">
                    <div class="anim-icon">ğŸª‘</div>
                    <div class="anim-info">
                        <div class="anim-name">Ø¬Ù„ÙˆØ³</div>
                        <div class="anim-desc">Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ÙˆØ¶Ø¹ÙŠØ© Ø§Ù„Ø¬Ù„ÙˆØ³</div>
                    </div>
                </div>
                <div class="anim-item" onclick="playPreset('talk')">
                    <div class="anim-icon">ğŸ’¬</div>
                    <div class="anim-info">
                        <div class="anim-name">ØªØ­Ø¯Ø«</div>
                        <div class="anim-desc">Ø­Ø±ÙƒØ© Ø§Ù„ÙÙƒ ÙˆØ§Ù„Ø±Ø£Ø³ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒÙ„Ø§Ù…</div>
                    </div>
                </div>
                <div class="anim-item" onclick="playPreset('blink')">
                    <div class="anim-icon">ğŸ‘ï¸</div>
                    <div class="anim-info">
                        <div class="anim-name">Ø±Ù…Ø´</div>
                        <div class="anim-desc">Ø¥ØºÙ…Ø§Ø¶ ÙˆÙØªØ­ Ø§Ù„Ø¹ÙŠÙˆÙ†</div>
                    </div>
                </div>
                <div class="anim-item" onclick="playPreset('jump')">
                    <div class="anim-icon">â¬†ï¸</div>
                    <div class="anim-info">
                        <div class="anim-name">Ù‚ÙØ²</div>
                        <div class="anim-desc">Ù‚ÙØ²Ø© ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰</div>
                    </div>
                </div>
                <div class="anim-item" onclick="playPreset('dance')">
                    <div class="anim-icon">ğŸµ</div>
                    <div class="anim-info">
                        <div class="anim-name">Ø±Ù‚Øµ</div>
                        <div class="anim-desc">Ø­Ø±ÙƒØ© Ø±Ù‚Øµ Ù…ØªÙƒØ§Ù…Ù„Ø©</div>
                    </div>
                </div>
                <div class="anim-item" onclick="playPreset('headNod')">
                    <div class="anim-icon">ğŸ™‚</div>
                    <div class="anim-info">
                        <div class="anim-name">Ø¥ÙŠÙ…Ø§Ø¡Ø© Ø¨Ø§Ù„Ø±Ø£Ø³</div>
                        <div class="anim-desc">Ø¥ÙŠÙ…Ø§Ø¡Ø© Ù…ÙˆØ§ÙÙ‚Ø© Ø¨Ø§Ù„Ø±Ø£Ø³</div>
                    </div>
                </div>
                <div class="anim-item" onclick="playPreset('shakeHead')">
                    <div class="anim-icon">ğŸ˜•</div>
                    <div class="anim-info">
                        <div class="anim-name">Ù‡Ø² Ø§Ù„Ø±Ø£Ø³</div>
                        <div class="anim-desc">Ù‡Ø² Ø§Ù„Ø±Ø£Ø³ Ù„Ù„Ø±ÙØ¶</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Animation Modal -->
    <div class="modal" id="saveAnimModal">
        <div class="modal-header">
            <h3 class="modal-title">Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©</h3>
            <button class="modal-close" onclick="closeModal('saveAnimModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="save-anim-form">
                <input type="text" class="form-input" id="animNameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø±ÙƒØ© (Ù…Ø«Ø§Ù„: ØªØ­ÙŠØ© Ø®Ø§ØµØ©)">
                <button class="action-btn" onclick="saveCurrentAnimation()">
                    <i class="fas fa-save"></i>
                    Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©
                </button>
            </div>
            <div class="saved-anims" id="savedAnimsList">
                <h4 style="margin-bottom: 15px; color: var(--primary);">Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</h4>
                <!-- Saved animations will appear here -->
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-header">
            <h3 class="modal-title">ØªØµØ¯ÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</h3>
            <button class="modal-close" onclick="closeModal('exportModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="export-options">
                <div class="export-option" onclick="exportVideo('720p')">
                    <div class="export-title">720p HD</div>
                    <div class="export-desc">Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© - Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù‡Ø§ØªÙ</div>
                </div>
                <div class="export-option" onclick="exportVideo('1080p')">
                    <div class="export-title">1080p Full HD</div>
                    <div class="export-desc">Ø¬ÙˆØ¯Ø© ÙØ§Ø¦Ù‚Ø© - Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ÙŠÙˆØªÙŠÙˆØ¨</div>
                </div>
                <div class="export-option" onclick="exportVideo('4k')">
                    <div class="export-title">4K Ultra HD</div>
                    <div class="export-desc">Ø£Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø© - Ù„Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</div>
                </div>
                <div class="export-option" onclick="saveProject()">
                    <div class="export-title">Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
                    <div class="export-desc">Ø­ÙØ¸ Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ Ù„Ø§Ø­Ù‚Ø§Ù‹</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL STATE =====
        const App = {
            // Canvas
            canvas: null,
            ctx: null,
            stage: null,
            layer: null,
            
            // Character Parts
            parts: {
                head: { name: 'Ø§Ù„Ø±Ø£Ø³', icon: 'ğŸ˜€', image: null, x: 0, y: 0, rotation: 0, scale: 1 },
                body: { name: 'Ø§Ù„Ø¬Ø³Ù…', icon: 'ğŸ‘•', image: null, x: 0, y: 0, rotation: 0, scale: 1 },
                rightArm: { name: 'Ø§Ù„ÙŠØ¯ Ø§Ù„ÙŠÙ…Ù†Ù‰', icon: 'ğŸ’ª', image: null, x: 0, y: 0, rotation: 0, scale: 1 },
                leftArm: { name: 'Ø§Ù„ÙŠØ¯ Ø§Ù„ÙŠØ³Ø±Ù‰', icon: 'ğŸ’ª', image: null, x: 0, y: 0, rotation: 0, scale: 1 },
                rightLeg: { name: 'Ø§Ù„Ø±Ø¬Ù„ Ø§Ù„ÙŠÙ…Ù†Ù‰', icon: 'ğŸ¦µ', image: null, x: 0, y: 0, rotation: 0, scale: 1 },
                leftLeg: { name: 'Ø§Ù„Ø±Ø¬Ù„ Ø§Ù„ÙŠØ³Ø±Ù‰', icon: 'ğŸ¦µ', image: null, x: 0, y: 0, rotation: 0, scale: 1 },
                rightEye: { name: 'Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„ÙŠÙ…Ù†Ù‰', icon: 'ğŸ‘ï¸', image: null, x: 0, y: 0, rotation: 0, scale: 1 },
                leftEye: { name: 'Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„ÙŠØ³Ø±Ù‰', icon: 'ğŸ‘ï¸', image: null, x: 0, y: 0, rotation: 0, scale: 1 },
                mouth: { name: 'Ø§Ù„ÙÙ…', icon: 'ğŸ‘„', image: null, x: 0, y: 0, rotation: 0, scale: 1 },
                rightEar: { name: 'Ø§Ù„Ø£Ø°Ù† Ø§Ù„ÙŠÙ…Ù†Ù‰', icon: 'ğŸ‘‚', image: null, x: 0, y: 0, rotation: 0, scale: 1 },
                leftEar: { name: 'Ø§Ù„Ø£Ø°Ù† Ø§Ù„ÙŠØ³Ø±Ù‰', icon: 'ğŸ‘‚', image: null, x: 0, y: 0, rotation: 0, scale: 1 }
            },
            
            // Bones System
            bones: [],
            selectedBone: null,
            selectedPart: null,
            
            // Animation
            currentFrame: 1,
            totalFrames: 60,
            isPlaying: false,
            fps: 24,
            keyframes: new Map(),
            savedAnimations: [],
            
            // Tools
            currentTool: 'select',
            
            // History
            history: [],
            historyStep: -1,
            
            // FFmpeg
            ffmpeg: null
        };

        // ===== INITIALIZATION =====
        window.addEventListener('load', async () => {
            await initApp();
            setupGestures();
            renderParts();
            
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
            }, 1500);
        });

        async function initApp() {
            // Setup Konva stage
            const container = document.getElementById('canvasArea');
            const width = container.clientWidth - 40;
            const height = container.clientHeight - 40;
            
            App.stage = new Konva.Stage({
                container: 'canvasArea',
                width: width,
                height: height
            });
            
            App.layer = new Konva.Layer();
            App.stage.add(App.layer);
            
            // Initialize FFmpeg
            try {
                const { FFmpeg } = FFmpegWASM;
                App.ffmpeg = new FFmpeg();
                await App.ffmpeg.load();
                console.log('âœ… FFmpeg loaded');
            } catch (e) {
                console.warn('âš ï¸ FFmpeg not available:', e);
            }
            
            // Setup canvas events
            setupCanvasEvents();
            
            // Load saved animations from localStorage
            loadSavedAnimations();
            
            console.log('âœ… App initialized');
        }

        function setupCanvasEvents() {
            // Hammer.js for touch gestures
            const hammer = new Hammer(App.stage.content);
            hammer.get('pan').set({ direction: Hammer.DIRECTION_ALL });
            hammer.get('pinch').set({ enable: true });
            hammer.get('rotate').set({ enable: true });
            
            hammer.on('tap', (e) => {
                const pos = App.stage.getPointerPosition();
                const shape = App.layer.getIntersection(pos);
                
                if (shape) {
                    selectPart(shape.getAttr('partId'));
                }
            });
            
            hammer.on('pan', (e) => {
                if (App.selectedPart && App.currentTool === 'move') {
                    movePart(App.selectedPart, e.deltaX, e.deltaY);
                }
            });
            
            hammer.on('rotate', (e) => {
                if (App.selectedPart && App.currentTool === 'rotate') {
                    rotatePart(App.selectedPart, e.rotation);
                }
            });
            
            hammer.on('pinch', (e) => {
                if (App.selectedPart && App.currentTool === 'scale') {
                    scalePart(App.selectedPart, e.scale);
                }
            });
        }

        function setupGestures() {
            // Bone controller gesture pad
            const pad = document.getElementById('controllerPad');
            const knob = document.getElementById('controllerKnob');
            
            const hammer = new Hammer(pad);
            hammer.get('pan').set({ direction: Hammer.DIRECTION_ALL });
            
            let startX = 0, startY = 0;
            
            hammer.on('panstart', () => {
                startX = parseFloat(knob.style.left) || 50;
                startY = parseFloat(knob.style.top) || 50;
            });
            
            hammer.on('pan', (e) => {
                const rect = pad.getBoundingClientRect();
                const x = Math.max(0, Math.min(100, startX + (e.deltaX / rect.width) * 100));
                const y = Math.max(0, Math.min(100, startY + (e.deltaY / rect.height) * 100));
                
                knob.style.left = x + '%';
                knob.style.top = y + '%';
                
                // Apply to selected bone/part
                if (App.selectedBone) {
                    const deltaX = (x - 50) * 2;
                    const deltaY = (y - 50) * 2;
                    moveBoneByController(deltaX, deltaY);
                }
            });
            
            hammer.on('panend', () => {
                knob.style.left = '50%';
                knob.style.top = '50%';
                saveKeyframe();
            });
        }

        // ===== PARTS SYSTEM =====
        function renderParts() {
            const grid = document.getElementById('partsGrid');
            grid.innerHTML = '';
            
            Object.entries(App.parts).forEach(([id, part]) => {
                const card = document.createElement('div');
                card.className = `part-card ${part.image ? 'has-image' : ''}`;
                card.onclick = () => selectPartToUpload(id);
                card.innerHTML = `
                    <div class="part-icon">${part.image ? 'âœ…' : part.icon}</div>
                    <div class="part-name">${part.name}</div>
                    <div class="part-status">${part.image ? 'ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„' : 'Ø§Ù†Ù‚Ø± Ù„Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©'}</div>
                `;
                grid.appendChild(card);
            });
        }

        function selectPartToUpload(partId) {
            App.selectedPart = partId;
            
            // Create file input dynamically
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => handlePartImage(e, partId);
            input.click();
        }

        function handlePartImage(event, partId) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    App.parts[partId].image = img;
                    
                    // Create Konva image
                    const konvaImg = new Konva.Image({
                        image: img,
                        x: App.stage.width() / 2,
                        y: App.stage.height() / 2,
                        width: 100,
                        height: 100,
                        draggable: true,
                        partId: partId
                    });
                    
                    // Add transform controls
                    const tr = new Konva.Transformer({
                        nodes: [konvaImg],
                        visible: false
                    });
                    
                    konvaImg.on('click tap', () => {
                        selectPart(partId);
                    });
                    
                    App.layer.add(konvaImg);
                    App.layer.add(tr);
                    App.layer.draw();
                    
                    renderParts();
                    saveHistory();
                    
                    showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${App.parts[partId].name}`);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function selectPart(partId) {
            App.selectedPart = partId;
            
            // Hide all transformers
            App.layer.find('Transformer').forEach(tr => tr.visible(false));
            
            // Show transformer for selected
            const shape = App.layer.findOne(node => node.getAttr('partId') === partId);
            if (shape) {
                const tr = shape.getParent().findOne('Transformer');
                if (tr) tr.visible(true);
            }
            
            App.layer.draw();
            updateBonesList();
        }

        function movePart(partId, dx, dy) {
            const shape = App.layer.findOne(node => node.getAttr('partId') === partId);
            if (shape) {
                shape.x(shape.x() + dx);
                shape.y(shape.y() + dy);
                App.layer.draw();
            }
        }

        function rotatePart(partId, rotation) {
            const shape = App.layer.findOne(node => node.getAttr('partId') === partId);
            if (shape) {
                shape.rotation(rotation);
                App.layer.draw();
            }
        }

        function scalePart(partId, scale) {
            const shape = App.layer.findOne(node => node.getAttr('partId') === partId);
            if (shape) {
                shape.scaleX(scale);
                shape.scaleY(scale);
                App.layer.draw();
            }
        }

        // ===== BONES SYSTEM =====
        function autoRig() {
            // Create automatic bones for all parts
            App.bones = [];
            
            const centerX = App.stage.width() / 2;
            const centerY = App.stage.height() / 2;
            
            // Root bone
            App.bones.push({
                id: 'root',
                name: 'Ø§Ù„Ø¬Ø°Ø±',
                x: centerX,
                y: centerY + 100,
                rotation: 0,
                parent: null,
                children: ['body'],
                partId: null
            });
            
            // Body bone
            App.bones.push({
                id: 'body',
                name: 'Ø§Ù„Ø¬Ø³Ù…',
                x: centerX,
                y: centerY,
                rotation: 0,
                parent: 'root',
                children: ['head', 'rightArm', 'leftArm'],
                partId: 'body'
            });
            
            // Head bone
            App.bones.push({
                id: 'head',
                name: 'Ø§Ù„Ø±Ø£Ø³',
                x: centerX,
                y: centerY - 80,
                rotation: 0,
                parent: 'body',
                children: ['rightEye', 'leftEye', 'mouth', 'rightEar', 'leftEar'],
                partId: 'head'
            });
            
            // Arms
            App.bones.push({
                id: 'rightArm',
                name: 'Ø§Ù„ÙŠØ¯ Ø§Ù„ÙŠÙ…Ù†Ù‰',
                x: centerX + 60,
                y: centerY - 20,
                rotation: 0,
                parent: 'body',
                children: [],
                partId: 'rightArm'
            });
            
            App.bones.push({
                id: 'leftArm',
                name: 'Ø§Ù„ÙŠØ¯ Ø§Ù„ÙŠØ³Ø±Ù‰',
                x: centerX - 60,
                y: centerY - 20,
                rotation: 0,
                parent: 'body',
                children: [],
                partId: 'leftArm'
            });
            
            // Legs
            App.bones.push({
                id: 'rightLeg',
                name: 'Ø§Ù„Ø±Ø¬Ù„ Ø§Ù„ÙŠÙ…Ù†Ù‰',
                x: centerX + 30,
                y: centerY + 100,
                rotation: 0,
                parent: 'root',
                children: [],
                partId: 'rightLeg'
            });
            
            App.bones.push({
                id: 'leftLeg',
                name: 'Ø§Ù„Ø±Ø¬Ù„ Ø§Ù„ÙŠØ³Ø±Ù‰',
                x: centerX - 30,
                y: centerY + 100,
                rotation: 0,
                parent: 'root',
                children: [],
                partId: 'leftLeg'
            });
            
            // Facial features
            ['rightEye', 'leftEye', 'mouth', 'rightEar', 'leftEar'].forEach((feature, i) => {
                const offsets = {
                    rightEye: { x: 20, y: -10 },
                    leftEye: { x: -20, y: -10 },
                    mouth: { x: 0, y: 20 },
                    rightEar: { x: 40, y: 0 },
                    leftEar: { x: -40, y: 0 }
                };
                
                App.bones.push({
                    id: feature,
                    name: App.parts[feature].name,
                    x: centerX + offsets[feature].x,
                    y: centerY - 80 + offsets[feature].y,
                    rotation: 0,
                    parent: 'head',
                    children: [],
                    partId: feature
                });
            });
            
            updateBonesList();
            drawBones();
            saveHistory();
            
            showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¹Ø¸Ù…ÙŠ Ø¨Ù†Ø¬Ø§Ø­!');
            closeModal('bonesModal');
        }

        function updateBonesList() {
            const list = document.getElementById('bonesList');
            list.innerHTML = '';
            
            App.bones.forEach(bone => {
                const item = document.createElement('div');
                item.className = 'anim-item';
                item.onclick = () => selectBone(bone.id);
                item.innerHTML = `
                    <div class="anim-icon" style="font-size: 20px;">ğŸ¦´</div>
                    <div class="anim-info">
                        <div class="anim-name">${bone.name}</div>
                        <div class="anim-desc">${bone.children.length} Ø£Ø¬Ø²Ø§Ø¡ Ù…Ø±ØªØ¨Ø·Ø©</div>
                    </div>
                    <button class="header-btn" onclick="event.stopPropagation(); showBoneController('${bone.id}')">
                        <i class="fas fa-gamepad"></i>
                    </button>
                `;
                list.appendChild(item);
            });
        }

        function selectBone(boneId) {
            App.selectedBone = App.bones.find(b => b.id === boneId);
            App.selectedPart = App.selectedBone.partId;
            
            // Highlight on canvas
            drawBones();
            
            showToast(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: ${App.selectedBone.name}`);
        }

        function showBoneController(boneId) {
            App.selectedBone = App.bones.find(b => b.id === boneId);
            const controller = document.getElementById('boneController');
            const label = document.getElementById('controllerLabel');
            
            controller.classList.add('show');
            label.textContent = `ØªØ­Ø±ÙŠÙƒ: ${App.selectedBone.name}`;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                controller.classList.remove('show');
            }, 5000);
        }

        function moveBoneByController(dx, dy) {
            if (!App.selectedBone) return;
            
            // Move the bone
            App.selectedBone.x += dx * 0.5;
            App.selectedBone.y += dy * 0.5;
            
            // Move associated part
            if (App.selectedBone.partId) {
                const shape = App.layer.findOne(node => 
                    node.getAttr('partId') === App.selectedBone.partId
                );
                if (shape) {
                    shape.x(App.selectedBone.x);
                    shape.y(App.selectedBone.y);
                }
            }
            
            // Move children
            moveChildren(App.selectedBone, dx * 0.5, dy * 0.5);
            
            App.layer.draw();
            drawBones();
        }

        function moveChildren(bone, dx, dy) {
            bone.children.forEach(childId => {
                const child = App.bones.find(b => b.id === childId);
                if (child) {
                    child.x += dx;
                    child.y += dy;
                    
                    if (child.partId) {
                        const shape = App.layer.findOne(node => 
                            node.getAttr('partId') === child.partId
                        );
                        if (shape) {
                            shape.x(child.x);
                            shape.y(child.y);
                        }
                    }
                    
                    moveChildren(child, dx, dy);
                }
            });
        }

        function drawBones() {
            // Clear previous bones visualization
            const boneLayer = App.stage.findOne('#boneLayer') || new Konva.Layer({ id: 'boneLayer' });
            boneLayer.destroyChildren();
            
            // Draw connections
            App.bones.forEach(bone => {
                if (bone.parent) {
                    const parent = App.bones.find(b => b.id === bone.parent);
                    if (parent) {
                        const line = new Konva.Line({
                            points: [parent.x, parent.y, bone.x, bone.y],
                            stroke: App.selectedBone === bone ? '#ec4899' : '#6366f1',
                            strokeWidth: App.selectedBone === bone ? 4 : 2,
                            lineCap: 'round'
                        });
                        boneLayer.add(line);
                    }
                }
                
                // Draw joint
                const circle = new Konva.Circle({
                    x: bone.x,
                    y: bone.y,
                    radius: App.selectedBone === bone ? 10 : 6,
                    fill: App.selectedBone === bone ? '#10b981' : '#6366f1',
                    stroke: 'white',
                    strokeWidth: 2
                });
                boneLayer.add(circle);
                
                // Add label
                const text = new Konva.Text({
                    x: bone.x + 15,
                    y: bone.y - 15,
                    text: bone.name,
                    fontSize: 12,
                    fill: 'white',
                    fontFamily: 'Tajawal'
                });
                boneLayer.add(text);
            });
            
            App.stage.add(boneLayer);
            boneLayer.moveToTop();
        }

        // ===== ANIMATION SYSTEM =====
        function playPreset(presetName) {
            closeModal('animsModal');
            
            const presets = {
                waveRight: () => animateWave('rightArm'),
                waveLeft: () => animateWave('leftArm'),
                walk: animateWalk,
                sit: animateSit,
                talk: animateTalk,
                blink: animateBlink,
                jump: animateJump,
                dance: animateDance,
                headNod: () => animateHead('nod'),
                shakeHead: () => animateHead('shake')
            };
            
            if (presets[presetName]) {
                presets[presetName]();
                showToast('Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©...');
            }
        }

        function animateWave(armId) {
            const arm = App.bones.find(b => b.id === armId);
            if (!arm) return;
            
            const tl = gsap.timeline({ repeat: 3, yoyo: true });
            
            tl.to(arm, {
                rotation: 45,
                duration: 0.5,
                ease: "power2.inOut",
                onUpdate: () => updateBoneFromAnimation(arm)
            })
            .to(arm, {
                rotation: -20,
                duration: 0.5,
                ease: "power2.inOut",
                onUpdate: () => updateBoneFromAnimation(arm)
            });
        }

        function animateWalk() {
            const rightLeg = App.bones.find(b => b.id === 'rightLeg');
            const leftLeg = App.bones.find(b => b.id === 'leftLeg');
            const rightArm = App.bones.find(b => b.id === 'rightArm');
            const leftArm = App.bones.find(b => b.id === 'leftArm');
            
            const tl = gsap.timeline({ repeat: 4 });
            
            // Walking cycle
            tl.to([rightLeg, leftArm], {
                rotation: 30,
                duration: 0.4,
                ease: "power2.inOut",
                onUpdate: function() {
                    updateBoneFromAnimation(rightLeg);
                    updateBoneFromAnimation(leftArm);
                }
            })
            .to([leftLeg, rightArm], {
                rotation: -30,
                duration: 0.4,
                ease: "power2.inOut",
                onUpdate: function() {
                    updateBoneFromAnimation(leftLeg);
                    updateBoneFromAnimation(rightArm);
                }
            }, "<")
            .to([rightLeg, leftArm], {
                rotation: -30,
                duration: 0.4,
                ease: "power2.inOut",
                onUpdate: function() {
                    updateBoneFromAnimation(rightLeg);
                    updateBoneFromAnimation(leftArm);
                }
            })
            .to([leftLeg, rightArm], {
                rotation: 30,
                duration: 0.4,
                ease: "power2.inOut",
                onUpdate: function() {
                    updateBoneFromAnimation(leftLeg);
                    updateBoneFromAnimation(rightArm);
                }
            }, "<");
        }

        function animateSit() {
            const body = App.bones.find(b => b.id === 'body');
            const rightLeg = App.bones.find(b => b.id === 'rightLeg');
            const leftLeg = App.bones.find(b => b.id === 'leftLeg');
            
            gsap.to(body, {
                y: "+=50",
                duration: 1,
                ease: "power2.out",
                onUpdate: () => updateBoneFromAnimation(body)
            });
            
            gsap.to([rightLeg, leftLeg], {
                rotation: 90,
                duration: 1,
                delay: 0.3,
                ease: "power2.out",
                onUpdate: function() {
                    updateBoneFromAnimation(rightLeg);
                    updateBoneFromAnimation(leftLeg);
                }
            });
        }

        function animateTalk() {
            const head = App.bones.find(b => b.id === 'head');
            const mouth = App.bones.find(b => b.id === 'mouth');
            
            gsap.to(head, {
                y: "+=5",
                rotation: 5,
                duration: 0.2,
                repeat: 10,
                yoyo: true,
                ease: "power1.inOut",
                onUpdate: () => updateBoneFromAnimation(head)
            });
            
            if (mouth) {
                gsap.to(mouth, {
                    scale: 1.2,
                    duration: 0.15,
                    repeat: 15,
                    yoyo: true,
                    ease: "power1.inOut",
                    onUpdate: () => updateBoneFromAnimation(mouth)
                });
            }
        }

        function animateBlink() {
            const rightEye = App.bones.find(b => b.id === 'rightEye');
            const leftEye = App.bones.find(b => b.id === 'leftEye');
            
            if (rightEye && leftEye) {
                gsap.to([rightEye, leftEye], {
                    scaleY: 0.1,
                    duration: 0.15,
                    repeat: 3,
                    yoyo: true,
                    ease: "power2.inOut",
                    onUpdate: function() {
                        updateBoneFromAnimation(rightEye);
                        updateBoneFromAnimation(leftEye);
                    }
                });
            }
        }

        function animateJump() {
            const root = App.bones.find(b => b.id === 'root');
            const rightLeg = App.bones.find(b => b.id === 'rightLeg');
            const leftLeg = App.bones.find(b => b.id === 'leftLeg');
            
            const tl = gsap.timeline();
            
            // Crouch
            tl.to(root, {
                y: "-=20",
                duration: 0.3,
                ease: "power2.in",
                onUpdate: () => updateBoneFromAnimation(root)
            })
            // Jump up
            .to(root, {
                y: "-=150",
                duration: 0.4,
                ease: "power2.out",
                onUpdate: () => updateBoneFromAnimation(root)
            })
            // Legs bend
            .to([rightLeg, leftLeg], {
                rotation: -30,
                duration: 0.2,
                onUpdate: function() {
                    updateBoneFromAnimation(rightLeg);
                    updateBoneFromAnimation(leftLeg);
                }
            }, "<")
            // Fall down
            .to(root, {
                y: "+=150",
                duration: 0.5,
                ease: "bounce.out",
                onUpdate: () => updateBoneFromAnimation(root)
            })
            // Legs straighten
            .to([rightLeg, leftLeg], {
                rotation: 0,
                duration: 0.3,
                onUpdate: function() {
                    updateBoneFromAnimation(rightLeg);
                    updateBoneFromAnimation(leftLeg);
                }
            }, "<");
        }

        function animateDance() {
            const body = App.bones.find(b => b.id === 'body');
            const rightArm = App.bones.find(b => b.id === 'rightArm');
            const leftArm = App.bones.find(b => b.id === 'leftArm');
            const head = App.bones.find(b => b.id === 'head');
            
            const tl = gsap.timeline({ repeat: 3 });
            
            tl.to(body, {
                rotation: 10,
                duration: 0.5,
                ease: "power2.inOut",
                onUpdate: () => updateBoneFromAnimation(body)
            })
            .to([rightArm, leftArm], {
                rotation: "+=45",
                duration: 0.5,
                ease: "power2.inOut",
                onUpdate: function() {
                    updateBoneFromAnimation(rightArm);
                    updateBoneFromAnimation(leftArm);
                }
            }, "<")
            .to(head, {
                rotation: -15,
                duration: 0.25,
                yoyo: true,
                repeat: 1,
                ease: "power2.inOut",
                onUpdate: () => updateBoneFromAnimation(head)
            }, "<")
            .to(body, {
                rotation: -10,
                duration: 0.5,
                ease: "power2.inOut",
                onUpdate: () => updateBoneFromAnimation(body)
            })
            .to([rightArm, leftArm], {
                rotation: "-=45",
                duration: 0.5,
                ease: "power2.inOut",
                onUpdate: function() {
                    updateBoneFromAnimation(rightArm);
                    updateBoneFromAnimation(leftArm);
                }
            }, "<");
        }

        function animateHead(type) {
            const head = App.bones.find(b => b.id === 'head');
            if (!head) return;
            
            if (type === 'nod') {
                gsap.to(head, {
                    rotation: 15,
                    duration: 0.3,
                    repeat: 2,
                    yoyo: true,
                    ease: "power2.inOut",
                    onUpdate: () => updateBoneFromAnimation(head)
                });
            } else if (type === 'shake') {
                gsap.to(head, {
                    x: "+=10",
                    duration: 0.2,
                    repeat: 5,
                    yoyo: true,
                    ease: "power2.inOut",
                    onUpdate: () => updateBoneFromAnimation(head)
                });
            }
        }

        function updateBoneFromAnimation(bone) {
            // Update part position based on bone
            if (bone.partId) {
                const shape = App.layer.findOne(node => 
                    node.getAttr('partId') === bone.partId
                );
                if (shape) {
                    shape.x(bone.x);
                    shape.y(bone.y);
                    shape.rotation(bone.rotation);
                    shape.scaleX(bone.scale || 1);
                    shape.scaleY(bone.scale || 1);
                }
            }
            
            App.layer.draw();
            drawBones();
        }

        // ===== TIMELINE =====
        function toggleTimeline() {
            const timeline = document.getElementById('timelineBar');
            timeline.classList.toggle('show');
            
            const btn = document.getElementById('toolTimeline');
            btn.classList.toggle('active');
        }

        function goToPrevFrame() {
            if (App.currentFrame > 1) {
                App.currentFrame--;
                updateTimeline();
                interpolateFrame();
            }
        }

        function goToNextFrame() {
            if (App.currentFrame < App.totalFrames) {
                App.currentFrame++;
                updateTimeline();
                interpolateFrame();
            }
        }

        function seekTimeline(event) {
            const rect = event.currentTarget.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            App.currentFrame = Math.round(percent * App.totalFrames);
            updateTimeline();
            interpolateFrame();
        }

        function updateTimeline() {
            const percent = (App.currentFrame / App.totalFrames) * 100;
            document.getElementById('timelineProgress').style.width = percent + '%';
            document.getElementById('frameDisplay').textContent = App.currentFrame;
        }

        function togglePlayback() {
            App.isPlaying = !App.isPlaying;
            const btn = document.getElementById('playBtn');
            btn.innerHTML = App.isPlaying ? '<i class="fas fa-pause"></i><span>Ø¥ÙŠÙ‚Ø§Ù</span>' : '<i class="fas fa-play"></i><span>ØªØ´ØºÙŠÙ„</span>';
            
            if (App.isPlaying) {
                playTimeline();
            }
        }

        function playTimeline() {
            if (!App.isPlaying) return;
            
            App.currentFrame++;
            if (App.currentFrame > App.totalFrames) {
                App.currentFrame = 1;
            }
            
            updateTimeline();
            interpolateFrame();
            
            setTimeout(() => requestAnimationFrame(playTimeline), 1000 / App.fps);
        }

        function interpolateFrame() {
            // Interpolate between keyframes
            App.bones.forEach(bone => {
                const keyframe = App.keyframes.get(`${bone.id}_${App.currentFrame}`);
                if (keyframe) {
                    bone.x = keyframe.x;
                    bone.y = keyframe.y;
                    bone.rotation = keyframe.rotation;
                    updateBoneFromAnimation(bone);
                }
            });
        }

        function addKeyframe() {
            if (!App.selectedBone) {
                showToast('Ø§Ø®ØªØ± Ø¹Ø¸Ù…Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            App.keyframes.set(`${App.selectedBone.id}_${App.currentFrame}`, {
                x: App.selectedBone.x,
                y: App.selectedBone.y,
                rotation: App.selectedBone.rotation
            });
            
            // Visual marker
            const marker = document.createElement('div');
            marker.className = 'keyframe-dot';
            const percent = (App.currentFrame / App.totalFrames) * 100;
            marker.style.left = percent + '%';
            document.getElementById('keyframeMarkers').appendChild(marker);
            
            showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ù…ÙØªØ§Ø­ÙŠ');
        }

        // ===== SAVE & EXPORT =====
        function saveCurrentAnimation() {
            const name = document.getElementById('animNameInput').value;
            if (!name) {
                showToast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ø§Ù‹ Ù„Ù„Ø­Ø±ÙƒØ©');
                return;
            }
            
            const animation = {
                name: name,
                bones: JSON.parse(JSON.stringify(App.bones)),
                keyframes: Array.from(App.keyframes.entries()),
                date: new Date().toISOString()
            };
            
            App.savedAnimations.push(animation);
            localStorage.setItem('savedAnimations', JSON.stringify(App.savedAnimations));
            
            document.getElementById('animNameInput').value = '';
            loadSavedAnimations();
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©!');
        }

        function loadSavedAnimations() {
            const saved = localStorage.getItem('savedAnimations');
            if (saved) {
                App.savedAnimations = JSON.parse(saved);
            }
            
            const list = document.getElementById('savedAnimsList');
            const existing = list.querySelectorAll('.saved-anim-item');
            existing.forEach(el => el.remove());
            
            App.savedAnimations.forEach((anim, index) => {
                const item = document.createElement('div');
                item.className = 'saved-anim-item';
                item.innerHTML = `
                    <span>${anim.name}</span>
                    <button class="header-btn" onclick="loadSavedAnimation(${index})">
                        <i class="fas fa-play"></i>
                    </button>
                `;
                list.appendChild(item);
            });
        }

        function loadSavedAnimation(index) {
            const anim = App.savedAnimations[index];
            if (!anim) return;
            
            App.bones = JSON.parse(JSON.stringify(anim.bones));
            App.keyframes = new Map(anim.keyframes);
            
            updateBonesList();
            drawBones();
            closeModal('saveAnimModal');
            showToast(`ØªÙ… ØªØ­Ù…ÙŠÙ„: ${anim.name}`);
        }

        async function exportVideo(quality) {
            closeModal('exportModal');
            showProgress('Ø¬Ø§Ø±ÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...');
            
            // Simulate export (in real app, use FFmpeg.wasm)
            setTimeout(() => {
                hideProgress();
                showToast(`ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø¬ÙˆØ¯Ø© ${quality}`);
            }, 3000);
        }

        function saveProject() {
            const project = {
                parts: Object.entries(App.parts).map(([id, part]) => ({
                    id,
                    ...part,
                    image: null // Don't save image data to localStorage (too big)
                })),
                bones: App.bones,
                keyframes: Array.from(App.keyframes.entries()),
                date: new Date().toISOString()
            };
            
            localStorage.setItem('animationProject', JSON.stringify(project));
            closeModal('exportModal');
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹!');
        }

        // ===== HISTORY =====
        function saveHistory() {
            App.historyStep++;
            if (App.historyStep < App.history.length) {
                App.history.length = App.historyStep;
            }
            
            App.history.push({
                bones: JSON.parse(JSON.stringify(App.bones)),
                parts: JSON.parse(JSON.stringify(App.parts))
            });
            
            if (App.history.length > 20) {
                App.history.shift();
                App.historyStep--;
            }
        }

        function undo() {
            if (App.historyStep > 0) {
                App.historyStep--;
                restoreHistory();
            }
        }

        function redo() {
            if (App.historyStep < App.history.length - 1) {
                App.historyStep++;
                restoreHistory();
            }
        }

        function restoreHistory() {
            const state = App.history[App.historyStep];
            App.bones = JSON.parse(JSON.stringify(state.bones));
            App.parts = JSON.parse(JSON.stringify(state.parts));
            
            updateBonesList();
            drawBones();
            renderParts();
        }

        // ===== UTILITIES =====
        function setTool(tool) {
            App.currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tool' + tool.charAt(0).toUpperCase() + tool.slice(1)).classList.add('active');
        }

        function showModal(id) {
            document.getElementById(id).classList.add('show');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function showProgress(text) {
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressContainer').classList.add('show');
        }

        function hideProgress() {
            document.getElementById('progressContainer').classList.remove('show');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--glass);
                border: 1px solid var(--glass-border);
                padding: 15px 30px;
                border-radius: 12px;
                color: white;
                font-weight: 600;
                z-index: 3000;
                backdrop-filter: blur(10px);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            gsap.from(toast, { y: -20, opacity: 0, duration: 0.3 });
            setTimeout(() => {
                gsap.to(toast, { y: -20, opacity: 0, duration: 0.3, onComplete: () => toast.remove() });
            }, 2000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            } else if (e.ctrlKey && e.key === 'y') {
                e.preventDefault();
                redo();
            }
        });

        console.log('ğŸ¬ Ø£Ù†Ù…ÙŠØ´Ù† Ø§Ù„Ø¹Ø±Ø¨ - Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø¨Ø¯Ø§Ø¹!');
    </script>
</body>
</html>