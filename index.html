<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù„Ø¹Ø±Ø¨ | Arab Studio</title>
    
    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            overflow: hidden;
            touch-action: none;
            height: 100vh;
            width: 100vw;
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .logo-container {
            text-align: center;
        }
        
        .logo-text {
            font-size: 3rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 20px rgba(255,255,255,0.5);
            margin-bottom: 10px;
        }
        
        .logo-subtitle {
            font-size: 1.2rem;
            color: rgba(255,255,255,0.9);
        }
        
        /* Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        #main-app {
            display: none;
            height: 100vh;
            width: 100vw;
            position: relative;
        }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .top-bar {
            position: fixed;
            top: 0;
            width: 100%;
            height: 60px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        
        .app-title {
            font-size: 1.3rem;
            font-weight: bold;
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .exit-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        /* Ø²Ø± Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .assemble-btn {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 50%, #ffecd2 100%);
            border: none;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 20px 60px rgba(245, 87, 108, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .assemble-btn:active {
            transform: translate(-50%, -50%) scale(0.95);
        }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹ */
        #editor-interface {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #fff5f5 0%, #ffe0e0 100%);
            z-index: 2000;
            flex-direction: column;
        }
        
        .editor-header {
            height: 50px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .editor-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„ÙŠØ³Ø§Ø±) */
        .controls-panel {
            width: 80px;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 5px;
            gap: 10px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            overflow-y: auto;
        }
        
        .tool-btn {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            border: none;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #d63031;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .tool-btn:active {
            transform: scale(0.9);
        }
        
        .tool-btn.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .tool-label {
            font-size: 0.7rem;
            margin-top: 2px;
            color: #666;
        }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ (Ø§Ù„ÙˆØ³Ø·) */
        .canvas-container {
            flex: 1;
            position: relative;
            background: #f8f9fa;
            overflow: hidden;
        }
        
        #main-canvas {
            width: 100%;
            height: 100%;
        }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Ø§Ù„ÙŠÙ…ÙŠÙ†) */
        .preview-panel {
            width: 120px;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.05);
        }
        
        .preview-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        #preview-canvas {
            width: 100px;
            height: 150px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            background: #fafafa;
        }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-toolbar {
            height: 70px;
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        
        .action-btn {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .save-btn {
            background: linear-gradient(45deg, #00b894, #00cec9);
            color: white;
        }
        
        .exit-editor-btn {
            background: linear-gradient(45deg, #ff7675, #d63031);
            color: white;
        }
        
        .add-image-btn {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
            color: white;
        }
        
        /* Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
        }
        
        .upload-area {
            border: 3px dashed #ff9ff3;
            border-radius: 15px;
            padding: 40px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:active {
            background: #fff5f5;
        }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø³ÙŠÙ…Ø§Øª */
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
        }
    </style>
</head>
<body>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
    <div id="splash-screen">
        <div class="particles" id="particles"></div>
        <div class="logo-container">
            <h1 class="logo-text animate__animated animate__bounceIn">Ø§Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù„Ø¹Ø±Ø¨</h1>
            <p class="logo-subtitle animate__animated animate__fadeIn animate__delay-1s">Arab Animation Studio</p>
        </div>
    </div>

    <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="main-app">
        <div class="top-bar">
            <div class="app-title">ğŸ¨ Ø§Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù„Ø¹Ø±Ø¨</div>
            <button class="exit-btn" onclick="exitApp()">Ø®Ø±ÙˆØ¬</button>
        </div>
        
        <button class="assemble-btn animate__animated animate__pulse animate__infinite" onclick="openEditor()">
            ØªØ¬Ù…ÙŠØ¹<br>Ø§Ù„Ø´Ø®ØµÙŠØ©
        </button>
    </div>

    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø±Ø± -->
    <div id="editor-interface">
        <div class="editor-header">
            <button class="exit-btn" onclick="closeEditor()">Ø±Ø¬ÙˆØ¹</button>
            <span style="font-weight: bold; color: #666;">Ù…Ø­Ø±Ø± Ø§Ù„Ø´Ø®ØµÙŠØ§Øª</span>
            <div style="width: 60px;"></div>
        </div>
        
        <div class="editor-content">
            <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
            <div class="controls-panel">
                <button class="tool-btn" onclick="addImage()" title="Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©">
                    ğŸ“·
                    <span class="tool-label">Ø¥Ø¶Ø§ÙØ©</span>
                </button>
                
                <button class="tool-btn" onclick="toggleLock()" id="lockBtn" title="Ù‚ÙÙ„/ÙØªØ­">
                    ğŸ”“
                    <span class="tool-label">Ù‚ÙÙ„</span>
                </button>
                
                <button class="tool-btn" onclick="deleteSelected()" title="Ø­Ø°Ù">
                    ğŸ—‘ï¸
                    <span class="tool-label">Ø­Ø°Ù</span>
                </button>
                
                <button class="tool-btn" onclick="bringToFront()" title=" Ù„Ù„Ø£Ù…Ø§Ù…">
                    â¬†ï¸
                    <span class="tool-label">Ø£Ù…Ø§Ù…</span>
                </button>
                
                <button class="tool-btn" onclick="sendToBack()" title=" Ù„Ù„Ø®Ù„Ù">
                    â¬‡ï¸
                    <span class="tool-label">Ø®Ù„Ù</span>
                </button>
                
                <button class="tool-btn" onclick="toggleVisibility()" id="visibilityBtn" title="Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø±">
                    ğŸ‘ï¸
                    <span class="tool-label">Ø¹ÙŠÙ†</span>
                </button>
                
                <button class="tool-btn" onclick="resetCanvas()" title="Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„">
                    ğŸ”„
                    <span class="tool-label">Ù…Ø³Ø­</span>
                </button>
            </div>
            
            <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ -->
            <div class="canvas-container">
                <canvas id="main-canvas"></canvas>
            </div>
            
            <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
            <div class="preview-panel">
                <div class="preview-title">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</div>
                <canvas id="preview-canvas"></canvas>
                <div style="margin-top: 10px; font-size: 0.8rem; color: #999;">
                    Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
                </div>
            </div>
        </div>
        
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠ -->
        <div class="bottom-toolbar">
            <button class="action-btn add-image-btn" onclick="addImage()">+ Ø¥Ø¶Ø§ÙØ© Ø¬Ø²Ø¡</button>
            <button class="action-btn save-btn" onclick="saveProject()">ğŸ’¾ Ø­ÙØ¸</button>
            <button class="action-btn exit-editor-btn" onclick="closeEditor()">âŒ Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© -->
    <div class="image-modal" id="imageModal">
        <div class="modal-content animate__animated animate__zoomIn">
            <h3 style="color: #d63031; margin-bottom: 15px;">Ø¥Ø¶Ø§ÙØ© Ø¬Ø²Ø¡ Ù„Ù„Ø´Ø®ØµÙŠØ©</h3>
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ“</div>
                <p>Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©</p>
                <p style="font-size: 0.8rem; color: #999; margin-top: 5px;">PNG Ù…Ø¹ Ø´ÙØ§ÙÙŠØ© ÙŠÙØ¶Ù„</p>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
            <button onclick="closeModal()" style="background: #ddd; border: none; padding: 10px 30px; border-radius: 20px; cursor: pointer;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script>
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let canvas, previewCanvas;
        let mainFabricCanvas, previewFabricCanvas;
        let isLocked = false;
        let selectedObject = null;
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¬Ø³ÙŠÙ…Ø§Øª Ù„Ù„Ø´Ø¹Ø§Ø±
        function initParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(particle);
                
                // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø¬Ø³ÙŠÙ…Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… GSAP
                gsap.to(particle, {
                    y: -100,
                    x: Math.random() * 100 - 50,
                    opacity: 0,
                    duration: 3 + Math.random() * 2,
                    repeat: -1,
                    delay: Math.random() * 2,
                    ease: "none"
                });
            }
        }
        
        // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.onload = function() {
            initParticles();
            
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
            setTimeout(() => {
                gsap.to('#splash-screen', {
                    opacity: 0,
                    duration: 0.8,
                    onComplete: () => {
                        document.getElementById('splash-screen').style.display = 'none';
                        document.getElementById('main-app').style.display = 'block';
                        
                        // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¯Ø®ÙˆÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                        gsap.from('.top-bar', { y: -100, duration: 0.6, ease: "back.out(1.7)" });
                        gsap.from('.assemble-btn', { 
                            scale: 0, 
                            rotation: 360, 
                            duration: 1, 
                            ease: "elastic.out(1, 0.5)",
                            delay: 0.3
                        });
                    }
                });
            }, 3000);
        };
        
        // ÙØªØ­ Ø§Ù„Ù…Ø­Ø±Ø±
        function openEditor() {
            const btn = document.querySelector('.assemble-btn');
            
            // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
            gsap.to(btn, {
                scale: 20,
                opacity: 0,
                duration: 0.5,
                ease: "power2.in",
                onComplete: () => {
                    document.getElementById('main-app').style.display = 'none';
                    document.getElementById('editor-interface').style.display = 'flex';
                    initCanvas();
                    
                    // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­Ø±Ø±
                    gsap.from('.controls-panel', { x: -100, duration: 0.5, ease: "power2.out" });
                    gsap.from('.preview-panel', { x: 100, duration: 0.5, ease: "power2.out" });
                    gsap.from('.editor-header', { y: -50, duration: 0.4 });
                    gsap.from('.bottom-toolbar', { y: 50, duration: 0.4 });
                }
            });
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø­Ø±Ø±
        function closeEditor() {
            gsap.to('#editor-interface', {
                opacity: 0,
                duration: 0.3,
                onComplete: () => {
                    document.getElementById('editor-interface').style.display = 'none';
                    document.getElementById('editor-interface').style.opacity = 1;
                    document.getElementById('main-app').style.display = 'block';
                    
                    gsap.from('.assemble-btn', { scale: 0, duration: 0.5, ease: "back.out(1.7)" });
                }
            });
        }
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³
        function initCanvas() {
            const container = document.querySelector('.canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            mainFabricCanvas = new fabric.Canvas('main-canvas', {
                width: width,
                height: height,
                backgroundColor: '#f8f9fa',
                preserveObjectStacking: true
            });
            
            // ÙƒØ§Ù†ÙØ§Ø³ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            previewFabricCanvas = new fabric.Canvas('preview-canvas', {
                width: 100,
                height: 150,
                backgroundColor: '#fafafa'
            });
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù„Ù…Ø³
            mainFabricCanvas.on('selection:created', function(e) {
                selectedObject = e.selected[0];
                updateLockButton();
            });
            
            mainFabricCanvas.on('selection:updated', function(e) {
                selectedObject = e.selected[0];
                updateLockButton();
            });
            
            mainFabricCanvas.on('selection:cleared', function() {
                selectedObject = null;
                document.getElementById('lockBtn').innerHTML = 'ğŸ”“<span class="tool-label">Ù‚ÙÙ„</span>';
            });
            
            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            mainFabricCanvas.on('object:modified', updatePreview);
            mainFabricCanvas.on('object:added', updatePreview);
            mainFabricCanvas.on('object:removed', updatePreview);
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ù„Ø³Ø©
            fabric.Object.prototype.set({
                transparentCorners: false,
                cornerColor: '#ff6b6b',
                cornerStrokeColor: '#fff',
                borderColor: '#ff6b6b',
                cornerSize: 12,
                padding: 10,
                cornerStyle: 'circle',
                borderDashArray: [5, 5]
            });
        }
        
        // Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©
        function addImage() {
            document.getElementById('imageModal').style.display = 'flex';
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                fabric.Image.fromURL(event.target.result, function(img) {
                    // ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø´Ø§Ø´Ø©
                    const maxSize = 200;
                    if (img.width > maxSize || img.height > maxSize) {
                        const scale = Math.min(maxSize / img.width, maxSize / img.height);
                        img.scale(scale);
                    }
                    
                    img.set({
                        left: mainFabricCanvas.width / 2 - (img.width * img.scaleX) / 2,
                        top: mainFabricCanvas.height / 2 - (img.height * img.scaleY) / 2,
                        hasControls: true,
                        hasBorders: true,
                        selectable: true
                    });
                    
                    // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø©
                    img.set({ opacity: 0, scaleX: 0, scaleY: 0 });
                    mainFabricCanvas.add(img);
                    mainFabricCanvas.setActiveObject(img);
                    
                    gsap.to(img, {
                        opacity: 1,
                        scaleX: img.scaleX || 1,
                        scaleY: img.scaleY || 1,
                        duration: 0.5,
                        ease: "back.out(1.7)",
                        onUpdate: () => mainFabricCanvas.renderAll()
                    });
                    
                    closeModal();
                    updatePreview();
                });
            };
            reader.readAsDataURL(file);
        }
        
        // Ù‚ÙÙ„/ÙØªØ­ Ø§Ù„ÙƒØ§Ø¦Ù†
        function toggleLock() {
            const activeObject = mainFabricCanvas.getActiveObject();
            if (!activeObject) {
                alert('Ø§Ø®ØªØ± Ø¬Ø²Ø¡Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            if (activeObject.selectable) {
                activeObject.set({
                    selectable: false,
                    hasControls: false,
                    hasBorders: false,
                    lockMovementX: true,
                    lockMovementY: true,
                    lockRotation: true,
                    lockScalingX: true,
                    lockScalingY: true
                });
                isLocked = true;
                
                // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ù‚ÙÙ„
                gsap.to(activeObject, {
                    opacity: 0.7,
                    duration: 0.2,
                    onUpdate: () => mainFabricCanvas.renderAll()
                });
            } else {
                activeObject.set({
                    selectable: true,
                    hasControls: true,
                    hasBorders: true,
                    lockMovementX: false,
                    lockMovementY: false,
                    lockRotation: false,
                    lockScalingX: false,
                    lockScalingY: false
                });
                isLocked = false;
                
                gsap.to(activeObject, {
                    opacity: 1,
                    duration: 0.2,
                    onUpdate: () => mainFabricCanvas.renderAll()
                });
            }
            
            mainFabricCanvas.discardActiveObject();
            mainFabricCanvas.renderAll();
            updateLockButton();
            updatePreview();
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ù‚ÙÙ„
        function updateLockButton() {
            const btn = document.getElementById('lockBtn');
            const activeObject = mainFabricCanvas.getActiveObject();
            if (activeObject && !activeObject.selectable) {
                btn.innerHTML = 'ğŸ”’<span class="tool-label">Ù…Ù‚ÙÙ„</span>';
                btn.classList.add('active');
            } else {
                btn.innerHTML = 'ğŸ”“<span class="tool-label">Ù‚ÙÙ„</span>';
                btn.classList.remove('active');
            }
        }
        
        // Ø­Ø°Ù Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø­Ø¯Ø¯
        function deleteSelected() {
            const activeObject = mainFabricCanvas.getActiveObject();
            if (!activeObject) {
                alert('Ø§Ø®ØªØ± Ø¬Ø²Ø¡Ø§Ù‹ Ù„Ù„Ø­Ø°Ù');
                return;
            }
            
            gsap.to(activeObject, {
                scaleX: 0,
                scaleY: 0,
                opacity: 0,
                duration: 0.3,
                onComplete: () => {
                    mainFabricCanvas.remove(activeObject);
                    mainFabricCanvas.renderAll();
                    updatePreview();
                },
                onUpdate: () => mainFabricCanvas.renderAll()
            });
        }
        
        // Ø¥Ø­Ø¶Ø§Ø± Ù„Ù„Ø£Ù…Ø§Ù…
        function bringToFront() {
            const activeObject = mainFabricCanvas.getActiveObject();
            if (activeObject) {
                mainFabricCanvas.bringToFront(activeObject);
                mainFabricCanvas.renderAll();
                updatePreview();
                
                // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ
                gsap.from(activeObject, {
                    shadow: '0 0 20px rgba(255,107,107,0.8)',
                    duration: 0.3
                });
            }
        }
        
        // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø®Ù„Ù
        function sendToBack() {
            const activeObject = mainFabricCanvas.getActiveObject();
            if (activeObject) {
                mainFabricCanvas.sendToBack(activeObject);
                mainFabricCanvas.renderAll();
                updatePreview();
            }
        }
        
        // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø±
        function toggleVisibility() {
            const activeObject = mainFabricCanvas.getActiveObject();
            if (!activeObject) return;
            
            const btn = document.getElementById('visibilityBtn');
            
            if (activeObject.visible) {
                activeObject.set('visible', false);
                btn.innerHTML = 'ğŸš«<span class="tool-label">Ù…Ø®ÙÙŠ</span>';
                btn.style.background = '#ddd';
            } else {
                activeObject.set('visible', true);
                btn.innerHTML = 'ğŸ‘ï¸<span class="tool-label">Ø¹ÙŠÙ†</span>';
                btn.style.background = '';
                
                gsap.from(activeObject, {
                    opacity: 0,
                    duration: 0.3,
                    onUpdate: () => mainFabricCanvas.renderAll()
                });
            }
            
            mainFabricCanvas.renderAll();
            updatePreview();
        }
        
        // Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³
        function resetCanvas() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ØŸ')) {
                const objects = mainFabricCanvas.getObjects();
                objects.forEach((obj, index) => {
                    gsap.to(obj, {
                        scaleX: 0,
                        scaleY: 0,
                        opacity: 0,
                        duration: 0.3,
                        delay: index * 0.05,
                        onComplete: () => {
                            if (index === objects.length - 1) {
                                mainFabricCanvas.clear();
                                updatePreview();
                            }
                        },
                        onUpdate: () => mainFabricCanvas.renderAll()
                    });
                });
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        function updatePreview() {
            previewFabricCanvas.clear();
            
            // Ù†Ø³Ø® Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ø¥Ù„Ù‰ ÙƒØ§Ù†ÙØ§Ø³ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            mainFabricCanvas.getObjects().forEach(obj => {
                if (obj.visible) {
                    const clone = fabric.util.object.clone(obj);
                    // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                    const scale = 0.4;
                    clone.set({
                        left: clone.left * scale + 50,
                        top: clone.top * scale + 75,
                        scaleX: clone.scaleX * scale,
                        scaleY: clone.scaleY * scale,
                        selectable: false,
                        hasControls: false,
                        hasBorders: false
                    });
                    previewFabricCanvas.add(clone);
                }
            });
            
            previewFabricCanvas.renderAll();
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        function saveProject() {
            const dataURL = mainFabricCanvas.toDataURL({
                format: 'png',
                quality: 1
            });
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„
            const link = document.createElement('a');
            link.download = 'Ø´Ø®ØµÙŠØ©-Ø§Ø³ØªÙˆØ¯ÙŠÙˆ-Ø§Ù„Ø¹Ø±Ø¨-' + Date.now() + '.png';
            link.href = dataURL;
            link.click();
            
            // ØªØ£Ø«ÙŠØ± Ù†Ø¬Ø§Ø­
            gsap.to('.save-btn', {
                scale: 1.2,
                duration: 0.2,
                yoyo: true,
                repeat: 1
            });
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }
        
        // Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        function exitApp() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ')) {
                gsap.to('body', {
                    opacity: 0,
                    duration: 0.5,
                    onComplete: () => {
                        window.close();
                        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØºÙ„Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©ØŒ Ù†Ø±Ø¬Ø¹ Ù„Ù„Ø´Ø¹Ø§Ø±
                        location.reload();
                    }
                });
            }
        }
        
        // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('dblclick', function(e) {
            e.preventDefault();
        });
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>