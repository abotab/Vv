<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿ£ŸÜŸÖŸäÿ¥ŸÜ ÿßŸÑÿπÿ±ÿ® - ÿßŸÑÿßÿ≥ÿ™ŸàÿØŸäŸà ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÅŸä ÿßŸÑŸÖÿ™ŸÉÿßŸÖŸÑ</title>
    
    <!-- ===== ÿßŸÑŸÖŸÉÿ™ÿ®ÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ===== -->
    
    <!-- 1. PixiJS v8 (ÿ£ÿ≠ÿØÿ´ ÿ•ÿµÿØÿßÿ±) -->
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@8.1.0/dist/pixi.min.js"></script>
    
    <!-- 2. Fabric.js -->
    <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
    
    <!-- 3. Konva.js -->
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    
    <!-- 4. GSAP + Plugins -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/Draggable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/MotionPathPlugin.min.js"></script>
    
    <!-- 5. Anime.js -->
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.2/lib/anime.min.js"></script>
    
    <!-- 6. Pixi-Spine (ŸÑŸÑÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ ÿßŸÑŸáŸäŸÉŸÑŸäÿ©) -->
    <script src="https://cdn.jsdelivr.net/npm/pixi-spine@4.0.4/dist/pixi-spine.js"></script>
    
    <!-- 7. DragonBones -->
    <script src="https://cdn.jsdelivr.net/npm/dragonbones/out/dragonBones.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dragonbones/out/dragonBonesPixi.min.js"></script>
    
    <!-- 8. Paper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.17/paper-full.min.js"></script>
    
    <!-- 9. p5.js -->
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.js"></script>
    
    <!-- 10. Rough.js -->
    <script src="https://cdn.jsdelivr.net/npm/roughjs@4.6.6/bundled/rough.js"></script>
    
    <!-- 11. Two.js -->
    <script src="https://cdn.jsdelivr.net/npm/two.js/build/two.min.js"></script>
    
    <!-- 12. Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    
    <!-- 13. Babylon.js -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    
    <!-- 14. Matter.js (ÿßŸÑŸÅŸäÿ≤Ÿäÿßÿ° 2D) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    
    <!-- 15. Cannon-es (ÿßŸÑŸÅŸäÿ≤Ÿäÿßÿ° 3D) -->
    <script src="https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"></script>
    
    <!-- 16. Lottie -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    
    <!-- 17. Vivus.js -->
    <script src="https://cdn.jsdelivr.net/npm/vivus@0.4.6/dist/vivus.min.js"></script>
    
    <!-- 18. Mo.js -->
    <script src="https://cdn.jsdelivr.net/npm/@mojs/core"></script>
    
    <!-- 19. Tween.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
    
    <!-- 20. Velocity.js -->
    <script src="https://cdn.jsdelivr.net/npm/velocity-animate@2.0/velocity.min.js"></script>
    
    <!-- 21. Hammer.js -->
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    
    <!-- 22. Interact.js -->
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    
    <!-- 23. CamanJS (ÿßŸÑŸÅŸÑÿßÿ™ÿ±) -->
    <script src="https://cdn.jsdelivr.net/npm/caman/dist/caman.full.min.js"></script>
    
    <!-- 24. Cropper.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.css">
    <script src="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.js"></script>
    
    <!-- 25. Chroma.js (ÿßŸÑÿ£ŸÑŸàÿßŸÜ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>
    
    <!-- 26. Color Thief -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    
    <!-- 27. Howler.js (ÿßŸÑÿµŸàÿ™) -->
    <script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>
    
    <!-- 28. Tone.js (ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ) -->
    <script src="https://cdn.jsdelivr.net/npm/tone"></script>
    
    <!-- 29. Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 30. D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- 31. Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- 32. Hover.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hover.css/2.3.1/css/hover-min.css"/>
    
    <!-- 33. Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- 34. Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Noto+Kufi+Arabic:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --accent: #8b5cf6;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f8fafc;
            --gray: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --glass: rgba(15, 23, 42, 0.8);
            --glass-border: rgba(99, 102, 241, 0.2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Tajawal', 'Noto Kufi Arabic', sans-serif;
            background: var(--darker);
            color: var(--light);
            overflow: hidden;
            height: 100vh;
            user-select: none;
        }
        
        /* ===== HEADER ===== */
        .header {
            height: 65px;
            background: linear-gradient(135deg, var(--dark) 0%, #1e293b 100%);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            position: relative;
            z-index: 1000;
            box-shadow: 0 4px 30px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 26px;
            font-weight: 900;
            background: linear-gradient(45deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .logo:hover {
            transform: scale(1.05) rotate(-2deg);
            filter: drop-shadow(0 0 20px rgba(99, 102, 241, 0.5));
        }
        
        .logo::before {
            content: 'üé¨';
            font-size: 32px;
            -webkit-text-fill-color: initial;
        }
        
        .top-menu {
            display: flex;
            gap: 10px;
        }
        
        .menu-btn {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--glass-border);
            color: var(--light);
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .menu-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .menu-btn:hover::before {
            left: 100%;
        }
        
        .menu-btn:hover {
            background: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
            border-color: var(--primary);
        }
        
        .menu-btn.active {
            background: var(--primary);
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.6);
        }
        
        .menu-btn i {
            font-size: 16px;
        }
        
        /* ===== MAIN LAYOUT ===== */
        .main-container {
            display: flex;
            height: calc(100vh - 65px);
            position: relative;
        }
        
        /* ===== LEFT TOOLBAR ===== */
        .toolbar {
            width: 300px;
            background: linear-gradient(180deg, var(--dark) 0%, var(--darker) 100%);
            border-left: 1px solid var(--glass-border);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }
        
        .toolbar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
        }
        
        .tool-section {
            background: var(--glass);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .tool-section::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tool-section:hover::after {
            opacity: 1;
        }
        
        .tool-section:hover {
            border-color: rgba(99, 102, 241, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.1);
        }
        
        .section-title {
            font-size: 13px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            position: relative;
            z-index: 1;
        }
        
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            position: relative;
            z-index: 1;
        }
        
        .tool-btn-small {
            aspect-ratio: 1;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            color: var(--light);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            position: relative;
            overflow: hidden;
        }
        
        .tool-btn-small::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, var(--primary) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tool-btn-small:hover::before {
            opacity: 0.3;
        }
        
        .tool-btn-small:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
            border-color: var(--primary);
        }
        
        .tool-btn-small.active {
            background: var(--primary);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.6);
            transform: scale(1.1);
        }
        
        .tool-btn-small i {
            position: relative;
            z-index: 1;
        }
        
        /* Color System */
        .color-system {
            position: relative;
            z-index: 1;
        }
        
        .color-palette {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .color-btn {
            aspect-ratio: 1;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .color-btn:hover {
            transform: scale(1.3);
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        .color-btn.active {
            border-color: white;
            box-shadow: 0 0 0 3px var(--primary), 0 5px 15px rgba(0,0,0,0.3);
            transform: scale(1.2);
        }
        
        .color-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .custom-color-wrapper {
            flex: 1;
            position: relative;
            height: 40px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .custom-color {
            width: 100%;
            height: 100%;
            border: none;
            cursor: pointer;
            padding: 0;
        }
        
        .color-info {
            font-size: 11px;
            color: #94a3b8;
            text-align: center;
            margin-top: 8px;
            font-family: monospace;
        }
        
        /* Brush Settings */
        .brush-settings {
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
            z-index: 1;
        }
        
        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            font-weight: 500;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            margin-right: 10px;
        }
        
        .slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 3px;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.8);
            transition: transform 0.2s;
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.3);
        }
        
        .value-display {
            min-width: 35px;
            text-align: center;
            background: rgba(99, 102, 241, 0.2);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
        }
        
        /* Layers System */
        .layers-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .layer-action-btn {
            flex: 1;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--light);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .layer-action-btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }
        
        .layers-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .layer-item {
            background: rgba(99, 102, 241, 0.05);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .layer-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary);
            opacity: 0;
            transition: opacity 0.3s;
            border-radius: 10px 0 0 10px;
        }
        
        .layer-item:hover {
            background: rgba(99, 102, 241, 0.15);
            transform: translateX(-5px);
        }
        
        .layer-item.active {
            background: rgba(99, 102, 241, 0.25);
            border-color: var(--primary);
        }
        
        .layer-item.active::before {
            opacity: 1;
        }
        
        .layer-thumb {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-radius: 6px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .layer-info {
            flex: 1;
        }
        
        .layer-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .layer-meta {
            font-size: 10px;
            color: #64748b;
        }
        
        .layer-controls {
            display: flex;
            gap: 5px;
        }
        
        .layer-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .layer-btn:hover {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
        }
        
        /* ===== CANVAS AREA ===== */
        .canvas-wrapper {
            flex: 1;
            position: relative;
            background: 
                linear-gradient(45deg, #0f172a 25%, transparent 25%), 
                linear-gradient(-45deg, #0f172a 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #0f172a 75%), 
                linear-gradient(-45deg, transparent 75%, #0f172a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #1e293b;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .canvas-container {
            position: relative;
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
            border-radius: 4px;
            overflow: hidden;
        }
        
        #mainCanvas {
            background: white;
            display: block;
            cursor: crosshair;
        }
        
        .canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        
        /* Rulers */
        .ruler-h, .ruler-v {
            position: absolute;
            background: var(--dark);
            z-index: 100;
        }
        
        .ruler-h {
            top: -20px;
            left: 0;
            right: 0;
            height: 20px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .ruler-v {
            left: -20px;
            top: 0;
            bottom: 0;
            width: 20px;
            border-right: 1px solid var(--glass-border);
        }
        
        /* ===== TIMELINE ===== */
        .timeline-wrapper {
            position: absolute;
            bottom: 0;
            left: 300px;
            right: 300px;
            height: 180px;
            background: linear-gradient(180deg, var(--dark) 0%, var(--darker) 100%);
            border-top: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            z-index: 100;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        
        .timeline-header {
            height: 45px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(15, 23, 42, 0.5);
        }
        
        .timeline-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .control-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .control-btn:hover {
            background: var(--primary);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }
        
        .play-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.5);
            transition: all 0.3s;
        }
        
        .play-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.7);
        }
        
        .timeline-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }
        
        .frame-display {
            font-family: 'Courier New', monospace;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }
        
        .time-display {
            font-size: 12px;
            color: #64748b;
        }
        
        .timeline-slider-container {
            flex: 1;
            height: 40px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 20px;
            position: relative;
            margin: 0 10px;
            overflow: hidden;
        }
        
        .timeline-track {
            position: absolute;
            top: 50%;
            left: 10px;
            right: 10px;
            height: 4px;
            background: rgba(99, 102, 241, 0.3);
            transform: translateY(-50%);
            border-radius: 2px;
        }
        
        .timeline-progress {
            position: absolute;
            top: 50%;
            left: 10px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transform: translateY(-50%);
            width: 0%;
            border-radius: 2px;
            transition: width 0.1s;
        }
        
        .timeline-handle {
            position: absolute;
            top: 50%;
            left: 10px;
            width: 24px;
            height: 24px;
            background: white;
            border: 4px solid var(--primary);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.8);
            z-index: 10;
            transition: transform 0.2s;
        }
        
        .timeline-handle:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.3);
        }
        
        .keyframe-markers {
            position: absolute;
            top: 0;
            left: 10px;
            right: 10px;
            height: 100%;
            pointer-events: none;
        }
        
        .keyframe-marker {
            position: absolute;
            top: 50%;
            width: 12px;
            height: 12px;
            background: var(--secondary);
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%) translateY(-15px);
            box-shadow: 0 2px 8px rgba(236, 72, 153, 0.6);
        }
        
        .timeline-tools {
            display: flex;
            gap: 10px;
        }
        
        .timeline-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 10px;
            overflow: hidden;
        }
        
        .layers-timeline {
            display: flex;
            flex-direction: column;
            gap: 5px;
            overflow-y: auto;
        }
        
        .layer-timeline {
            height: 30px;
            background: rgba(99, 102, 241, 0.05);
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 10px;
            border: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        .layer-timeline-name {
            font-size: 11px;
            width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .layer-frames {
            flex: 1;
            height: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        
        .frame-block {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 3px;
            opacity: 0.7;
        }
        
        .frames-strip {
            height: 60px;
            display: flex;
            gap: 5px;
            overflow-x: auto;
            padding: 5px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        
        .frame-thumb {
            min-width: 90px;
            height: 50px;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .frame-thumb:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .frame-thumb.active {
            border-color: var(--secondary);
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.5);
        }
        
        .frame-thumb::after {
            content: attr(data-frame);
            position: absolute;
            bottom: 3px;
            right: 5px;
            font-size: 10px;
            color: white;
            background: rgba(0,0,0,0.6);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        /* ===== RIGHT PROPERTIES PANEL ===== */
        .properties-panel {
            width: 300px;
            background: linear-gradient(180deg, var(--dark) 0%, var(--darker) 100%);
            border-right: 1px solid var(--glass-border);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .prop-group {
            margin-bottom: 5px;
        }
        
        .prop-label {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }
        
        .prop-input, .prop-select {
            width: 100%;
            padding: 10px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 10px;
            color: var(--light);
            font-family: inherit;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .prop-input:focus, .prop-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
            background: rgba(99, 102, 241, 0.15);
        }
        
        .transform-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .checkbox-wrapper:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .custom-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .custom-checkbox.checked {
            background: var(--primary);
        }
        
        .custom-checkbox i {
            font-size: 12px;
            color: white;
            opacity: 0;
        }
        
        .custom-checkbox.checked i {
            opacity: 1;
        }
        
        /* Physics Panel */
        .physics-canvas {
            width: 100%;
            height: 150px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }
        
        /* Effects Panel */
        .effects-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .effect-btn {
            padding: 12px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 10px;
            color: var(--light);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .effect-btn:hover {
            background: var(--primary);
            transform: translateY(-3px);
        }
        
        .effect-btn i {
            font-size: 20px;
        }
        
        /* ===== MODALS & MENUS ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }
        
        .modal-content {
            background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 100%);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0,0,0,0.7);
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s;
        }
        
        .modal-overlay.show .modal-content {
            transform: scale(1) translateY(0);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .modal-title {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #64748b;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            transform: rotate(90deg);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 700;
            font-size: 15px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.5);
        }
        
        .btn-secondary {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--glass-border);
            color: var(--light);
            padding: 14px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--primary);
        }
        
        /* Export Menu */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 70px;
            right: 20px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 15px;
            min-width: 250px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            backdrop-filter: blur(20px);
            z-index: 1001;
            transform: translateY(-10px);
            opacity: 0;
            transition: all 0.3s;
        }
        
        .dropdown-menu.show {
            display: block;
            transform: translateY(0);
            opacity: 1;
        }
        
        .dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }
        
        .dropdown-item:hover {
            background: rgba(99, 102, 241, 0.2);
            transform: translateX(-5px);
        }
        
        .dropdown-item i {
            width: 24px;
            text-align: center;
            color: var(--primary);
        }
        
        .dropdown-divider {
            height: 1px;
            background: var(--glass-border);
            margin: 10px 0;
        }
        
        /* ===== TABS SYSTEM ===== */
        .tabs-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 10px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            position: relative;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: var(--primary);
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -11px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 3px 3px 0 0;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== LOADING SCREEN ===== */
        .loader-container {
            position: fixed;
            inset: 0;
            background: var(--darker);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s, visibility 0.5s;
        }
        
        .loader-container.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .loader-animation {
            width: 120px;
            height: 120px;
            position: relative;
        }
        
        .loader-circle {
            position: absolute;
            inset: 0;
            border: 4px solid transparent;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loader-circle:nth-child(2) {
            inset: 10px;
            border-top-color: var(--secondary);
            animation-duration: 1.5s;
            animation-direction: reverse;
        }
        
        .loader-circle:nth-child(3) {
            inset: 20px;
            border-top-color: var(--accent);
            animation-duration: 2s;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loader-text {
            margin-top: 30px;
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .loader-subtext {
            margin-top: 10px;
            font-size: 14px;
            color: #64748b;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--darker);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }
        
        /* ===== UTILITIES ===== */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .grid { display: grid; }
        .gap-10 { gap: 10px; }
        .mt-10 { margin-top: 10px; }
        .mb-10 { margin-bottom: 10px; }
        .w-full { width: 100%; }
        
        /* Responsive */
        @media (max-width: 1400px) {
            .toolbar, .properties-panel { width: 280px; }
            .timeline-wrapper { left: 280px; right: 280px; }
        }
        
        @media (max-width: 1200px) {
            .toolbar, .properties-panel { width: 260px; }
            .timeline-wrapper { left: 260px; right: 260px; }
        }
        
        /* Animations */
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(0); }
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div class="loader-container" id="loader">
        <div class="loader-animation">
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
        </div>
        <div class="loader-text">ÿ£ŸÜŸÖŸäÿ¥ŸÜ ÿßŸÑÿπÿ±ÿ®</div>
        <div class="loader-subtext">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÉÿ™ÿ®ÿßÿ™ ŸàÿßŸÑŸÖÿ≠ÿ±ŸÉÿßÿ™...</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="logo" onclick="showWelcome()">
            ÿ£ŸÜŸÖŸäÿ¥ŸÜ ÿßŸÑÿπÿ±ÿ®
        </div>
        
        <div class="top-menu">
            <button class="menu-btn" onclick="showNewProjectModal()">
                <i class="fas fa-plus"></i>
                ŸÖÿ¥ÿ±Ÿàÿπ ÿ¨ÿØŸäÿØ
            </button>
            <button class="menu-btn" onclick="saveProject()">
                <i class="fas fa-save"></i>
                ÿ≠ŸÅÿ∏
            </button>
            <button class="menu-btn" onclick="toggleExportMenu()">
                <i class="fas fa-file-export"></i>
                ÿ™ÿµÿØŸäÿ±
            </button>
            <button class="menu-btn" onclick="toggleRiggingPanel()">
                <i class="fas fa-bone"></i>
                ÿßŸÑÿ™ÿ±ŸÉŸäÿ®
            </button>
            <button class="menu-btn" onclick="togglePhysicsPanel()">
                <i class="fas fa-atom"></i>
                ÿßŸÑŸÅŸäÿ≤Ÿäÿßÿ°
            </button>
        </div>
    </header>

    <!-- Export Dropdown -->
    <div class="dropdown-menu" id="exportMenu">
        <div class="dropdown-item" onclick="exportAnimation('mp4')">
            <i class="fas fa-video"></i>
            <div>
                <div>ŸÅŸäÿØŸäŸà MP4</div>
                <small style="color: #64748b; font-size: 11px;">ÿ¨ŸàÿØÿ© ÿπÿßŸÑŸäÿ©</small>
            </div>
        </div>
        <div class="dropdown-item" onclick="exportAnimation('gif')">
            <i class="fas fa-image"></i>
            <div>
                <div>ÿµŸàÿ±ÿ© GIF</div>
                <small style="color: #64748b; font-size: 11px;">ŸÑŸÑŸÖŸàÿßŸÇÿπ</small>
            </div>
        </div>
        <div class="dropdown-item" onclick="exportAnimation('webm')">
            <i class="fas fa-globe"></i>
            <div>
                <div>WebM</div>
                <small style="color: #64748b; font-size: 11px;">ŸÑŸÑŸàŸäÿ®</small>
            </div>
        </div>
        <div class="dropdown-divider"></div>
        <div class="dropdown-item" onclick="exportAnimation('png')">
            <i class="fas fa-images"></i>
            <div>
                <div>ÿ•ÿ∑ÿßÿ±ÿßÿ™ PNG</div>
                <small style="color: #64748b; font-size: 11px;">ÿµŸàÿ± ŸÖŸÜŸÅÿµŸÑÿ©</small>
            </div>
        </div>
        <div class="dropdown-item" onclick="exportAnimation('json')">
            <i class="fas fa-code"></i>
            <div>
                <div>ŸÖÿ¥ÿ±Ÿàÿπ JSON</div>
                <small style="color: #64748b; font-size: 11px;">ŸÑŸÑÿ≠ŸÅÿ∏</small>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        
        <!-- Left Toolbar -->
        <aside class="toolbar">
            
            <!-- Drawing Tools -->
            <div class="tool-section">
                <div class="section-title">
                    <i class="fas fa-paint-brush"></i>
                    ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ±ÿ≥ŸÖ
                </div>
                <div class="tools-grid">
                    <button class="tool-btn-small active" onclick="setTool('brush')" title="ŸÅÿ±ÿ¥ÿßÿ© (B)">
                        <i class="fas fa-paint-brush"></i>
                    </button>
                    <button class="tool-btn-small" onclick="setTool('pencil')" title="ŸÇŸÑŸÖ ÿ±ÿµÿßÿµ (P)">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                    <button class="tool-btn-small" onclick="setTool('eraser')" title="ŸÖŸÖÿ≠ÿßÿ© (E)">
                        <i class="fas fa-eraser"></i>
                    </button>
                    <button class="tool-btn-small" onclick="setTool('fill')" title="ÿ™ÿπÿ®ÿ¶ÿ© (F)">
                        <i class="fas fa-fill-drip"></i>
                    </button>
                    <button class="tool-btn-small" onclick="setTool('picker')" title="ŸÇÿ∑ÿßÿ±ÿ© (I)">
                        <i class="fas fa-eye-dropper"></i>
                    </button>
                    <button class="tool-btn-small" onclick="setTool('text')" title="ŸÜÿµ (T)">
                        <i class="fas fa-font"></i>
                    </button>
                    <button class="tool-btn-small" onclick="setTool('shapes')" title="ÿ£ÿ¥ŸÉÿßŸÑ (S)">
                        <i class="fas fa-shapes"></i>
                    </button>
                    <button class="tool-btn-small" onclick="setTool('select')" title="ÿ™ÿ≠ÿØŸäÿØ (V)">
                        <i class="fas fa-mouse-pointer"></i>
                    </button>
                </div>
            </div>

            <!-- Color System -->
            <div class="tool-section">
                <div class="section-title">
                    <i class="fas fa-palette"></i>
                    ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ£ŸÑŸàÿßŸÜ
                </div>
                <div class="color-system">
                    <div class="color-palette" id="colorPalette"></div>
                    <div class="color-controls">
                        <div class="custom-color-wrapper">
                            <input type="color" class="custom-color" id="customColor" value="#6366f1" onchange="updateCustomColor(this.value)">
                        </div>
                        <button class="layer-btn" onclick="generateRandomPalette()" title="ŸÑŸàÿ≠ÿ© ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©">
                            <i class="fas fa-dice"></i>
                        </button>
                        <button class="layer-btn" onclick="extractColorsFromImage()" title="ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ŸÖŸÜ ÿµŸàÿ±ÿ©">
                            <i class="fas fa-file-image"></i>
                        </button>
                    </div>
                    <div class="color-info" id="colorInfo">#6366f1 | RGB(99, 102, 241)</div>
                </div>
            </div>

            <!-- Brush Settings -->
            <div class="tool-section">
                <div class="section-title">
                    <i class="fas fa-sliders-h"></i>
                    ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÅÿ±ÿ¥ÿßÿ©
                </div>
                <div class="brush-settings">
                    <div class="setting-row">
                        <span>ÿßŸÑÿ≠ÿ¨ŸÖ</span>
                        <div class="slider-container">
                            <input type="range" class="slider" id="brushSize" min="1" max="200" value="5" oninput="updateBrushSetting('size', this.value)">
                            <span class="value-display" id="sizeValue">5</span>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span>ÿßŸÑÿ¥ŸÅÿßŸÅŸäÿ©</span>
                        <div class="slider-container">
                            <input type="range" class="slider" id="brushOpacity" min="0" max="100" value="100" oninput="updateBrushSetting('opacity', this.value)">
                            <span class="value-display" id="opacityValue">100%</span>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span>ÿßŸÑÿ™ŸÜÿπŸäŸÖ</span>
                        <div class="slider-container">
                            <input type="range" class="slider" id="brushSmoothing" min="0" max="100" value="50" oninput="updateBrushSetting('smoothing', this.value)">
                            <span class="value-display" id="smoothingValue">50%</span>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span>ÿßŸÑÿ™ÿ¥ÿ™ÿ™</span>
                        <div class="slider-container">
                            <input type="range" class="slider" id="brushScatter" min="0" max="100" value="0" oninput="updateBrushSetting('scatter', this.value)">
                            <span class="value-display" id="scatterValue">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Layers System -->
            <div class="tool-section">
                <div class="section-title">
                    <i class="fas fa-layer-group"></i>
                    ÿßŸÑÿ∑ÿ®ŸÇÿßÿ™
                </div>
                <div class="layers-controls">
                    <button class="layer-action-btn" onclick="addLayer()">
                        <i class="fas fa-plus"></i> ÿ¨ÿØŸäÿØ
                    </button>
                    <button class="layer-action-btn" onclick="duplicateLayer()">
                        <i class="fas fa-copy"></i> ŸÜÿ≥ÿÆ
                    </button>
                    <button class="layer-action-btn" onclick="mergeLayers()">
                        <i class="fas fa-compress"></i> ÿØŸÖÿ¨
                    </button>
                </div>
                <div class="layers-list" id="layersList"></div>
            </div>

            <!-- Animation Tools -->
            <div class="tool-section">
                <div class="section-title">
                    <i class="fas fa-film"></i>
                    ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÉ
                </div>
                <div class="tools-grid">
                    <button class="tool-btn-small" onclick="setTool('bone')" title="ŸáŸäŸÉŸÑ ÿπÿ∏ŸÖŸä">
                        <i class="fas fa-bone"></i>
                    </button>
                    <button class="tool-btn-small" onclick="setTool('keyframe')" title="ÿ•ÿ∑ÿßÿ± ŸÖŸÅÿ™ÿßÿ≠Ÿä">
                        <i class="fas fa-key"></i>
                    </button>
                    <button class="tool-btn-small" onclick="toggleOnionSkin()" title="ÿ¨ŸÑÿØÿ© ÿßŸÑÿ®ÿµŸÑ">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="tool-btn-small" onclick="setTool('motion')" title="ŸÖÿ≥ÿßÿ± ÿßŸÑÿ≠ÿ±ŸÉÿ©">
                        <i class="fas fa-bezier-curve"></i>
                    </button>
                </div>
            </div>

        </aside>

        <!-- Canvas Area -->
        <main class="canvas-wrapper">
            <div class="canvas-container" id="canvasContainer">
                <div class="ruler-h"></div>
                <div class="ruler-v"></div>
                <canvas id="mainCanvas" width="1000" height="700"></canvas>
                <canvas id="overlayCanvas" class="canvas-overlay" width="1000" height="700"></canvas>
                <div id="pixiContainer" style="position: absolute; top: 0; left: 0; pointer-events: none;"></div>
            </div>
            
            <!-- Timeline -->
            <div class="timeline-wrapper">
                <div class="timeline-header">
                    <div class="timeline-controls">
                        <button class="control-btn" onclick="goToFirstFrame()" title="ÿßŸÑÿ®ÿØÿßŸäÿ©">
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button class="play-btn" id="playBtn" onclick="togglePlayback()">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="control-btn" onclick="goToLastFrame()" title="ÿßŸÑŸÜŸáÿßŸäÿ©">
                            <i class="fas fa-step-forward"></i>
                        </button>
                    </div>
                    
                    <div class="timeline-info">
                        <div class="frame-display" id="frameDisplay">000</div>
                        <div class="time-display" id="timeDisplay">00:00:00</div>
                    </div>
                    
                    <div class="timeline-slider-container" id="timelineSlider">
                        <div class="timeline-track"></div>
                        <div class="timeline-progress" id="timelineProgress"></div>
                        <div class="keyframe-markers" id="keyframeMarkers"></div>
                        <div class="timeline-handle" id="timelineHandle"></div>
                    </div>
                    
                    <div class="timeline-tools">
                        <button class="control-btn" onclick="addKeyframe()" title="ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ∑ÿßÿ± ŸÖŸÅÿ™ÿßÿ≠Ÿä">
                            <i class="fas fa-diamond"></i>
                        </button>
                        <button class="control-btn" onclick="toggleLoop()" title="ÿ™ŸÉÿ±ÿßÿ±">
                            <i class="fas fa-sync-alt" id="loopIcon"></i>
                        </button>
                        <select class="prop-select" style="width: 80px;" onchange="changeFPS(this.value)">
                            <option value="12">12 FPS</option>
                            <option value="24" selected>24 FPS</option>
                            <option value="30">30 FPS</option>
                            <option value="60">60 FPS</option>
                        </select>
                    </div>
                </div>
                
                <div class="timeline-body">
                    <div class="layers-timeline" id="layersTimeline"></div>
                    <div class="frames-strip" id="framesStrip"></div>
                </div>
            </div>
        </main>

        <!-- Right Properties Panel -->
        <aside class="properties-panel">
            
            <!-- Tabs -->
            <div class="tabs-container">
                <button class="tab-btn active" onclick="switchTab('transform')">ÿ™ÿ≠ŸàŸäŸÑ</button>
                <button class="tab-btn" onclick="switchTab('appearance')">ŸÖÿ∏Ÿáÿ±</button>
                <button class="tab-btn" onclick="switchTab('effects')">ÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™</button>
                <button class="tab-btn" onclick="switchTab('physics')">ŸÅŸäÿ≤Ÿäÿßÿ°</button>
            </div>

            <!-- Transform Tab -->
            <div class="tab-content active" id="transformTab">
                <div class="tool-section">
                    <div class="section-title">
                        <i class="fas fa-arrows-alt"></i>
                        ÿßŸÑÿ™ÿ≠ŸàŸäŸÑÿßÿ™
                    </div>
                    <div class="transform-grid">
                        <div class="prop-group">
                            <label class="prop-label">ÿßŸÑŸÖŸàŸÇÿπ X</label>
                            <input type="number" class="prop-input" id="posX" value="0" onchange="updateTransform('x', this.value)">
                        </div>
                        <div class="prop-group">
                            <label class="prop-label">ÿßŸÑŸÖŸàŸÇÿπ Y</label>
                            <input type="number" class="prop-input" id="posY" value="0" onchange="updateTransform('y', this.value)">
                        </div>
                        <div class="prop-group">
                            <label class="prop-label">ÿßŸÑÿπÿ±ÿ∂</label>
                            <input type="number" class="prop-input" id="scaleX" value="100" onchange="updateTransform('width', this.value)">
                        </div>
                        <div class="prop-group">
                            <label class="prop-label">ÿßŸÑÿßÿ±ÿ™ŸÅÿßÿπ</label>
                            <input type="number" class="prop-input" id="scaleY" value="100" onchange="updateTransform('height', this.value)">
                        </div>
                        <div class="prop-group">
                            <label class="prop-label">ÿßŸÑÿ™ÿØŸàŸäÿ±</label>
                            <input type="number" class="prop-input" id="rotation" value="0" onchange="updateTransform('rotation', this.value)">
                        </div>
                        <div class="prop-group">
                            <label class="prop-label">ÿßŸÑÿ¥ŸÅÿßŸÅŸäÿ©</label>
                            <input type="number" class="prop-input" id="alpha" value="100" min="0" max="100" onchange="updateTransform('alpha', this.value)">
                        </div>
                    </div>
                    
                    <div class="checkbox-wrapper" onclick="toggleLockRatio()">
                        <div class="custom-checkbox checked" id="lockRatio">
                            <i class="fas fa-check"></i>
                        </div>
                        <span>ŸÇŸÅŸÑ ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿπÿ±ÿ∂ ŸÑŸÑÿßÿ±ÿ™ŸÅÿßÿπ</span>
                    </div>
                </div>
            </div>

            <!-- Appearance Tab -->
            <div class="tab-content" id="appearanceTab">
                <div class="tool-section">
                    <div class="section-title">
                        <i class="fas fa-paint-brush"></i>
                        ÿßŸÑŸÖÿ∏Ÿáÿ±
                    </div>
                    <div class="prop-group">
                        <label class="prop-label">ŸÜŸÖÿ∑ ÿßŸÑÿØŸÖÿ¨</label>
                        <select class="prop-select" onchange="updateBlendMode(this.value)">
                            <option value="normal">ÿπÿßÿØŸä</option>
                            <option value="multiply">ÿ∂ÿ±ÿ®</option>
                            <option value="screen">ÿ¥ÿßÿ¥ÿ©</option>
                            <option value="overlay">ÿ™ÿ±ÿßŸÉÿ®</option>
                            <option value="darken">ÿ™ÿπÿ™ŸäŸÖ</option>
                            <option value="lighten">ÿ™ŸÅÿ™Ÿäÿ≠</option>
                            <option value="difference">ÿßÿÆÿ™ŸÑÿßŸÅ</option>
                        </select>
                    </div>
                    <div class="prop-group">
                        <label class="prop-label">ÿßŸÑÿ™ÿπÿ™ŸäŸÖ</label>
                        <input type="range" class="slider w-full" min="0" max="100" value="100">
                    </div>
                </div>
            </div>

            <!-- Effects Tab -->
            <div class="tab-content" id="effectsTab">
                <div class="tool-section">
                    <div class="section-title">
                        <i class="fas fa-magic"></i>
                        ÿßŸÑÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ÿßŸÑÿ≥ÿ±Ÿäÿπÿ©
                    </div>
                    <div class="effects-grid">
                        <button class="effect-btn" onclick="applyEffect('blur')">
                            <i class="fas fa-tint"></i>
                            <span>ÿ∂ÿ®ÿßÿ®Ÿäÿ©</span>
                        </button>
                        <button class="effect-btn" onclick="applyEffect('glow')">
                            <i class="fas fa-sun"></i>
                            <span>ÿ™ŸàŸáÿ¨</span>
                        </button>
                        <button class="effect-btn" onclick="applyEffect('shadow')">
                            <i class="fas fa-cloud"></i>
                            <span>ÿ∏ŸÑ</span>
                        </button>
                        <button class="effect-btn" onclick="applyEffect('pixelate')">
                            <i class="fas fa-border-all"></i>
                            <span>ÿ®ŸÉÿ≥ŸÑÿ©</span>
                        </button>
                        <button class="effect-btn" onclick="applyEffect('noise')">
                            <i class="fas fa-snowflake"></i>
                            <span>ÿ∂ÿ¨Ÿäÿ¨</span>
                        </button>
                        <button class="effect-btn" onclick="applyEffect('ripple')">
                            <i class="fas fa-water"></i>
                            <span>ÿ™ŸÖŸàÿ¨</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Physics Tab -->
            <div class="tab-content" id="physicsTab">
                <div class="tool-section">
                    <div class="section-title">
                        <i class="fas fa-atom"></i>
                        ÿßŸÑŸÅŸäÿ≤Ÿäÿßÿ°
                    </div>
                    <div class="prop-group">
                        <label class="prop-label">ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÅŸäÿ≤Ÿäÿßÿ°</label>
                        <div class="checkbox-wrapper" onclick="togglePhysics()">
                            <div class="custom-checkbox" id="physicsEnabled">
                                <i class="fas fa-check"></i>
                            </div>
                            <span>ÿ™ŸÅÿπŸäŸÑ Matter.js</span>
                        </div>
                    </div>
                    <div class="prop-group">
                        <label class="prop-label">ÿßŸÑÿ¨ÿßÿ∞ÿ®Ÿäÿ©</label>
                        <input type="range" class="slider w-full" id="gravity" min="0" max="20" value="10" onchange="updateGravity(this.value)">
                    </div>
                    <div class="prop-group">
                        <label class="prop-label">ÿßŸÑŸÖÿ±ŸàŸÜÿ©</label>
                        <input type="range" class="slider w-full" id="restitution" min="0" max="100" value="50">
                    </div>
                    <div class="physics-canvas" id="physicsPreview">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #64748b;">
                            ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÅŸäÿ≤Ÿäÿßÿ°
                        </div>
                    </div>
                    <button class="btn-primary" onclick="addPhysicsBody()">
                        <i class="fas fa-plus"></i>
                        ÿ•ÿ∂ÿßŸÅÿ© ÿ¨ÿ≥ŸÖ ŸÅŸäÿ≤Ÿäÿßÿ¶Ÿä
                    </button>
                </div>
            </div>

            <!-- Rigging Panel (Hidden by default) -->
            <div class="tool-section hidden" id="riggingSection">
                <div class="section-title">
                    <i class="fas fa-bone"></i>
                    ÿßŸÑÿ™ÿ±ŸÉŸäÿ® ÿßŸÑÿπÿ∏ŸÖŸä
                </div>
                <div class="prop-group">
                    <label class="prop-label">Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ±ŸÉŸäÿ®</label>
                    <select class="prop-select" id="rigMode" onchange="changeRigMode(this.value)">
                        <option value="manual">ŸäÿØŸàŸä</option>
                        <option value="auto">ÿ™ŸÑŸÇÿßÿ¶Ÿä (AI)</option>
                        <option value="spine">Spine</option>
                        <option value="dragonbones">DragonBones</option>
                    </select>
                </div>
                <div class="physics-canvas" id="riggingPreview">
                    <canvas id="boneCanvas" width="260" height="150"></canvas>
                </div>
                <div class="layers-controls">
                    <button class="layer-action-btn" onclick="createBone()">
                        <i class="fas fa-plus"></i> ÿπÿ∏ŸÖ
                    </button>
                    <button class="layer-action-btn" onclick="autoRig()">
                        <i class="fas fa-magic"></i> ÿ™ŸÑŸÇÿßÿ¶Ÿä
                    </button>
                </div>
            </div>

            <!-- Animation Settings -->
            <div class="tool-section">
                <div class="section-title">
                    <i class="fas fa-cog"></i>
                    ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ¥ŸáÿØ
                </div>
                <div class="prop-group">
                    <label class="prop-label">ŸÖÿØÿ© ÿßŸÑŸÖÿ¥ŸáÿØ (ÿ´ŸàÿßŸÜŸä)</label>
                    <input type="number" class="prop-input" id="sceneDuration" value="5" min="1" max="300" onchange="updateDuration(this.value)">
                </div>
                <div class="prop-group">
                    <label class="prop-label">ÿßŸÑÿ£ÿ®ÿπÿßÿØ</label>
                    <div class="transform-grid">
                        <input type="number" class="prop-input" id="sceneWidth" value="1000" readonly>
                        <input type="number" class="prop-input" id="sceneHeight" value="700" readonly>
                    </div>
                </div>
                <div class="checkbox-wrapper" onclick="toggleSound()">
                    <div class="custom-checkbox" id="soundEnabled">
                        <i class="fas fa-check"></i>
                    </div>
                    <span>ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿµŸàÿ™ (Tone.js)</span>
                </div>
            </div>

        </aside>
    </div>

    <!-- New Project Modal -->
    <div class="modal-overlay" id="newProjectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ŸÖÿ¥ÿ±Ÿàÿπ ÿ¨ÿØŸäÿØ</h2>
                <button class="close-btn" onclick="closeModal('newProjectModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="prop-group">
                <label class="prop-label">ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</label>
                <input type="text" class="prop-input" id="newProjectName" placeholder="ŸÖÿ¥ÿ±ŸàÿπŸä ÿßŸÑÿ±ÿßÿ¶ÿπ" value="ŸÖÿ¥ÿ±Ÿàÿπ ÿ¨ÿØŸäÿØ">
            </div>
            
            <div class="prop-group">
                <label class="prop-label">ÿßŸÑŸÇŸàÿßŸÑÿ® ÿßŸÑÿ¨ÿßŸáÿ≤ÿ©</label>
                <div class="effects-grid">
                    <button class="effect-btn" onclick="setTemplate('hd')">
                        <i class="fas fa-tv"></i>
                        <span>HD 1920x1080</span>
                    </button>
                    <button class="effect-btn" onclick="setTemplate('social')">
                        <i class="fas fa-mobile-alt"></i>
                        <span>ÿ≥Ÿàÿ¥ŸäÿßŸÑ 1080x1920</span>
                    </button>
                    <button class="effect-btn" onclick="setTemplate('square')">
                        <i class="fas fa-square"></i>
                        <span>ŸÖÿ±ÿ®ÿπ 1080x1080</span>
                    </button>
                    <button class="effect-btn" onclick="setTemplate('custom')">
                        <i class="fas fa-cog"></i>
                        <span>ŸÖÿÆÿµÿµ</span>
                    </button>
                </div>
            </div>
            
            <div class="transform-grid">
                <div class="prop-group">
                    <label class="prop-label">ÿßŸÑÿπÿ±ÿ∂ (ÿ®ŸÉÿ≥ŸÑ)</label>
                    <input type="number" class="prop-input" id="newWidth" value="1000" min="100" max="8000">
                </div>
                <div class="prop-group">
                    <label class="prop-label">ÿßŸÑÿßÿ±ÿ™ŸÅÿßÿπ (ÿ®ŸÉÿ≥ŸÑ)</label>
                    <input type="number" class="prop-input" id="newHeight" value="700" min="100" max="8000">
                </div>
            </div>
            
            <div class="prop-group">
                <label class="prop-label">ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©</label>
                <select class="prop-select" id="bgType">
                    <option value="white">ÿ£ÿ®Ÿäÿ∂</option>
                    <option value="transparent">ÿ¥ŸÅÿßŸÅ</option>
                    <option value="grid">ÿ¥ÿ®ŸÉÿ©</option>
                    <option value="dark">ÿØÿßŸÉŸÜ</option>
                </select>
            </div>
            
            <div class="prop-group">
                <label class="prop-label">ŸÖÿπÿØŸÑ ÿßŸÑÿ•ÿ∑ÿßÿ±ÿßÿ™</label>
                <select class="prop-select" id="newFPS">
                    <option value="12">12 FPS</option>
                    <option value="24" selected>24 FPS</option>
                    <option value="30">30 FPS</option>
                    <option value="60">60 FPS</option>
                </select>
            </div>
            
            <button class="btn-primary" onclick="createNewProject()">
                <i class="fas fa-rocket"></i>
                ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ
            </button>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ===== GLOBAL VARIABLES & STATE =====
        const AppState = {
            canvas: null,
            ctx: null,
            fabricCanvas: null,
            pixiApp: null,
            konvaStage: null,
            konvaLayer: null,
            threeScene: null,
            threeCamera: null,
            threeRenderer: null,
            matterEngine: null,
            currentTool: 'brush',
            currentColor: '#6366f1',
            brushSettings: {
                size: 5,
                opacity: 1,
                smoothing: 0.5,
                scatter: 0
            },
            layers: [],
            currentLayer: 0,
            frames: [],
            currentFrame: 0,
            totalFrames: 120,
            isPlaying: false,
            isLooping: true,
            fps: 24,
            projectName: 'ŸÖÿ¥ÿ±Ÿàÿπ ÿ¨ÿØŸäÿØ',
            width: 1000,
            height: 700,
            isPhysicsEnabled: false,
            isSoundEnabled: false,
            isRiggingMode: false,
            bones: [],
            keyframes: new Map(),
            history: [],
            historyStep: -1
        };

        // ===== INITIALIZATION =====
        window.addEventListener('load', async () => {
            await initializeAllSystems();
            setTimeout(() => {
                document.getElementById('loader').classList.add('hidden');
                animateEntry();
            }, 2000);
        });

        async function initializeAllSystems() {
            try {
                initializeCanvas();
                initializeFabric();
                initializePixi();
                initializeKonva();
                initializeThree();
                initializeMatter();
                initializeColors();
                initializeLayers();
                initializeTimeline();
                initializeAudio();
                setupEventListeners();
                setupKeyboardShortcuts();
                setupDragAndDrop();
                
                console.log('‚úÖ All systems initialized successfully');
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
            }
        }

        function initializeCanvas() {
            AppState.canvas = document.getElementById('mainCanvas');
            AppState.ctx = AppState.canvas.getContext('2d', { 
                alpha: false,
                willReadFrequently: true 
            });
            
            // Setup high-DPI canvas
            const dpr = window.devicePixelRatio || 1;
            const rect = AppState.canvas.getBoundingClientRect();
            AppState.canvas.width = AppState.width * dpr;
            AppState.canvas.height = AppState.height * dpr;
            AppState.ctx.scale(dpr, dpr);
            AppState.canvas.style.width = AppState.width + 'px';
            AppState.canvas.style.height = AppState.height + 'px';
        }

        function initializeFabric() {
            AppState.fabricCanvas = new fabric.Canvas('mainCanvas', {
                isDrawingMode: true,
                backgroundColor: '#ffffff',
                selection: true,
                preserveObjectStacking: true,
                enableRetinaScaling: true
            });
            
            AppState.fabricCanvas.freeDrawingBrush = new fabric.PencilBrush(AppState.fabricCanvas);
            AppState.fabricCanvas.freeDrawingBrush.width = AppState.brushSettings.size;
            AppState.fabricCanvas.freeDrawingBrush.color = AppState.currentColor;
            
            // Smooth drawing
            AppState.fabricCanvas.freeDrawingBrush.decimate = 0.4;
            
            // Object events
            AppState.fabricCanvas.on('object:added', saveHistory);
            AppState.fabricCanvas.on('object:modified', saveHistory);
            AppState.fabricCanvas.on('object:removed', saveHistory);
        }

        function initializePixi() {
            AppState.pixiApp = new PIXI.Application({
                width: AppState.width,
                height: AppState.height,
                backgroundAlpha: 0,
                antialias: true,
                resolution: window.devicePixelRatio || 1,
                autoDensity: true
            });
            
            document.getElementById('pixiContainer').appendChild(AppState.pixiApp.view);
            
            // Add particle container for effects
            const particleContainer = new PIXI.Container();
            AppState.pixiApp.stage.addChild(particleContainer);
            
            // Animation loop
            AppState.pixiApp.ticker.add(() => {
                TWEEN.update();
            });
        }

        function initializeKonva() {
            AppState.konvaStage = new Konva.Stage({
                container: 'canvasContainer',
                width: AppState.width,
                height: AppState.height
            });
            
            AppState.konvaLayer = new Konva.Layer();
            AppState.konvaStage.add(AppState.konvaLayer);
            
            // Add transformer for selections
            const tr = new Konva.Transformer();
            AppState.konvaLayer.add(tr);
        }

        function initializeThree() {
            // Setup Three.js scene for 3D effects
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, AppState.width / AppState.height, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            
            renderer.setSize(AppState.width, AppState.height);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            AppState.threeScene = scene;
            AppState.threeCamera = camera;
            AppState.threeRenderer = renderer;
            
            // Add basic lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(0, 1, 0);
            scene.add(directionalLight);
            
            camera.position.z = 5;
        }

        function initializeMatter() {
            const Engine = Matter.Engine,
                  Render = Matter.Render,
                  Runner = Matter.Runner,
                  Bodies = Matter.Bodies,
                  Composite = Matter.Composite;
            
            AppState.matterEngine = Engine.create();
            AppState.matterEngine.gravity.y = 1;
            
            // Create preview renderer for physics panel
            const render = Render.create({
                element: document.getElementById('physicsPreview'),
                engine: AppState.matterEngine,
                options: {
                    width: 260,
                    height: 150,
                    wireframes: false,
                    background: 'transparent'
                }
            });
            
            // Add ground
            const ground = Bodies.rectangle(130, 140, 260, 20, { isStatic: true });
            Composite.add(AppState.matterEngine.world, ground);
            
            Render.run(render);
            const runner = Runner.create();
            Runner.run(runner, AppState.matterEngine);
        }

        function initializeColors() {
            const colors = [
                '#000000', '#ffffff', '#ef4444', '#f97316', '#f59e0b',
                '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#6366f1',
                '#8b5cf6', '#d946ef', '#f43f5e', '#78716c', '#94a3b8',
                '#1e293b', '#0f172a', '#020617', '#7c3aed', '#db2777'
            ];
            
            const palette = document.getElementById('colorPalette');
            colors.forEach((color, index) => {
                const btn = document.createElement('div');
                btn.className = 'color-btn';
                btn.style.backgroundColor = color;
                btn.onclick = () => setColor(color, btn);
                if (index === 9) btn.classList.add('active');
                palette.appendChild(btn);
            });
            
            updateColorInfo(AppState.currentColor);
        }

        function initializeLayers() {
            AppState.layers = [
                { 
                    id: 1, 
                    name: 'ÿßŸÑÿ∑ÿ®ŸÇÿ© 1', 
                    visible: true, 
                    locked: false, 
                    opacity: 100,
                    blendMode: 'normal',
                    canvas: document.createElement('canvas')
                }
            ];
            renderLayers();
        }

        function initializeTimeline() {
            updateFrameDisplay();
            generateFrameThumbnails();
            renderLayersTimeline();
        }

        function initializeAudio() {
            // Initialize Tone.js
            Tone.start();
            
            // Create synth for UI sounds
            AppState.synth = new Tone.PolySynth(Tone.Synth).toDestination();
            AppState.synth.volume.value = -10;
        }

        function setupEventListeners() {
            // Timeline drag
            const slider = document.getElementById('timelineSlider');
            const handle = document.getElementById('timelineHandle');
            let isDragging = false;
            
            handle.addEventListener('mousedown', (e) => {
                isDragging = true;
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const rect = slider.getBoundingClientRect();
                const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
                const percent = (x / rect.width) * 100;
                const frame = Math.floor((percent / 100) * AppState.totalFrames);
                goToFrame(frame);
            });
            
            document.addEventListener('mouseup', () => isDragging = false);
            
            // Canvas interactions
            const canvas = document.getElementById('mainCanvas');
            
            canvas.addEventListener('mousedown', handleCanvasMouseDown);
            canvas.addEventListener('mousemove', handleCanvasMouseMove);
            canvas.addEventListener('mouseup', handleCanvasMouseUp);
            canvas.addEventListener('wheel', handleCanvasWheel);
            
            // Touch support with Hammer.js
            const hammer = new Hammer(canvas);
            hammer.get('pan').set({ direction: Hammer.DIRECTION_ALL });
            hammer.get('pinch').set({ enable: true });
            
            hammer.on('pan', (ev) => {
                if (AppState.currentTool === 'move') {
                    // Pan canvas
                }
            });
            
            // Interact.js for drag and drop
            interact('.draggable').draggable({
                inertia: true,
                modifiers: [
                    interact.modifiers.restrictRect({
                        restriction: 'parent',
                        endOnly: true
                    })
                ],
                autoScroll: true,
                listeners: {
                    move: dragMoveListener
                }
            });
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'z':
                            e.preventDefault();
                            undo();
                            break;
                        case 'y':
                            e.preventDefault();
                            redo();
                            break;
                        case 's':
                            e.preventDefault();
                            saveProject();
                            break;
                        case 'o':
                            e.preventDefault();
                            showNewProjectModal();
                            break;
                        case 'e':
                            e.preventDefault();
                            exportAnimation('png');
                            break;
                    }
                } else {
                    switch(e.key.toLowerCase()) {
                        case ' ':
                            e.preventDefault();
                            togglePlayback();
                            break;
                        case 'b':
                            setTool('brush');
                            break;
                        case 'e':
                            setTool('eraser');
                            break;
                        case 'v':
                            setTool('select');
                            break;
                        case 'p':
                            setTool('pencil');
                            break;
                        case 'f':
                            setTool('fill');
                            break;
                        case 't':
                            setTool('text');
                            break;
                        case 'r':
                            setTool('shapes');
                            break;
                        case '[':
                            changeBrushSize(-1);
                            break;
                        case ']':
                            changeBrushSize(1);
                            break;
                    }
                }
            });
        }

        function setupDragAndDrop() {
            const dropZone = document.getElementById('canvasContainer');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.boxShadow = '0 0 30px rgba(99, 102, 241, 0.5)';
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.style.boxShadow = '';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.boxShadow = '';
                
                const files = e.dataTransfer.files;
                handleDroppedFiles(files);
            });
        }

        // ===== TOOLS SYSTEM =====
        function setTool(tool) {
            AppState.currentTool = tool;
            
            // Update UI
            document.querySelectorAll('.tool-btn-small').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Update cursors
            const cursors = {
                brush: 'crosshair',
                pencil: 'crosshair',
                eraser: 'cell',
                fill: 'pointer',
                picker: 'copy',
                text: 'text',
                select: 'default',
                move: 'move',
                bone: 'crosshair'
            };
            
            document.getElementById('mainCanvas').style.cursor = cursors[tool] || 'default';
            
            // Update Fabric.js mode
            if (tool === 'brush' || tool === 'pencil') {
                AppState.fabricCanvas.isDrawingMode = true;
                AppState.fabricCanvas.freeDrawingBrush.color = AppState.currentColor;
            } else if (tool === 'eraser') {
                AppState.fabricCanvas.isDrawingMode = true;
                AppState.fabricCanvas.freeDrawingBrush.color = '#ffffff';
            } else {
                AppState.fabricCanvas.isDrawingMode = false;
            }
            
            // Play sound effect
            playUISound('click');
            
            // Animate
            gsap.from(event.currentTarget, {
                scale: 0.8,
                rotation: -10,
                duration: 0.3,
                ease: "back.out(1.7)"
            });
        }

        function updateBrushSetting(setting, value) {
            AppState.brushSettings[setting] = parseInt(value);
            document.getElementById(setting + 'Value').textContent = value + (setting === 'size' ? '' : '%');
            
            if (setting === 'size') {
                AppState.fabricCanvas.freeDrawingBrush.width = parseInt(value);
            } else if (setting === 'opacity') {
                AppState.fabricCanvas.freeDrawingBrush.color = AppState.currentColor + Math.round(value * 2.55).toString(16).padStart(2, '0');
            }
        }

        function changeBrushSize(delta) {
            const slider = document.getElementById('brushSize');
            const newValue = parseInt(slider.value) + delta;
            if (newValue >= 1 && newValue <= 200) {
                slider.value = newValue;
                updateBrushSetting('size', newValue);
            }
        }

        // ===== COLOR SYSTEM =====
        function setColor(color, btn) {
            AppState.currentColor = color;
            AppState.fabricCanvas.freeDrawingBrush.color = color;
            
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            updateColorInfo(color);
            
            // Animate
            gsap.to(btn, {
                scale: 1.3,
                duration: 0.2,
                yoyo: true,
                repeat: 1
            });
        }

        function updateCustomColor(color) {
            AppState.currentColor = color;
            AppState.fabricCanvas.freeDrawingBrush.color = color;
            updateColorInfo(color);
        }

        function updateColorInfo(color) {
            const rgb = chroma(color).rgb();
            document.getElementById('colorInfo').textContent = 
                `${color.toUpperCase()} | RGB(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;
        }

        function generateRandomPalette() {
            const palette = chroma.scale([chroma.random(), chroma.random()]).mode('lch').colors(5);
            const container = document.getElementById('colorPalette');
            
            // Add new colors to palette
            palette.forEach(color => {
                const btn = document.createElement('div');
                btn.className = 'color-btn';
                btn.style.backgroundColor = color;
                btn.onclick = () => setColor(color, btn);
                container.appendChild(btn);
                
                gsap.from(btn, {
                    scale: 0,
                    rotation: 180,
                    duration: 0.4,
                    ease: "back.out(1.7)"
                });
            });
        }

        function extractColorsFromImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const colorThief = new ColorThief();
                        const palette = colorThief.getPalette(img, 5);
                        
                        const container = document.getElementById('colorPalette');
                        palette.forEach(rgb => {
                            const color = chroma(rgb).hex();
                            const btn = document.createElement('div');
                            btn.className = 'color-btn';
                            btn.style.backgroundColor = color;
                            btn.onclick = () => setColor(color, btn);
                            container.appendChild(btn);
                        });
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        // ===== LAYERS SYSTEM =====
        function renderLayers() {
            const list = document.getElementById('layersList');
            list.innerHTML = '';
            
            AppState.layers.forEach((layer, index) => {
                const item = document.createElement('div');
                item.className = `layer-item ${index === AppState.currentLayer ? 'active' : ''}`;
                item.innerHTML = `
                    <div class="layer-thumb">
                        <i class="fas fa-image"></i>
                    </div>
                    <div class="layer-info">
                        <div class="layer-name">${layer.name}</div>
                        <div class="layer-meta">${layer.opacity}% ‚Ä¢ ${layer.blendMode}</div>
                    </div>
                    <div class="layer-controls">
                        <button class="layer-btn" onclick="toggleLayerVisibility(${index})">
                            <i class="fas ${layer.visible ? 'fa-eye' : 'fa-eye-slash'}"></i>
                        </button>
                        <button class="layer-btn" onclick="toggleLayerLock(${index})">
                            <i class="fas ${layer.locked ? 'fa-lock' : 'fa-unlock'}"></i>
                        </button>
                    </div>
                `;
                item.onclick = (e) => {
                    if (!e.target.closest('.layer-btn')) selectLayer(index);
                };
                list.appendChild(item);
            });
        }

        function addLayer() {
            const newLayer = {
                id: Date.now(),
                name: `ÿßŸÑÿ∑ÿ®ŸÇÿ© ${AppState.layers.length + 1}`,
                visible: true,
                locked: false,
                opacity: 100,
                blendMode: 'normal',
                canvas: document.createElement('canvas')
            };
            AppState.layers.unshift(newLayer);
            selectLayer(0);
            
            playUISound('add');
            
            gsap.from(document.querySelector('.layer-item'), {
                x: -50,
                opacity: 0,
                duration: 0.3
            });
        }

        function duplicateLayer() {
            if (AppState.layers[AppState.currentLayer]) {
                const copy = { ...AppState.layers[AppState.currentLayer], id: Date.now() };
                copy.name += ' ŸÜÿ≥ÿÆÿ©';
                AppState.layers.splice(AppState.currentLayer, 0, copy);
                renderLayers();
                playUISound('duplicate');
            }
        }

        function mergeLayers() {
            if (AppState.layers.length > 1) {
                AppState.layers.splice(AppState.currentLayer, 1);
                selectLayer(Math.min(AppState.currentLayer, AppState.layers.length - 1));
                playUISound('merge');
            }
        }

        function selectLayer(index) {
            AppState.currentLayer = index;
            renderLayers();
            
            // Update canvas to show selected layer
            AppState.fabricCanvas.setActiveObject(
                AppState.fabricCanvas.getObjects()[index] || null
            );
        }

        function toggleLayerVisibility(index) {
            AppState.layers[index].visible = !AppState.layers[index].visible;
            renderLayers();
            
            const obj = AppState.fabricCanvas.getObjects()[index];
            if (obj) obj.visible = AppState.layers[index].visible;
            AppState.fabricCanvas.renderAll();
        }

        function toggleLayerLock(index) {
            AppState.layers[index].locked = !AppState.layers[index].locked;
            renderLayers();
        }

        // ===== ANIMATION SYSTEM =====
        function togglePlayback() {
            AppState.isPlaying = !AppState.isPlaying;
            const btn = document.getElementById('playBtn');
            const icon = btn.querySelector('i');
            
            if (AppState.isPlaying) {
                icon.className = 'fas fa-pause';
                playAnimation();
                playUISound('play');
            } else {
                icon.className = 'fas fa-play';
                stopAnimation();
                playUISound('pause');
            }
            
            gsap.to(btn, {
                scale: 0.9,
                duration: 0.1,
                yoyo: true,
                repeat: 1
            });
        }

        function playAnimation() {
            let lastTime = performance.now();
            const frameInterval = 1000 / AppState.fps;
            
            function animate(currentTime) {
                if (!AppState.isPlaying) return;
                
                const delta = currentTime - lastTime;
                
                if (delta >= frameInterval) {
                    AppState.currentFrame++;
                    if (AppState.currentFrame >= AppState.totalFrames) {
                        if (AppState.isLooping) {
                            AppState.currentFrame = 0;
                        } else {
                            togglePlayback();
                            return;
                        }
                    }
                    goToFrame(AppState.currentFrame);
                    lastTime = currentTime - (delta % frameInterval);
                }
                
                requestAnimationFrame(animate);
            }
            
            requestAnimationFrame(animate);
        }

        function stopAnimation() {
            // Animation stops via flag
        }

        function goToFrame(frame) {
            AppState.currentFrame = Math.max(0, Math.min(frame, AppState.totalFrames));
            updateFrameDisplay();
            updateTimelinePosition();
            
            // Interpolate objects if keyframes exist
            interpolateObjects();
        }

        function updateFrameDisplay() {
            document.getElementById('frameDisplay').textContent = 
                AppState.currentFrame.toString().padStart(3, '0');
            
            const seconds = Math.floor(AppState.currentFrame / AppState.fps);
            const frames = AppState.currentFrame % AppState.fps;
            const ms = Math.floor((frames / AppState.fps) * 100);
            document.getElementById('timeDisplay').textContent = 
                `${seconds.toString().padStart(2, '0')}:${frames.toString().padStart(2, '0')}:${ms.toString().padStart(2, '0')}`;
        }

        function updateTimelinePosition() {
            const percent = (AppState.currentFrame / AppState.totalFrames) * 100;
            document.getElementById('timelineHandle').style.left = `calc(10px + ${percent}%)`;
            document.getElementById('timelineProgress').style.width = `${percent}%`;
        }

        function addKeyframe() {
            const currentObject = AppState.fabricCanvas.getActiveObject();
            if (!currentObject) {
                alert('ÿßÿÆÿ™ÿ± ŸÉÿßÿ¶ŸÜ ÿ£ŸàŸÑÿßŸã ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ∑ÿßÿ± ŸÖŸÅÿ™ÿßÿ≠Ÿä');
                return;
            }
            
            const key = `${currentObject.id}_${AppState.currentFrame}`;
            AppState.keyframes.set(key, {
                object: currentObject,
                frame: AppState.currentFrame,
                properties: {
                    left: currentObject.left,
                    top: currentObject.top,
                    scaleX: currentObject.scaleX,
                    scaleY: currentObject.scaleY,
                    angle: currentObject.angle,
                    opacity: currentObject.opacity
                }
            });
            
            // Visual marker
            const marker = document.createElement('div');
            marker.className = 'keyframe-marker';
            marker.style.left = `${(AppState.currentFrame / AppState.totalFrames) * 100}%`;
            document.getElementById('keyframeMarkers').appendChild(marker);
            
            playUISound('keyframe');
            
            gsap.from(marker, {
                scale: 0,
                duration: 0.3,
                ease: "back.out(1.7)"
            });
        }

        function interpolateObjects() {
            // Simple interpolation between keyframes
            AppState.keyframes.forEach((data, key) => {
                if (data.frame === AppState.currentFrame) {
                    // Apply keyframe properties
                    const obj = data.object;
                    if (obj) {
                        gsap.to(obj, {
                            left: data.properties.left,
                            top: data.properties.top,
                            scaleX: data.properties.scaleX,
                            scaleY: data.properties.scaleY,
                            rotation: data.properties.angle,
                            opacity: data.properties.opacity,
                            duration: 0.1,
                            overwrite: true
                        });
                    }
                }
            });
        }

        function toggleLoop() {
            AppState.isLooping = !AppState.isLooping;
            const icon = document.getElementById('loopIcon');
            icon.style.color = AppState.isLooping ? 'var(--primary)' : '#64748b';
        }

        function changeFPS(newFps) {
            AppState.fps = parseInt(newFps);
        }

        function generateFrameThumbnails() {
            const strip = document.getElementById('framesStrip');
            strip.innerHTML = '';
            
            for (let i = 0; i < 10; i++) {
                const thumb = document.createElement('div');
                thumb.className = 'frame-thumb';
                thumb.setAttribute('data-frame', i * 12);
                if (i === 0) thumb.classList.add('active');
                thumb.onclick = () => goToFrame(i * 12);
                strip.appendChild(thumb);
            }
        }

        function renderLayersTimeline() {
            const container = document.getElementById('layersTimeline');
            container.innerHTML = '';
            
            AppState.layers.forEach((layer, index) => {
                const row = document.createElement('div');
                row.className = 'layer-timeline';
                row.innerHTML = `
                    <div class="layer-timeline-name">${layer.name}</div>
                    <div class="layer-frames" id="layerFrames_${index}"></div>
                `;
                container.appendChild(row);
            });
        }

        // ===== RIGGING SYSTEM =====
        function toggleRiggingPanel() {
            AppState.isRiggingMode = !AppState.isRiggingMode;
            const section = document.getElementById('riggingSection');
            
            if (AppState.isRiggingMode) {
                section.classList.remove('hidden');
                initBoneSystem();
            } else {
                section.classList.add('hidden');
            }
            
            playUISound('toggle');
        }

        function initBoneSystem() {
            const canvas = document.getElementById('boneCanvas');
            const ctx = canvas.getContext('2d');
            
            function drawSkeleton() {
                ctx.clearRect(0, 0, 260, 150);
                
                // Draw bones
                ctx.strokeStyle = '#6366f1';
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                
                const bones = [
                    { from: [130, 30], to: [130, 70] }, // Head to body
                    { from: [130, 50], to: [90, 60] },  // Left arm
                    { from: [130, 50], to: [170, 60] }, // Right arm
                    { from: [130, 70], to: [110, 120] }, // Left leg
                    { from: [130, 70], to: [150, 120] }  // Right leg
                ];
                
                bones.forEach(bone => {
                    ctx.beginPath();
                    ctx.moveTo(...bone.from);
                    ctx.lineTo(...bone.to);
                    ctx.stroke();
                });
                
                // Draw joints
                ctx.fillStyle = '#ec4899';
                const joints = [[130, 30], [130, 50], [130, 70], [90, 60], [170, 60], [110, 120], [150, 120]];
                joints.forEach(joint => {
                    ctx.beginPath();
                    ctx.arc(joint[0], joint[1], 5, 0, Math.PI * 2);
                    ctx.fill();
                });
            }
            
            drawSkeleton();
            
            // Animate with GSAP
            gsap.to({}, {
                duration: 2,
                repeat: -1,
                yoyo: true,
                onUpdate: drawSkeleton
            });
        }

        function createBone() {
            AppState.bones.push({
                x: 0,
                y: 0,
                rotation: 0,
                length: 50,
                parent: null
            });
            
            playUISound('add');
            
            gsap.fromTo('#riggingPreview', 
                { scale: 0.95 },
                { scale: 1, duration: 0.3, ease: "elastic.out(1, 0.3)" }
            );
        }

        function autoRig() {
            // Simulate AI auto-rigging
            playUISound('processing');
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ...';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                // Create automatic bone structure
                for (let i = 0; i < 5; i++) {
                    createBone();
                }
                
                gsap.to('#riggingPreview', {
                    boxShadow: '0 0 40px rgba(99, 102, 241, 0.8)',
                    duration: 0.5,
                    yoyo: true,
                    repeat: 3
                });
                
                playUISound('success');
                alert('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸáŸäŸÉŸÑ ÿßŸÑÿπÿ∏ŸÖŸä ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ŸÜÿ¨ÿßÿ≠!');
            }, 2000);
        }

        function changeRigMode(mode) {
            console.log('Rig mode changed to:', mode);
        }

        // ===== PHYSICS SYSTEM =====
        function togglePhysicsPanel() {
            switchTab('physics');
        }

        function togglePhysics() {
            AppState.isPhysicsEnabled = !AppState.isPhysicsEnabled;
            const checkbox = document.getElementById('physicsEnabled');
            checkbox.classList.toggle('checked', AppState.isPhysicsEnabled);
            
            if (AppState.isPhysicsEnabled) {
                // Enable physics for current objects
                AppState.fabricCanvas.getObjects().forEach(obj => {
                    obj.physicsBody = Matter.Bodies.rectangle(
                        obj.left, obj.top, obj.width * obj.scaleX, obj.height * obj.scaleY
                    );
                    Matter.Composite.add(AppState.matterEngine.world, obj.physicsBody);
                });
            }
            
            playUISound('toggle');
        }

        function updateGravity(value) {
            if (AppState.matterEngine) {
                AppState.matterEngine.gravity.y = value / 10;
            }
        }

        function addPhysicsBody() {
            const { Bodies, Composite } = Matter;
            const body = Bodies.circle(130, 30, 20, {
                restitution: 0.9,
                render: { fillStyle: '#6366f1' }
            });
            Composite.add(AppState.matterEngine.world, body);
            playUISound('add');
        }

        // ===== EFFECTS SYSTEM =====
        function applyEffect(effectName) {
            const activeObject = AppState.fabricCanvas.getActiveObject();
            if (!activeObject) {
                alert('ÿßÿÆÿ™ÿ± ŸÉÿßÿ¶ŸÜ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            
            switch(effectName) {
                case 'blur':
                    activeObject.shadow = new fabric.Shadow({
                        color: 'rgba(0,0,0,0.3)',
                        blur: 20,
                        offsetX: 0,
                        offsetY: 0
                    });
                    break;
                case 'glow':
                    activeObject.shadow = new fabric.Shadow({
                        color: AppState.currentColor,
                        blur: 30,
                        offsetX: 0,
                        offsetY: 0
                    });
                    break;
                case 'shadow':
                    activeObject.shadow = new fabric.Shadow({
                        color: 'rgba(0,0,0,0.5)',
                        blur: 10,
                        offsetX: 10,
                        offsetY: 10
                    });
                    break;
                case 'pixelate':
                    // Use PixiJS filter
                    if (activeObject._element) {
                        const texture = PIXI.Texture.from(activeObject._element);
                        const sprite = new PIXI.Sprite(texture);
                        const filter = new PIXI.filters.PixelateFilter();
                        filter.size = 10;
                        sprite.filters = [filter];
                        AppState.pixiApp.stage.addChild(sprite);
                    }
                    break;
            }
            
            AppState.fabricCanvas.renderAll();
            playUISound('effect');
            
            gsap.from(activeObject, {
                scaleX: 1.1,
                scaleY: 1.1,
                duration: 0.3,
                yoyo: true,
                repeat: 1
            });
        }

        // ===== EXPORT SYSTEM =====
        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('show');
        }

        async function exportAnimation(format) {
            document.getElementById('exportMenu').classList.remove('show');
            
            const progressModal = document.createElement('div');
            progressModal.className = 'modal-overlay show';
            progressModal.innerHTML = `
                <div class="modal-content" style="text-align: center;">
                    <div class="loader-animation" style="margin: 0 auto 20px;">
                        <div class="loader-circle"></div>
                    </div>
                    <h3>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿµÿØŸäÿ±...</h3>
                    <p style="color: #64748b; margin-top: 10px;">Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±</p>
                    <div style="margin-top: 20px; background: rgba(99,102,241,0.1); height: 10px; border-radius: 5px; overflow: hidden;">
                        <div id="exportProgress" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.3s;"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressModal);
            
            // Simulate export progress
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    
                    setTimeout(() => {
                        progressModal.remove();
                        
                        // Create download based on format
                        if (format === 'png') {
                            const link = document.createElement('a');
                            link.download = `frame_${AppState.currentFrame}.png`;
                            link.href = AppState.canvas.toDataURL();
                            link.click();
                        } else if (format === 'json') {
                            const projectData = {
                                name: AppState.projectName,
                                version: '1.0',
                                width: AppState.width,
                                height: AppState.height,
                                fps: AppState.fps,
                                totalFrames: AppState.totalFrames,
                                layers: AppState.layers,
                                frames: Array.from(AppState.keyframes.entries()),
                                timestamp: new Date().toISOString()
                            };
                            
                            const blob = new Blob([JSON.stringify(projectData, null, 2)], 
                                { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `${AppState.projectName}.json`;
                            link.click();
                        } else {
                            alert(`ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ®ÿµŸäÿ∫ÿ© ${format.toUpperCase()} ÿ®ŸÜÿ¨ÿßÿ≠!`);
                        }
                        
                        playUISound('success');
                    }, 500);
                }
                document.getElementById('exportProgress').style.width = progress + '%';
            }, 200);
        }

        // ===== PROJECT MANAGEMENT =====
        function showNewProjectModal() {
            document.getElementById('newProjectModal').classList.add('show');
            playUISound('open');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            playUISound('close');
        }

        function setTemplate(type) {
            const templates = {
                hd: { w: 1920, h: 1080 },
                social: { w: 1080, h: 1920 },
                square: { w: 1080, h: 1080 },
                custom: { w: 1000, h: 700 }
            };
            
            const t = templates[type];
            document.getElementById('newWidth').value = t.w;
            document.getElementById('newHeight').value = t.h;
            
            // Visual feedback
            document.querySelectorAll('.effect-btn').forEach(btn => {
                btn.style.borderColor = 'transparent';
            });
            event.currentTarget.style.borderColor = 'var(--primary)';
        }

        function createNewProject() {
            AppState.projectName = document.getElementById('newProjectName').value;
            AppState.width = parseInt(document.getElementById('newWidth').value);
            AppState.height = parseInt(document.getElementById('newHeight').value);
            AppState.fps = parseInt(document.getElementById('newFPS').value);
            
            // Resize canvas
            const canvas = document.getElementById('mainCanvas');
            canvas.width = AppState.width;
            canvas.height = AppState.height;
            canvas.style.width = AppState.width + 'px';
            canvas.style.height = AppState.height + 'px';
            
            // Clear and reset
            AppState.fabricCanvas.clear();
            AppState.layers = [];
            AppState.keyframes.clear();
            initializeLayers();
            
            // Set background
            const bgType = document.getElementById('bgType').value;
            if (bgType === 'white') {
                AppState.fabricCanvas.backgroundColor = '#ffffff';
            } else if (bgType === 'dark') {
                AppState.fabricCanvas.backgroundColor = '#1e293b';
            } else if (bgType === 'grid') {
                // Draw grid pattern
                const ctx = AppState.canvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, AppState.width, AppState.height);
                ctx.strokeStyle = '#e2e8f0';
                ctx.lineWidth = 1;
                for (let i = 0; i < AppState.width; i += 20) {
                    ctx.beginPath();
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i, AppState.height);
                    ctx.stroke();
                }
                for (let i = 0; i < AppState.height; i += 20) {
                    ctx.beginPath();
                    ctx.moveTo(0, i);
                    ctx.lineTo(AppState.width, i);
                    ctx.stroke();
                }
            }
            
            AppState.fabricCanvas.renderAll();
            closeModal('newProjectModal');
            
            // Animation
            gsap.from('#mainCanvas', {
                scale: 0.8,
                opacity: 0,
                duration: 0.5,
                ease: "back.out(1.7)"
            });
            
            playUISound('success');
        }

        function saveProject() {
            const projectData = {
                name: AppState.projectName,
                canvas: AppState.canvas.toDataURL(),
                layers: AppState.layers,
                frames: AppState.frames,
                keyframes: Array.from(AppState.keyframes.entries()),
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('animationProject_' + Date.now(), JSON.stringify(projectData));
            
            // Visual feedback
            gsap.to('.logo', {
                scale: 1.2,
                duration: 0.2,
                yoyo: true,
                repeat: 1
            });
            
            playUISound('save');
            
            // Show toast
            showToast('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ®ŸÜÿ¨ÿßÿ≠!');
        }

        // ===== UI UTILITIES =====
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            playUISound('click');
        }

        function updateTransform(prop, value) {
            const activeObject = AppState.fabricCanvas.getActiveObject();
            if (!activeObject) return;
            
            switch(prop) {
                case 'x':
                    activeObject.set('left', parseInt(value));
                    break;
                case 'y':
                    activeObject.set('top', parseInt(value));
                    break;
                case 'width':
                    activeObject.set('scaleX', parseInt(value) / activeObject.width);
                    break;
                case 'height':
                    activeObject.set('scaleY', parseInt(value) / activeObject.height);
                    break;
                case 'rotation':
                    activeObject.set('angle', parseInt(value));
                    break;
                case 'alpha':
                    activeObject.set('opacity', parseInt(value) / 100);
                    break;
            }
            
            activeObject.setCoords();
            AppState.fabricCanvas.renderAll();
        }

        function toggleLockRatio() {
            const checkbox = document.getElementById('lockRatio');
            checkbox.classList.toggle('checked');
        }

        function updateBlendMode(mode) {
            const activeObject = AppState.fabricCanvas.getActiveObject();
            if (activeObject) {
                // Fabric.js blend mode implementation
                activeObject.globalCompositeOperation = mode;
                AppState.fabricCanvas.renderAll();
            }
        }

        function toggleOnionSkin() {
            // Toggle onion skinning for animation
            playUISound('toggle');
            showToast('ÿ¨ŸÑÿØÿ© ÿßŸÑÿ®ÿµŸÑ: ' + (AppState.onionSkin ? 'ŸÖŸÅÿπŸÑÿ©' : 'ŸÖÿπÿ∑ŸÑÿ©'));
        }

        function toggleSound() {
            AppState.isSoundEnabled = !AppState.isSoundEnabled;
            document.getElementById('soundEnabled').classList.toggle('checked', AppState.isSoundEnabled);
            
            if (AppState.isSoundEnabled) {
                Tone.start();
            }
        }

        function playUISound(type) {
            if (!AppState.isSoundEnabled) return;
            
            const sounds = {
                click: ['C5', '8n'],
                add: ['E5', '8n'],
                save: ['G5', '4n'],
                play: ['A4', '8n'],
                pause: ['F4', '8n'],
                success: ['C5', 'E5', 'G5', '8n'],
                effect: ['D5', '16n'],
                keyframe: ['B5', '16n'],
                toggle: ['A3', '16n'],
                processing: ['C4', '32n'],
                duplicate: ['E5', 'G5', '8n'],
                merge: ['C4', 'G4', '4n'],
                open: ['F4', 'A4', '8n'],
                close: ['A4', 'F4', '8n']
            };
            
            const sound = sounds[type];
            if (sound) {
                if (Array.isArray(sound[0])) {
                    AppState.synth.triggerAttackRelease(sound[0], sound[1]);
                } else {
                    AppState.synth.triggerAttackRelease(sound[0], sound[1]);
                }
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 200px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--glass);
                border: 1px solid var(--glass-border);
                padding: 15px 30px;
                border-radius: 12px;
                color: white;
                font-weight: 600;
                z-index: 3000;
                backdrop-filter: blur(10px);
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            gsap.from(toast, {
                y: 20,
                opacity: 0,
                duration: 0.3
            });
            
            setTimeout(() => {
                gsap.to(toast, {
                    y: -20,
                    opacity: 0,
                    duration: 0.3,
                    onComplete: () => toast.remove()
                });
            }, 2000);
        }

        function animateEntry() {
            gsap.from('.toolbar', {
                x: -100,
                opacity: 0,
                duration: 0.6,
                ease: "power3.out"
            });
            
            gsap.from('.properties-panel', {
                x: 100,
                opacity: 0,
                duration: 0.6,
                ease: "power3.out"
            });
            
            gsap.from('.timeline-wrapper', {
                y: 100,
                opacity: 0,
                duration: 0.6,
                delay: 0.2,
                ease: "power3.out"
            });
            
            gsap.from('#mainCanvas', {
                scale: 0.9,
                opacity: 0,
                duration: 0.8,
                delay: 0.3,
                ease: "back.out(1.7)"
            });
        }

        function showWelcome() {
            const tips = [
                'üí° ÿßÿ∂ÿ∫ÿ∑ Space ŸÑŸÑÿ™ÿ¥ÿ∫ŸäŸÑ/ÿßŸÑÿ•ŸäŸÇÿßŸÅ',
                'üí° ÿßÿ≥ÿ™ÿÆÿØŸÖ B ŸÑŸÑŸÅÿ±ÿ¥ÿßÿ©ÿå E ŸÑŸÑŸÖŸÖÿ≠ÿßÿ©',
                'üí° Ctrl+S ŸÑŸÑÿ≠ŸÅÿ∏ ÿßŸÑÿ≥ÿ±Ÿäÿπ',
                'üí° ÿßÿ≥ÿ≠ÿ® ÿµŸàÿ±ÿ© ŸÑŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ',
                'üí° ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿßŸÑÿ∑ÿ®ŸÇÿ© ŸÖÿ±ÿ™ŸäŸÜ ŸÑÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≥ŸÖŸäÿ©'
            ];
            
            alert(`üé¨ ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ ŸÅŸä ÿ£ŸÜŸÖŸäÿ¥ŸÜ ÿßŸÑÿπÿ±ÿ®!\n\n${tips.join('\n')}`);
        }

        // ===== HISTORY SYSTEM =====
        function saveHistory() {
            AppState.historyStep++;
            if (AppState.historyStep < AppState.history.length) {
                AppState.history.length = AppState.historyStep;
            }
            AppState.history.push(AppState.canvas.toDataURL());
            
            // Limit history
            if (AppState.history.length > 50) {
                AppState.history.shift();
                AppState.historyStep--;
            }
        }

        function undo() {
            if (AppState.historyStep > 0) {
                AppState.historyStep--;
                restoreHistory();
            }
        }

        function redo() {
            if (AppState.historyStep < AppState.history.length - 1) {
                AppState.historyStep++;
                restoreHistory();
            }
        }

        function restoreHistory() {
            const img = new Image();
            img.onload = () => {
                AppState.ctx.clearRect(0, 0, AppState.width, AppState.height);
                AppState.ctx.drawImage(img, 0, 0);
            };
            img.src = AppState.history[AppState.historyStep];
        }

        // ===== CANVAS EVENTS =====
        function handleCanvasMouseDown(e) {
            if (AppState.currentTool === 'brush' || AppState.currentTool === 'pencil') {
                AppState.isDrawing = true;
            }
        }

        function handleCanvasMouseMove(e) {
            if (!AppState.isDrawing) return;
            
            const rect = AppState.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Custom brush logic with scatter
            if (AppState.brushSettings.scatter > 0) {
                const scatter = AppState.brushSettings.scatter;
                const offsetX = (Math.random() - 0.5) * scatter;
                const offsetY = (Math.random() - 0.5) * scatter;
                
                // Draw with PixiJS for performance
                const graphics = new PIXI.Graphics();
                graphics.beginFill(AppState.currentColor);
                graphics.drawCircle(x + offsetX, y + offsetY, AppState.brushSettings.size / 2);
                graphics.endFill();
                AppState.pixiApp.stage.addChild(graphics);
            }
        }

        function handleCanvasMouseUp() {
            if (AppState.isDrawing) {
                AppState.isDrawing = false;
                saveHistory();
            }
        }

        function handleCanvasWheel(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            // Zoom canvas
            const currentTransform = AppState.fabricCanvas.getViewportTransform();
            currentTransform[0] *= delta;
            currentTransform[3] *= delta;
            AppState.fabricCanvas.setViewportTransform(currentTransform);
        }

        function handleDroppedFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        fabric.Image.fromURL(e.target.result, (img) => {
                            img.scaleToWidth(300);
                            img.set({
                                left: AppState.width / 2 - 150,
                                top: AppState.height / 2 - 150
                            });
                            AppState.fabricCanvas.add(img);
                            AppState.fabricCanvas.renderAll();
                            saveHistory();
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function dragMoveListener(event) {
            const target = event.target;
            const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
            const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
            
            target.style.transform = `translate(${x}px, ${y}px)`;
            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
        }

        // ===== WINDOW EVENTS =====
        window.addEventListener('resize', () => {
            // Responsive adjustments
        });

        window.addEventListener('beforeunload', (e) => {
            if (AppState.history.length > 1) {
                e.preventDefault();
                e.returnValue = 'ŸÑÿØŸäŸÉ ÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ≠ŸÅŸàÿ∏ÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ∫ÿßÿØÿ±ÿ©ÿü';
            }
        });

        // Close dropdowns on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.menu-btn') && !e.target.closest('.dropdown-menu')) {
                document.getElementById('exportMenu').classList.remove('show');
            }
        });

        // Initialize TWEEN
        const TWEEN = window.TWEEN || {
            update: () => {},
            Easing: { Quadratic: { Out: () => {} } }
        };

        console.log('üé¨ ÿ£ŸÜŸÖŸäÿ¥ŸÜ ÿßŸÑÿπÿ±ÿ® - ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
    </script>
</body>
</html>