<!-- index.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>استوديو صفوان الاحترافي - Safwan Studio Pro</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
</head>
<body>
    <!-- شاشة البداية -->
    <div id="splash-screen" class="screen active">
        <div class="splash-content">
            <div class="logo-container">
                <svg viewBox="0 0 200 200" class="studio-logo">
                    <defs>
                        <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#764ba2;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#f093fb;stop-opacity:1" />
                        </linearGradient>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    <circle cx="100" cy="100" r="85" fill="none" stroke="url(#logoGrad)" stroke-width="3" filter="url(#glow)"/>
                    <path d="M50 130 Q100 40 150 130" fill="none" stroke="url(#logoGrad)" stroke-width="5" stroke-linecap="round" filter="url(#glow)"/>
                    <circle cx="100" cy="100" r="25" fill="url(#logoGrad)" filter="url(#glow)"/>
                    <path d="M30 100 L50 100 M150 100 L170 100" stroke="url(#logoGrad)" stroke-width="4" stroke-linecap="round"/>
                    <path d="M100 30 L100 50 M100 150 L100 170" stroke="url(#logoGrad)" stroke-width="4" stroke-linecap="round"/>
                </svg>
            </div>
            <h1 class="studio-title">استوديو صفوان</h1>
            <p class="studio-subtitle">استوديو الرسم والأنميشن الاحترافي</p>
            <div class="version-badge">الإصدار 2.0 المحترف</div>
            <button class="start-btn" onclick="showScreen('project-type-screen')">
                <span>بدء الإبداع</span>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- اختيار نوع المشروع -->
    <div id="project-type-screen" class="screen">
        <div class="type-header">
            <h2>اختر نوع المشروع</h2>
            <p>ما الذي تريد إنشاءه اليوم؟</p>
        </div>
        <div class="project-types">
            <div class="type-card" onclick="createProject('static')">
                <div class="type-icon">
                    <svg viewBox="0 0 64 64">
                        <rect x="8" y="8" width="48" height="48" rx="4" fill="none" stroke="currentColor" stroke-width="2"/>
                        <circle cx="24" cy="24" r="6" fill="currentColor"/>
                        <path d="M8 48 L24 32 L36 40 L48 28 L56 36 L56 56 L8 56 Z" fill="currentColor" opacity="0.6"/>
                    </svg>
                </div>
                <h3>رسم ثابت</h3>
                <p>لوحات فنية ورسوم توضيحية</p>
            </div>
            
            <div class="type-card" onclick="createProject('animation')">
                <div class="type-icon">
                    <svg viewBox="0 0 64 64">
                        <rect x="4" y="12" width="20" height="40" rx="2" fill="currentColor" opacity="0.4"/>
                        <rect x="24" y="8" width="20" height="48" rx="2" fill="currentColor" opacity="0.7"/>
                        <rect x="44" y="16" width="16" height="32" rx="2" fill="currentColor"/>
                        <circle cx="14" cy="32" r="3" fill="#fff"/>
                        <circle cx="34" cy="32" r="3" fill="#fff"/>
                        <circle cx="52" cy="32" r="3" fill="#fff"/>
                    </svg>
                </div>
                <h3>رسوم متحركة</h3>
                <p>أنميشن وموشن جرافيك</p>
            </div>
            
            <div class="type-card" onclick="createProject('photo')">
                <div class="type-icon">
                    <svg viewBox="0 0 64 64">
                        <rect x="8" y="16" width="48" height="36" rx="4" fill="none" stroke="currentColor" stroke-width="2"/>
                        <circle cx="32" cy="34" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                        <circle cx="32" cy="34" r="6" fill="currentColor" opacity="0.6"/>
                        <path d="M48 16 L44 8 L20 8 L16 16" fill="none" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
                <h3>تحرير صور</h3>
                <p>تعديل وتحسين الصور</p>
            </div>
        </div>
        
        <button class="back-btn" onclick="showScreen('splash-screen')">رجوع</button>
    </div>

    <!-- معرض المشاريع -->
    <div id="gallery-screen" class="screen">
        <div class="gallery-header">
            <div class="header-title">
                <h2>معرض الأعمال</h2>
                <span id="project-type-label">جميع المشاريع</span>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="showScreen('project-type-screen')" title="مشروع جديد">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <line x1="12" y1="8" x2="12" y2="16"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                    </svg>
                </button>
                <button class="icon-btn" onclick="importImageToProject()" title="استيراد صورة">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                </button>
            </div>
        </div>
        <div id="projects-grid" class="projects-grid"></div>
    </div>

    <!-- شاشة الرسم الرئيسية -->
    <div id="canvas-screen" class="screen">
        <!-- شريط علوي -->
        <div class="top-toolbar">
            <button class="icon-btn" onclick="saveAndExit()" title="حفظ وخروج">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>
            
            <div class="project-info">
                <span id="current-project-name">مشروع جديد</span>
                <span id="current-frame-display" class="frame-display" style="display:none;">إطار: 1/30</span>
            </div>
            
            <div class="top-actions">
                <button class="icon-btn" onclick="toggleColorInput()" title="إدخال لون بالكود">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M9 9l6 6M15 9l-6 6"/>
                    </svg>
                </button>
                <button class="icon-btn" onclick="showDownloadOptions()" title="تنزيل">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- شريط الرسوم المتحركة (يظهر فقط في وضع الأنميشن) -->
        <div id="animation-toolbar" class="animation-toolbar" style="display:none;">
            <button class="anim-btn" onclick="addFrame()" title="إضافة إطار">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <line x1="12" y1="8" x2="12" y2="16"/>
                    <line x1="8" y1="12" x2="16" y2="12"/>
                </svg>
            </button>
            <button class="anim-btn" onclick="copyFrame()" title="نسخ الإطار">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                </svg>
            </button>
            <button class="anim-btn" onclick="deleteFrame()" title="حذف الإطار">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
            </button>
            <div class="timeline-container">
                <div id="timeline" class="timeline"></div>
            </div>
            <button class="anim-btn play-btn" onclick="togglePlayback()" title="تشغيل/إيقاف">
                <svg id="play-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
                <svg id="pause-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                    <rect x="6" y="4" width="4" height="16"/>
                    <rect x="14" y="4" width="4" height="16"/>
                </svg>
            </button>
            <div class="fps-control">
                <label>FPS:</label>
                <select id="fps-select" onchange="changeFPS(this.value)">
                    <option value="12">12</option>
                    <option value="24" selected>24</option>
                    <option value="30">30</option>
                    <option value="60">60</option>
                </select>
            </div>
        </div>

        <!-- منطقة الرسم -->
        <div class="canvas-container" id="canvas-container">
            <canvas id="main-canvas"></canvas>
            <div id="rigs-container" class="rigs-container"></div>
        </div>

        <!-- شريط الأدوات السفلي - 3 مجموعات -->
        <div class="bottom-toolbar">
            <!-- المجموعة الأولى: أدوات الرسم -->
            <div class="tools-group">
                <button class="group-btn" onclick="toggleToolsMenu('drawing')" title="أدوات الرسم">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path d="M12 19l7-7 3 3-7 7-3-3z" fill="none" stroke="currentColor" stroke-width="2"/>
                        <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z" fill="none" stroke="currentColor" stroke-width="2"/>
                        <path d="M2 2l7.586 7.586" stroke="currentColor" stroke-width="2"/>
                        <circle cx="11" cy="11" r="2" fill="currentColor"/>
                    </svg>
                    <span>الرسم</span>
                </button>
            </div>

            <!-- المجموعة الثانية: التحويل والتعديل -->
            <div class="tools-group">
                <button class="group-btn" onclick="toggleToolsMenu('transform')" title="التحويل والتعديل">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" fill="none" stroke="currentColor" stroke-width="2"/>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96" fill="none" stroke="currentColor" stroke-width="2"/>
                        <line x1="12" y1="22.08" x2="12" y2="12" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <span>تحويل</span>
                </button>
            </div>

            <!-- المجموعة الثالثة: الطبقات والهياكل -->
            <div class="tools-group">
                <button class="group-btn" onclick="toggleToolsMenu('layers')" title="الطبقات والهياكل">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <polygon points="12 2 2 7 12 12 22 7 12 2" fill="none" stroke="currentColor" stroke-width="2"/>
                        <polyline points="2 17 12 22 22 17" fill="none" stroke="currentColor" stroke-width="2"/>
                        <polyline points="2 12 12 17 22 12" fill="none" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <span>طبقات</span>
                </button>
            </div>

            <!-- اختيار اللون -->
            <div class="color-section">
                <button class="color-btn" id="current-color-btn" onclick="toggleColorPicker()" title="اختيار اللون">
                    <div class="color-preview" style="background: #000000;"></div>
                </button>
                <input type="text" id="color-code-input" class="color-code-input" placeholder="#000000" maxlength="7" onchange="setColorFromInput(this.value)">
            </div>
        </div>

        <!-- قوائم الأدوات المنبثقة -->
        <!-- قائمة أدوات الرسم -->
        <div id="drawing-menu" class="tools-menu">
            <div class="menu-header">
                <h3>أدوات الرسم</h3>
                <button class="close-btn" onclick="closeToolsMenu()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="tools-grid" id="drawing-tools-grid"></div>
        </div>

        <!-- قائمة التحويل -->
        <div id="transform-menu" class="tools-menu">
            <div class="menu-header">
                <h3>التحويل والتعديل</h3>
                <button class="close-btn" onclick="closeToolsMenu()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="tools-grid" id="transform-tools-grid"></div>
        </div>

        <!-- قائمة الطبقات -->
        <div id="layers-menu" class="tools-menu">
            <div class="menu-header">
                <h3>الطبقات والهياكل</h3>
                <button class="close-btn" onclick="closeToolsMenu()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="layers-controls">
                <button class="layer-action-btn" onclick="addLayer()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    طبقة جديدة
                </button>
                <button class="layer-action-btn" onclick="toggleRigMode()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                    </svg>
                    وضع العظام
                </button>
            </div>
            <div id="layers-list" class="layers-list"></div>
            <div class="layers-merge">
                <button class="merge-btn" onclick="mergeSelectedLayers()">دمج الطبقات المحددة</button>
            </div>
        </div>

        <!-- منتقي الألوان -->
        <div id="color-picker" class="color-picker-popup">
            <div class="color-wheel-container">
                <canvas id="color-wheel" width="200" height="200"></canvas>
                <div class="color-values">
                    <div class="color-input-group">
                        <label>HEX:</label>
                        <input type="text" id="hex-input" maxlength="7" value="#000000">
                    </div>
                    <div class="color-input-group">
                        <label>RGB:</label>
                        <input type="text" id="rgb-input" value="0, 0, 0">
                    </div>
                </div>
                <div class="opacity-control">
                    <label>الشفافية: <span id="opacity-value">100%</span></label>
                    <input type="range" id="opacity-slider" min="0" max="100" value="100">
                </div>
            </div>
            <div class="color-presets">
                <div class="color-preset" style="background: #000000" onclick="setColor('#000000')"></div>
                <div class="color-preset" style="background: #ffffff" onclick="setColor('#ffffff')"></div>
                <div class="color-preset" style="background: #ff0000" onclick="setColor('#ff0000')"></div>
                <div class="color-preset" style="background: #00ff00" onclick="setColor('#00ff00')"></div>
                <div class="color-preset" style="background: #0000ff" onclick="setColor('#0000ff')"></div>
                <div class="color-preset" style="background: #ffff00" onclick="setColor('#ffff00')"></div>
                <div class="color-preset" style="background: #ff00ff" onclick="setColor('#ff00ff')"></div>
                <div class="color-preset" style="background: #00ffff" onclick="setColor('#00ffff')"></div>
                <div class="color-preset" style="background: #ffa500" onclick="setColor('#ffa500')"></div>
                <div class="color-preset" style="background: #800080" onclick="setColor('#800080')"></div>
                <div class="color-preset" style="background: #ffc0cb" onclick="setColor('#ffc0cb')"></div>
                <div class="color-preset" style="background: #a52a2a" onclick="setColor('#a52a2a')"></div>
            </div>
        </div>

        <!-- خيارات التنزيل -->
        <div id="download-options" class="download-popup">
            <h3>خيارات التصدير</h3>
            <div class="download-quality">
                <label>الجودة:</label>
                <select id="export-quality">
                    <option value="1">عادية (1x)</option>
                    <option value="2" selected>عالية (2x)</option>
                    <option value="4">4K (4x)</option>
                </select>
            </div>
            <div class="download-bg">
                <label>الخلفية:</label>
                <div class="bg-options">
                    <button class="bg-option active" onclick="setExportBG('white')" data-bg="white">
                        <div class="bg-preview" style="background:white;"></div>
                        <span>بيضاء</span>
                    </button>
                    <button class="bg-option" onclick="setExportBG('transparent')" data-bg="transparent">
                        <div class="bg-preview" style="background:linear-gradient(45deg,#ccc 25%,transparent 25%),linear-gradient(-45deg,#ccc 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#ccc 75%),linear-gradient(-45deg,transparent 75%,#ccc 75%);background-size:10px 10px;background-position:0 0,0 5px,5px -5px,-5px 0px;"></div>
                        <span>شفافة</span>
                    </button>
                </div>
            </div>
            <div class="download-format">
                <label>الصيغة:</label>
                <select id="export-format">
                    <option value="png">PNG</option>
                    <option value="jpg">JPG</option>
                </select>
            </div>
            <button class="download-btn" onclick="confirmDownload()">تنزيل الملف</button>
        </div>

        <!-- إدخال اللون بالكود -->
        <div id="color-input-popup" class="color-input-popup">
            <h3>إدخال اللون</h3>
            <div class="input-methods">
                <div class="input-method">
                    <label>HEX:</label>
                    <input type="text" id="manual-hex" placeholder="#667eea" maxlength="7">
                </div>
                <div class="input-method">
                    <label>RGB:</label>
                    <input type="text" id="manual-rgb" placeholder="102, 126, 234">
                </div>
                <div class="input-method">
                    <label>HSL:</label>
                    <input type="text" id="manual-hsl" placeholder="230, 70%, 66%">
                </div>
            </div>
            <button class="apply-color-btn" onclick="applyManualColor()">تطبيق اللون</button>
        </div>

        <input type="file" id="image-import" accept="image/*" style="display: none;" onchange="handleImageImport(event)">
    </div>

    <script src="script.js"></script>
</body>
</html>