
# ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ© ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ© ŸÖÿπ ÿØÿπŸÖ ÿßŸÑŸÅŸäÿØŸäŸà ŸàÿßŸÑÿ¥ÿÆÿµŸäÿ© ÿßŸÑŸÖÿ™ÿ≠ÿ±ŸÉÿ©

final_game = '''<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="screen-orientation" content="landscape">
    <title>KIM ROYALE - ÿ®ÿßÿ™ŸÑ ÿ±ŸàŸäÿßŸÑ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            font-family: 'Tajawal', sans-serif;
        }
        
        body {
            overflow: hidden;
            background: #000;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        /* ŸÅŸäÿØŸäŸà ÿßŸÑÿÆŸÑŸÅŸäÿ© ŸÑŸÑŸàÿ®Ÿä */
        #lobbyVideo {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }
        
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(15,32,39,0.8), rgba(32,58,67,0.9), rgba(44,83,100,0.8));
            z-index: 1;
        }
        
        /* ÿßŸÑŸÑŸàÿ®Ÿä ÿßŸÑŸÖÿ≠ÿ™ÿ±ŸÅ */
        #lobby {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .lobby-header {
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10;
            background: linear-gradient(180deg, rgba(0,0,0,0.8), transparent);
        }
        
        .logo {
            font-size: 56px;
            font-weight: 900;
            background: linear-gradient(45deg, #FFD700, #FFA500, #FF6347, #FFD700);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255,215,0,0.5);
            letter-spacing: 4px;
            animation: gradient 3s ease infinite;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .player-profile {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-radius: 50px;
            border: 2px solid rgba(255,215,0,0.4);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .avatar-container {
            position: relative;
            width: 60px;
            height: 60px;
        }
        
        .avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: 3px solid #FFD700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 0 20px rgba(255,215,0,0.4);
        }
        
        .level-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #FFD700;
            color: #000;
            font-weight: 900;
            font-size: 12px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #fff;
        }
        
        .player-info {
            color: #fff;
        }
        
        .player-name {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .player-rank {
            font-size: 16px;
            color: #FFD700;
            font-weight: 700;
        }
        
        /* ŸÖŸÜÿ∑ŸÇÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿÆÿµŸäÿ© */
        .lobby-content {
            flex: 1;
            display: flex;
            position: relative;
            z-index: 10;
            padding: 0 50px;
        }
        
        .character-stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            position: relative;
            padding-bottom: 50px;
        }
        
        /* ÿ≠ÿßŸàŸäÿ© ÿßŸÑÿ¥ÿÆÿµŸäÿ© 3D */
        #characterContainer {
            width: 400px;
            height: 600px;
            position: relative;
            margin-bottom: 30px;
        }
        
        /* ŸÖŸÜÿµÿ© ÿßŸÑÿπÿ±ÿ∂ */
        .platform {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 60px;
            background: radial-gradient(ellipse at center, rgba(255,215,0,0.3), transparent);
            border-radius: 50%;
            filter: blur(10px);
        }
        
        /* ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿßŸÑÿ¥ÿÆÿµŸäÿ© */
        .character-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .control-btn-small {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,215,0,0.4);
            color: #FFD700;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn-small:hover {
            background: rgba(255,215,0,0.2);
            transform: scale(1.1);
        }
        
        .control-btn-small.active {
            background: rgba(255,215,0,0.4);
            box-shadow: 0 0 20px rgba(255,215,0,0.5);
        }
        
        /* ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≥ŸÉŸÜÿßÿ™ */
        .skins-panel {
            position: absolute;
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            width: 350px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 30px;
            border: 1px solid rgba(255,215,0,0.2);
        }
        
        .panel-title {
            font-size: 24px;
            color: #FFD700;
            font-weight: 800;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .skin-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .skin-item {
            aspect-ratio: 1;
            border-radius: 15px;
            border: 3px solid transparent;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
        }
        
        .skin-item:hover {
            transform: translateY(-5px);
        }
        
        .skin-item.selected {
            border-color: #FFD700;
            box-shadow: 0 0 30px rgba(255,215,0,0.4);
        }
        
        .skin-item.locked {
            opacity: 0.6;
        }
        
        .skin-preview {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }
        
        .skin-name {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            text-align: center;
            color: #fff;
            font-weight: 700;
            font-size: 14px;
            background: rgba(0,0,0,0.7);
            padding: 5px;
        }
        
        /* ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ŸÇÿµÿßÿ™ */
        .emote-wheel {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .emote-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,215,0,0.3);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 11px;
            transition: all 0.3s;
        }
        
        .emote-btn:hover {
            background: rgba(255,215,0,0.2);
            transform: scale(1.1);
        }
        
        .emote-icon {
            font-size: 24px;
            margin-bottom: 2px;
        }
        
        /* ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≥ŸÅŸÑŸäÿ© */
        .lobby-footer {
            padding: 30px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10;
            background: linear-gradient(0deg, rgba(0,0,0,0.9), transparent);
        }
        
        .menu-grid {
            display: flex;
            gap: 20px;
        }
        
        .menu-btn {
            padding: 20px 40px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-settings {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .btn-settings:hover {
            background: rgba(255,255,255,0.2);
            border-color: #FFD700;
        }
        
        .btn-play {
            background: linear-gradient(135deg, #FFD700, #FF8C00);
            color: #000;
            font-size: 28px;
            padding: 25px 60px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255,140,0,0.5);
            position: relative;
            overflow: hidden;
        }
        
        .btn-play:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(255,140,0,0.7);
        }
        
        .btn-play::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            animation: shine 2s infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
        
        /* ÿ£ÿ≤ÿ±ÿßÿ± ÿ¨ÿßŸÜÿ®Ÿäÿ© */
        .side-buttons {
            position: absolute;
            left: 50px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 10;
        }
        
        .side-btn {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,215,0,0.3);
            color: #FFD700;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .side-btn:hover {
            background: rgba(255,215,0,0.2);
            transform: scale(1.1);
        }
        
        /* ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ */
        #loadingScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .loading-logo {
            font-size: 72px;
            font-weight: 900;
            color: #FFD700;
            margin-bottom: 50px;
            text-shadow: 0 0 50px rgba(255,215,0,0.5);
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .loading-container {
            width: 500px;
            max-width: 80%;
        }
        
        .loading-bar {
            height: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 20px rgba(255,215,0,0.2);
        }
        
        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500, #FFD700);
            background-size: 200% 100%;
            width: 0%;
            transition: width 0.3s;
            animation: loadingShine 2s infinite;
            box-shadow: 0 0 20px rgba(255,215,0,0.5);
        }
        
        @keyframes loadingShine {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .loading-text {
            color: #fff;
            font-size: 20px;
            margin-top: 20px;
            text-align: center;
            font-weight: 700;
        }
        
        .loading-tips {
            color: rgba(255,255,255,0.6);
            font-size: 16px;
            margin-top: 10px;
            text-align: center;
        }
        
        /* Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÑÿπÿ®ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© */
        #gameUI {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
            overflow: hidden;
        }
        
        /* ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÑŸàŸä */
        .top-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 30px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(20px);
            padding: 15px 40px;
            border-radius: 50px;
            border: 1px solid rgba(255,215,0,0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .stat-box {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fff;
            font-weight: 700;
            font-size: 20px;
        }
        
        .stat-icon {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .stat-value {
            color: #FFD700;
            font-size: 24px;
            font-weight: 900;
        }
        
        /* ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ÿßŸÑÿØÿßÿ¶ÿ±Ÿäÿ© */
        .map-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 180px;
            height: 180px;
            pointer-events: auto;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .map-container:hover {
            transform: scale(1.1);
        }
        
        .minimap {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(46,125,50,0.8), rgba(27,94,32,0.9));
            border: 4px solid #FFD700;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 30px rgba(255,215,0,0.4);
        }
        
        .minimap-zone {
            position: absolute;
            border: 3px solid rgba(255,255,255,0.8);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }
        
        .minimap-danger {
            position: absolute;
            border: 3px solid rgba(255,0,0,0.8);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(255,0,0,0.4);
        }
        
        .minimap-player {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #00ff00;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid #fff;
            box-shadow: 0 0 10px #00ff00;
            z-index: 10;
        }
        
        .minimap-direction {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 12px solid #00ff00;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
            margin-top: -8px;
        }
        
        /* ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© */
        .zone-info {
            position: absolute;
            top: 210px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255,0,0,0.5);
            color: #fff;
            text-align: center;
            min-width: 180px;
        }
        
        .zone-title {
            font-size: 14px;
            color: #ff6666;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .zone-timer {
            font-size: 32px;
            font-weight: 900;
            color: #ff0000;
            text-shadow: 0 0 10px rgba(255,0,0,0.5);
        }
        
        /* ÿ£ÿ¥ÿ±ÿ∑ÿ© ÿßŸÑÿµÿ≠ÿ© ŸàÿßŸÑÿØÿ±ÿπ */
        .health-section {
            position: absolute;
            bottom: 150px;
            left: 30px;
            width: 250px;
        }
        
        .bar-container {
            margin-bottom: 10px;
            position: relative;
        }
        
        .bar-label {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #fff;
            font-weight: 800;
            font-size: 14px;
            z-index: 10;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .bar-bg {
            height: 20px;
            background: rgba(0,0,0,0.6);
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ff6600, #ffcc00);
            width: 100%;
            transition: width 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .health-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .armor-fill {
            height: 100%;
            background: linear-gradient(90deg, #0066cc, #00ccff, #66ffff);
            width: 100%;
            transition: width 0.3s;
        }
        
        /* ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≥ŸÑÿßÿ≠ */
        .weapon-panel {
            position: absolute;
            bottom: 150px;
            right: 30px;
            text-align: right;
        }
        
        .ammo-display {
            display: flex;
            align-items: baseline;
            gap: 10px;
            color: #fff;
            margin-bottom: 5px;
        }
        
        .ammo-current {
            font-size: 64px;
            font-weight: 900;
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255,215,0,0.5);
            line-height: 1;
        }
        
        .ammo-total {
            font-size: 32px;
            color: #aaa;
            font-weight: 700;
        }
        
        .weapon-name {
            font-size: 20px;
            color: #fff;
            font-weight: 800;
            background: rgba(0,0,0,0.6);
            padding: 8px 20px;
            border-radius: 10px;
            display: inline-block;
            border: 1px solid rgba(255,215,0,0.3);
        }
        
        .weapon-mode {
            font-size: 14px;
            color: #FFD700;
            margin-top: 5px;
            font-weight: 700;
        }
        
        /* ÿßŸÑÿ¨ŸàŸäÿ≥ÿ™ŸäŸÉ */
        .joystick-container {
            position: absolute;
            bottom: 100px;
            left: 100px;
            width: 180px;
            height: 180px;
            pointer-events: auto;
        }
        
        .joystick-base {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        
        .joystick-knob {
            position: absolute;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 5px 20px rgba(255,140,0,0.5);
            transition: transform 0.1s;
        }
        
        /* ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© */
        .controls-right {
            position: absolute;
            bottom: 100px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: auto;
        }
        
        .btn-control {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.4);
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            color: #fff;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .btn-control:active {
            transform: scale(0.95);
            background: rgba(255,215,0,0.3);
        }
        
        .btn-fire {
            width: 110px;
            height: 110px;
            background: rgba(255,0,0,0.2);
            border-color: rgba(255,0,0,0.6);
            font-size: 40px;
        }
        
        .btn-fire.active {
            background: rgba(255,0,0,0.4);
            box-shadow: 0 0 30px rgba(255,0,0,0.6);
            animation: firePulse 0.1s;
        }
        
        @keyframes firePulse {
            0% { transform: scale(1); }
            50% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        
        .btn-ads {
            width: 80px;
            height: 80px;
            position: absolute;
            bottom: 230px;
            right: 40px;
        }
        
        .action-buttons {
            position: absolute;
            bottom: 30px;
            right: 150px;
            display: flex;
            gap: 10px;
            pointer-events: auto;
        }
        
        .btn-action {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.5);
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
        }
        
        .btn-action span {
            font-size: 10px;
            font-weight: 700;
        }
        
        .btn-action:active {
            transform: scale(0.95);
            background: rgba(255,215,0,0.3);
        }
        
        /* ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ÿßŸÑŸÉÿ®Ÿäÿ±ÿ© */
        #bigMapScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            z-index: 500;
            pointer-events: auto;
        }
        
        .map-header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 20px 40px;
            border-radius: 20px;
            border: 2px solid #FFD700;
            color: #FFD700;
            font-size: 32px;
            font-weight: 900;
            z-index: 510;
        }
        
        .map-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(255,0,0,0.8);
            border: 3px solid #ff6666;
            border-radius: 50%;
            color: #fff;
            font-size: 28px;
            cursor: pointer;
            z-index: 510;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .map-close:hover {
            transform: scale(1.1);
            background: rgba(255,0,0,1);
        }
        
        #bigMapCanvas {
            width: 100%;
            height: 100%;
        }
        
        /* ÿ•ÿπÿØÿßÿØÿßÿ™ */
        #settingsPanel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            background: rgba(0,0,0,0.95);
            border: 3px solid #FFD700;
            border-radius: 30px;
            padding: 40px;
            display: none;
            z-index: 2000;
            overflow-y: auto;
            box-shadow: 0 0 50px rgba(255,215,0,0.3);
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255,215,0,0.3);
        }
        
        .settings-title {
            font-size: 36px;
            color: #FFD700;
            font-weight: 900;
        }
        
        .settings-close {
            width: 50px;
            height: 50px;
            background: rgba(255,0,0,0.8);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .setting-card {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .setting-label {
            color: #fff;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            display: block;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .slider-value {
            color: #FFD700;
            font-weight: 900;
            font-size: 20px;
            min-width: 50px;
            text-align: center;
        }
        
        input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 10px;
            border-radius: 5px;
            background: rgba(255,255,255,0.2);
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #FFD700;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255,215,0,0.8);
        }
        
        .difficulty-select {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .diff-btn {
            flex: 1;
            min-width: 80px;
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.3);
            background: transparent;
            color: #fff;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
        }
        
        .diff-btn.active {
            background: #FFD700;
            color: #000;
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255,215,0,0.5);
        }
        
        /* ŸÜŸáÿßŸäÿ© ÿßŸÑŸÑÿπÿ®ÿ© */
        #endScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .result-title {
            font-size: 120px;
            font-weight: 900;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 10px;
        }
        
        .victory {
            background: linear-gradient(45deg, #FFD700, #FFA500, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 100px rgba(255,215,0,0.8);
            animation: victoryGlow 2s ease-in-out infinite;
        }
        
        @keyframes victoryGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }
        
        .defeat {
            color: #ff0000;
            text-shadow: 0 0 50px rgba(255,0,0,0.8);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin: 40px 0;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid rgba(255,215,0,0.3);
        }
        
        .stat-number {
            font-size: 48px;
            font-weight: 900;
            color: #FFD700;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #aaa;
            font-size: 18px;
            font-weight: 700;
        }
        
        .btn-restart {
            padding: 25px 80px;
            font-size: 28px;
            background: linear-gradient(135deg, #FFD700, #FF8C00);
            border: none;
            border-radius: 20px;
            color: #000;
            font-weight: 900;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(255,140,0,0.5);
            transition: all 0.3s;
        }
        
        .btn-restart:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(255,140,0,0.7);
        }
        
        /* ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ */
        .notification {
            position: absolute;
            top: 150px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(0,0,0,0.9);
            color: #FFD700;
            padding: 20px 40px;
            border-radius: 15px;
            border: 2px solid #FFD700;
            font-size: 20px;
            font-weight: 800;
            opacity: 0;
            transition: all 0.3s;
            z-index: 400;
            box-shadow: 0 0 30px rgba(255,215,0,0.3);
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ∂ÿ±ÿ± */
        .damage-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 30%, rgba(255,0,0,0.3) 100%);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 300;
        }
        
        .damage-overlay.show {
            opacity: 1;
        }
        
        /* ÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ÿßŸÑÿ±ÿµÿßÿµ */
        .hit-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            pointer-events: none;
            opacity: 0;
        }
        
        .hit-marker.active {
            animation: hitMark 0.2s ease-out;
        }
        
        @keyframes hitMark {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }
        
        /* Crosshair */
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 200;
        }
        
        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background: rgba(255,215,0,0.8);
        }
        
        .crosshair::before {
            width: 2px;
            height: 20px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .crosshair::after {
            width: 20px;
            height: 2px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        /* ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸáÿ±Ÿàÿ® */
        #pauseMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2500;
            backdrop-filter: blur(10px);
        }
        
        .pause-title {
            font-size: 64px;
            color: #FFD700;
            font-weight: 900;
            margin-bottom: 50px;
        }
        
        .pause-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .pause-btn {
            padding: 20px 60px;
            font-size: 24px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,215,0,0.4);
            border-radius: 15px;
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 300px;
        }
        
        .pause-btn:hover {
            background: rgba(255,215,0,0.2);
            transform: scale(1.05);
        }
        
        .pause-btn.exit {
            background: rgba(255,0,0,0.3);
            border-color: rgba(255,0,0,0.6);
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <!-- ŸÅŸäÿØŸäŸà ÿßŸÑÿÆŸÑŸÅŸäÿ© ŸÑŸÑŸàÿ®Ÿä -->
    <video id="lobbyVideo" autoplay muted loop playsinline>
        <source src="lobby_video.mp4" type="video/mp4">
        <source src="background.mp4" type="video/mp4">
        <!-- fallback -->
    </video>
    <div class="video-overlay"></div>
    
    <!-- ÿßŸÑŸÑŸàÿ®Ÿä ÿßŸÑŸÖÿ≠ÿ™ÿ±ŸÅ -->
    <div id="lobby">
        <div class="lobby-header">
            <div class="logo">KIM ROYALE</div>
            <div class="player-profile">
                <div class="player-info">
                    <div class="player-name">Mohammed</div>
                    <div class="player-rank">2500 ‚òÖ Crown</div>
                </div>
                <div class="avatar-container">
                    <div class="avatar" id="lobbyAvatar">üë§</div>
                    <div class="level-badge">50</div>
                </div>
            </div>
        </div>
        
        <div class="side-buttons">
            <button class="side-btn" onclick="openSettings()" title="ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™">‚öô</button>
            <button class="side-btn" title="ÿßŸÑŸÖÿ™ÿ¨ÿ±">üõí</button>
            <button class="side-btn" title="ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤ÿßÿ™">üèÜ</button>
            <button class="side-btn" title="ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°">üë•</button>
        </div>
        
        <div class="lobby-content">
            <div class="character-stage">
                <div id="characterContainer">
                    <canvas id="characterCanvas" width="400" height="600"></canvas>
                    <div class="platform"></div>
                </div>
                
                <div class="character-controls">
                    <button class="control-btn-small active" onclick="rotateCharacter('left')">‚Ü∫</button>
                    <button class="control-btn-small" onclick="playEmote('dance')">üíÉ</button>
                    <button class="control-btn-small" onclick="playEmote('wave')">üëã</button>
                    <button class="control-btn-small" onclick="playEmote('cheer')">üéâ</button>
                    <button class="control-btn-small" onclick="rotateCharacter('right')">‚Üª</button>
                </div>
            </div>
            
            <div class="skins-panel">
                <div class="panel-title">ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ≤Ÿä</div>
                <div class="skin-grid">
                    <div class="skin-item selected" onclick="selectSkin(0)">
                        <div class="skin-preview">üéñ</div>
                        <div class="skin-name">ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä</div>
                    </div>
                    <div class="skin-item" onclick="selectSkin(1)">
                        <div class="skin-preview">ü¶∏</div>
                        <div class="skin-name">ÿßŸÑÿπÿ≥ŸÉÿ±Ÿä</div>
                    </div>
                    <div class="skin-item" onclick="selectSkin(2)">
                        <div class="skin-preview">ü§†</div>
                        <div class="skin-name">ÿßŸÑŸÉÿßŸàÿ®ŸàŸä</div>
                    </div>
                    <div class="skin-item locked" onclick="selectSkin(3)">
                        <div class="skin-preview">ü•∑</div>
                        <div class="skin-name">ÿßŸÑŸÜŸäŸÜÿ¨ÿß</div>
                    </div>
                </div>
                
                <div class="panel-title" style="margin-top: 20px;">ÿßŸÑÿ±ŸÇÿµÿßÿ™</div>
                <div class="emote-wheel">
                    <div class="emote-btn" onclick="playEmote('dance1')">
                        <div class="emote-icon">üï∫</div>
                        <div>ÿ±ŸÇÿµ 1</div>
                    </div>
                    <div class="emote-btn" onclick="playEmote('dance2')">
                        <div class="emote-icon">üíÉ</div>
                        <div>ÿ±ŸÇÿµ 2</div>
                    </div>
                    <div class="emote-btn" onclick="playEmote('salute')">
                        <div class="emote-icon">ü´°</div>
                        <div>ÿ™ÿ≠Ÿäÿ©</div>
                    </div>
                    <div class="emote-btn" onclick="playEmote('laugh')">
                        <div class="emote-icon">üòÇ</div>
                        <div>ÿ∂ÿ≠ŸÉ</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="lobby-footer">
            <div class="menu-grid">
                <button class="menu-btn btn-settings" onclick="openSettings()">
                    <span>‚öô</span> ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
                </button>
                <button class="menu-btn btn-settings">
                    <span>üìä</span> ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
                </button>
            </div>
            
            <button class="menu-btn btn-play" onclick="startGame()">
                <span>üéÆ</span> KIM ENTRY
            </button>
        </div>
    </div>
    
    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ -->
    <div id="loadingScreen">
        <div class="loading-logo">KIM ROYALE</div>
        <div class="loading-container">
            <div class="loading-bar">
                <div class="loading-progress" id="loadingProgress"></div>
            </div>
            <div class="loading-text">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿßÿ≠ÿ© ÿßŸÑŸÖÿπÿ±ŸÉÿ©...</div>
            <div class="loading-tips">ÿ™ŸÑŸÖŸäÿ≠: ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ∫ÿ∑ÿßÿ° ŸÑŸÑÿ≠ŸÖÿßŸäÿ© ŸÖŸÜ ÿßŸÑŸÜŸäÿ±ÿßŸÜ</div>
        </div>
    </div>
    
    <!-- Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÑÿπÿ®ÿ© -->
    <div id="gameUI">
        <div class="damage-overlay" id="damageOverlay"></div>
        
        <div class="top-bar">
            <div class="stat-box">
                <div class="stat-icon">üë•</div>
                <div>ÿßŸÑŸÖÿ™ÿ®ŸÇŸàŸÜ:</div>
                <div class="stat-value" id="playersLeft">16</div>
            </div>
            <div class="stat-box">
                <div class="stat-icon">üíÄ</div>
                <div>ÿßŸÑŸÇÿ™ŸÑ:</div>
                <div class="stat-value" id="killCount">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-icon">‚è±</div>
                <div>ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©:</div>
                <div class="stat-value" id="zoneTimer">60</div>
            </div>
        </div>
        
        <div class="map-container" onclick="toggleBigMap()">
            <div class="minimap">
                <div class="minimap-zone" id="minimapSafeZone" style="width: 120px; height: 120px;"></div>
                <div class="minimap-danger" id="minimapDangerZone" style="width: 150px; height: 150px;"></div>
                <div class="minimap-player"></div>
                <div class="minimap-direction"></div>
            </div>
        </div>
        
        <div class="zone-info">
            <div class="zone-title">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¢ŸÖŸÜÿ© ÿ™ÿ™ŸÇŸÑÿµ!</div>
            <div class="zone-timer" id="zoneTimerDisplay">59</div>
        </div>
        
        <div class="crosshair" id="crosshair"></div>
        <div class="hit-marker" id="hitMarker">‚ùå</div>
        
        <div class="health-section">
            <div class="bar-container">
                <span class="bar-label">HP</span>
                <div class="bar-bg">
                    <div class="health-fill" id="healthBar" style="width: 100%;"></div>
                </div>
            </div>
            <div class="bar-container">
                <span class="bar-label"> armor</span>
                <div class="bar-bg">
                    <div class="armor-fill" id="armorBar" style="width: 100%;"></div>
                </div>
            </div>
        </div>
        
        <div class="weapon-panel">
            <div class="ammo-display">
                <div class="ammo-current" id="currentAmmo">30</div>
                <div class="ammo-total" id="totalAmmo">/ 120</div>
            </div>
            <div class="weapon-name" id="weaponName">M416</div>
            <div class="weapon-mode" id="fireMode">Auto</div>
        </div>
        
        <div class="joystick-container" id="moveJoystick">
            <div class="joystick-base"></div>
            <div class="joystick-knob" id="moveKnob"></div>
        </div>
        
        <button class="btn-control btn-ads" id="adsBtn" onclick="toggleADS()">üëÅ</button>
        
        <div class="controls-right">
            <button class="btn-control btn-fire" id="fireBtn" ontouchstart="startFiring()" ontouchend="stopFiring()">üî•</button>
        </div>
        
        <div class="action-buttons">
            <button class="btn-action" onclick="jump()">
                <span>Jump</span>
                ‚Ü•
            </button>
            <button class="btn-action" onclick="toggleCrouch()">
                <span>Crouch</span>
                ü†ó
            </button>
            <button class="btn-action" onclick="toggleProne()">
                <span>Prone</span>
                ‚¨≥
            </button>
            <button class="btn-action" onclick="reload()">
                <span>Reload</span>
                ‚Üª
            </button>
            <button class="btn-action" onclick="switchWeapon()">
                <span>Switch</span>
                ‚áÑ
            </button>
        </div>
        
        <div class="notification" id="notification"></div>
    </div>
    
    <!-- ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ÿßŸÑŸÉÿ®Ÿäÿ±ÿ© -->
    <div id="bigMapScreen">
        <div class="map-header">ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©</div>
        <button class="map-close" onclick="toggleBigMap()">‚úï</button>
        <canvas id="bigMapCanvas"></canvas>
    </div>
    
    <!-- ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ -->
    <div id="settingsPanel">
        <div class="settings-header">
            <div class="settings-title">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</div>
            <button class="settings-close" onclick="closeSettings()">‚úï</button>
        </div>
        
        <div class="settings-grid">
            <div class="setting-card">
                <label class="setting-label">ÿ≠ÿ¨ŸÖ ÿßŸÑÿ¨ŸàŸäÿ≥ÿ™ŸäŸÉ</label>
                <div class="slider-container">
                    <input type="range" min="100" max="250" value="180" id="joystickSizeSlider" oninput="updateSetting('joystick', this.value)">
                    <div class="slider-value" id="joystickSizeValue">180</div>
                </div>
            </div>
            
            <div class="setting-card">
                <label class="setting-label">ÿ≠ÿ≥ÿßÿ≥Ÿäÿ© ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß</label>
                <div class="slider-container">
                    <input type="range" min="1" max="10" value="5" id="sensitivitySlider" oninput="updateSetting('sensitivity', this.value)">
                    <div class="slider-value" id="sensitivityValue">5</div>
                </div>
            </div>
            
            <div class="setting-card">
                <label class="setting-label">ÿ≠ÿ¨ŸÖ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±</label>
                <div class="slider-container">
                    <input type="range" min="60" max="120" value="90" id="btnSizeSlider" oninput="updateSetting('btnSize', this.value)">
                    <div class="slider-value" id="btnSizeValue">90</div>
                </div>
            </div>
            
            <div class="setting-card">
                <label class="setting-label">ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿµÿπŸàÿ®ÿ©</label>
                <div class="difficulty-select">
                    <button class="diff-btn" onclick="setDifficulty('easy')">ÿ≥ŸáŸÑ</button>
                    <button class="diff-btn active" onclick="setDifficulty('medium')">ŸÖÿ™Ÿàÿ≥ÿ∑</button>
                    <button class="diff-btn" onclick="setDifficulty('hard')">ÿµÿπÿ®</button>
                    <button class="diff-btn" onclick="setDifficulty('expert')">ÿÆÿ®Ÿäÿ±</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ•ŸäŸÇÿßŸÅ -->
    <div id="pauseMenu">
        <div class="pause-title">ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ™ŸàŸÇŸÅ</div>
        <div class="pause-buttons">
            <button class="pause-btn" onclick="resumeGame()">ŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑŸÑÿπÿ®</button>
            <button class="pause-btn" onclick="openSettings()">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</button>
            <button class="pause-btn exit" onclick="exitToLobby()">ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÑŸÑŸàÿ®Ÿä</button>
        </div>
    </div>
    
    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÜŸáÿßŸäÿ© -->
    <div id="endScreen">
        <div class="result-title victory" id="endTitle">ÿßŸÜÿ™ÿµÿ±ÿ™!</div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="endKills">0</div>
                <div class="stat-label">ÿßŸÑŸÇÿ™ŸÑ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="endDamage">0</div>
                <div class="stat-label">ÿßŸÑÿ∂ÿ±ÿ±</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="endRank">#1</div>
                <div class="stat-label">ÿßŸÑŸÖÿ±ŸÉÿ≤</div>
            </div>
        </div>
        <button class="btn-restart" onclick="exitToLobby()">ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑŸàÿ®Ÿä</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ======== ŸÜÿ∏ÿßŸÖ ÿßŸÑÿµŸàÿ™ ÿßŸÑÿßÿ≠ÿ™ÿ±ÿßŸÅŸä ========
        const AudioSystem = {
            ctx: null,
            sounds: {},
            
            init() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.masterGain = this.ctx.createGain();
                this.masterGain.connect(this.ctx.destination);
                this.masterGain.gain.value = 0.8;
            },
            
            // ÿ•ŸÜÿ¥ÿßÿ° ÿµŸàÿ™ ÿ•ÿ∑ŸÑÿßŸÇ ŸÜÿßÿ± ŸàÿßŸÇÿπŸä
            playGunshot() {
                if (!this.ctx) return;
                const t = this.ctx.currentTime;
                
                // 1. ÿßŸÑÿ∑ÿ®ŸÇÿ© ÿßŸÑÿ£ŸàŸÑŸâ - ÿßŸÑÿßŸÜŸÅÿ¨ÿßÿ± ÿßŸÑÿπŸÖŸäŸÇ
                const osc1 = this.ctx.createOscillator();
                const gain1 = this.ctx.createGain();
                const filter1 = this.ctx.createBiquadFilter();
                
                osc1.type = 'sawtooth';
                osc1.frequency.setValueAtTime(200, t);
                osc1.frequency.exponentialRampToValueAtTime(50, t + 0.1);
                
                filter1.type = 'lowpass';
                filter1.frequency.setValueAtTime(3000, t);
                filter1.frequency.exponentialRampToValueAtTime(200, t + 0.15);
                
                osc1.connect(filter1);
                filter1.connect(gain1);
                gain1.connect(this.masterGain);
                
                gain1.gain.setValueAtTime(0.4, t);
                gain1.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
                
                osc1.start(t);
                osc1.stop(t + 0.2);
                
                // 2. ÿßŸÑÿ∑ÿ®ŸÇÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ© - ÿßŸÑÿ∂ÿ¨Ÿäÿ¨
                const bufferSize = this.ctx.sampleRate * 0.2;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (this.ctx.sampleRate * 0.03));
                }
                
                const noise = this.ctx.createBufferSource();
                const noiseFilter = this.ctx.createBiquadFilter();
                const noiseGain = this.ctx.createGain();
                
                noise.buffer = buffer;
                noiseFilter.type = 'bandpass';
                noiseFilter.frequency.value = 800;
                noiseFilter.Q.value = 0.5;
                
                noise.connect(noiseFilter);
                noiseFilter.connect(noiseGain);
                noiseGain.connect(this.masterGain);
                
                noiseGain.gain.setValueAtTime(0.3, t);
                noiseGain.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
                
                noise.start(t);
                
                // 3. ÿßŸÑÿµÿØŸâ
                const echoDelay = this.ctx.createDelay();
                const echoGain = this.ctx.createGain();
                echoDelay.delayTime.value = 0.08;
                echoGain.gain.value = 0.2;
                
                noiseFilter.connect(echoDelay);
                echoDelay.connect(echoGain);
                echoGain.connect(this.masterGain);
            },
            
            playReload() {
                if (!this.ctx) return;
                const t = this.ctx.currentTime;
                
                // ÿµŸàÿ™ ÿßŸÑÿÆŸÑÿßÿ∑
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.masterGain);
                
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(400, t);
                osc.frequency.linearRampToValueAtTime(200, t + 0.2);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.linearRampToValueAtTime(0, t + 0.2);
                
                osc.start(t);
                osc.stop(t + 0.2);
                
                // ÿµŸàÿ™ ÿßŸÑÿ∑ŸÑŸÇÿ©
                setTimeout(() => {
                    const click = this.ctx.createOscillator();
                    const clickGain = this.ctx.createGain();
                    click.connect(clickGain);
                    clickGain.connect(this.masterGain);
                    
                    click.type = 'square';
                    click.frequency.value = 800;
                    clickGain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                    clickGain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.05);
                    
                    click.start();
                    click.stop(this.ctx.currentTime + 0.05);
                }, 200);
            },
            
            playFootstep(surface = 'grass') {
                if (!this.ctx) return;
                const t = this.ctx.currentTime;
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                const filter = this.ctx.createBiquadFilter();
                
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(this.masterGain);
                
                if (surface === 'grass') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(100, t);
                    filter.type = 'lowpass';
                    filter.frequency.value = 300;
                    gain.gain.setValueAtTime(0.08, t);
                } else if (surface === 'wood') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(150, t);
                    filter.type = 'bandpass';
                    filter.frequency.value = 500;
                    gain.gain.setValueAtTime(0.06, t);
                } else if (surface === 'water') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(250, t);
                    filter.type = 'highpass';
                    filter.frequency.value = 400;
                    gain.gain.setValueAtTime(0.04, t);
                }
                
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                osc.start(t);
                osc.stop(t + 0.1);
            },
            
            playHit() {
                if (!this.ctx) return;
                const t = this.ctx.currentTime;
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.masterGain);
                
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, t);
                osc.frequency.exponentialRampToValueAtTime(50, t + 0.1);
                gain.gain.setValueAtTime(0.3, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                
                osc.start(t);
                osc.stop(t + 0.1);
            }
        };
        
        // ======== ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑŸÑÿπÿ®ÿ© ========
        let scene, camera, renderer;
        let player, bots = [], bullets = [], items = [], buildings = [], particles = [];
        let gameActive = false;
        let gamePaused = false;
        
        let currentWeapon = 0;
        let isAiming = false;
        let isFiring = false;
        let kills = 0;
        let totalDamage = 0;
        
        let zoneRadius = 400;
        let zoneCenter = new THREE.Vector3(0, 0, 0);
        let lastZoneShrink = 0;
        let difficulty = 'medium';
        let selectedSkin = 0;
        
        // ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
        let settings = {
            joystickSize: 180,
            sensitivity: 5,
            btnSize: 90
        };
        
        // ÿßŸÑÿ£ÿ≥ŸÑÿ≠ÿ©
        const weapons = [
            { name: 'M416', damage: 35, magSize: 30, fireRate: 100, range: 100, mode: 'Auto' },
            { name: 'AKM', damage: 45, magSize: 25, fireRate: 150, range: 80, mode: 'Auto' }
        ];
        
        // ÿßŸÑÿ≥ŸÉŸÜÿßÿ™
        const skins = [
            { name: 'Default', color: 0x4a90e2, secondary: 0xe74c3c },
            { name: 'Military', color: 0x2c3e50, secondary: 0xf1c40f },
            { name: 'Cowboy', color: 0x8b4513, secondary: 0xdaa520 },
            { name: 'Ninja', color: 0x1a1a1a, secondary: 0xe74c3c }
        ];
        
        // ======== ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÑÿπÿ®ÿ© ========
        window.onload = function() {
            initThreeJS();
            initLobbyCharacter();
            setupEventListeners();
            
            // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà
            const video = document.getElementById('lobbyVideo');
            video.play().catch(e => console.log('Video autoplay blocked'));
        };
        
        function initThreeJS() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 50, 400);
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ 
                canvas: document.getElementById('gameCanvas'),
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        }
        
        // ======== ÿ¥ÿÆÿµŸäÿ© ÿßŸÑŸÑŸàÿ®Ÿä ========
        let lobbyCharacter, lobbyScene, lobbyCamera, lobbyRenderer;
        let characterRotation = 0;
        let isDancing = false;
        
        function initLobbyCharacter() {
            const canvas = document.getElementById('characterCanvas');
            
            // ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿ¥ŸáÿØ ŸÖŸÜŸÅÿµŸÑ ŸÑŸÑÿ¥ÿÆÿµŸäÿ©
            lobbyScene = new THREE.Scene();
            lobbyCamera = new THREE.PerspectiveCamera(50, 400/600, 0.1, 100);
            lobbyCamera.position.set(0, 1.5, 4);
            
            // ÿ•ÿ∂ÿßÿ°ÿ©
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(5, 10, 7);
            lobbyScene.add(light);
            lobbyScene.add(new THREE.AmbientLight(0x404040, 0.5));
            
            // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ¥ÿÆÿµŸäÿ©
            lobbyCharacter = createCharacterMesh(0);
            lobbyScene.add(lobbyCharacter);
            
            // ÿ£ÿ±ÿ∂Ÿäÿ©
            const floorGeo = new THREE.CircleGeometry(3, 32);
            const floorMat = new THREE.MeshStandardMaterial({ 
                color: 0x222222,
                metalness: 0.5,
                roughness: 0.5
            });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI/2;
            floor.position.y = -1;
            lobbyScene.add(floor);
            
            // ÿ≠ŸÑŸÇÿ© ÿßŸÑÿ±ÿ≥ŸÖ
            function animateLobby() {
                requestAnimationFrame(animateLobby);
                
                if (lobbyCharacter) {
                    // ÿØŸàÿ±ÿßŸÜ ÿ™ŸÑŸÇÿßÿ¶Ÿä
                    if (!isDancing) {
                        characterRotation += 0.005;
                        lobbyCharacter.rotation.y = characterRotation;
                    }
                    
                    // ÿ≠ÿ±ŸÉÿ© ÿßŸÑÿ™ŸÜŸÅÿ≥
                    const time = Date.now() * 0.001;
                    lobbyCharacter.position.y = Math.sin(time * 2) * 0.05;
                }
                
                renderer.render(lobbyScene, lobbyCamera);
            }
            animateLobby();
        }
        
        function createCharacterMesh(skinId) {
            const skin = skins[skinId];
            const group = new THREE.Group();
            
            // ÿßŸÑÿ¨ÿ≥ŸÖ
            const bodyGeo = new THREE.BoxGeometry(0.5, 0.8, 0.3);
            const bodyMat = new THREE.MeshStandardMaterial({ color: skin.color });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.position.y = 0.4;
            body.castShadow = true;
            group.add(body);
            
            // ÿßŸÑÿµÿØÿ±Ÿäÿ©
            const vestGeo = new THREE.BoxGeometry(0.55, 0.4, 0.35);
            const vestMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
            const vest = new THREE.Mesh(vestGeo, vestMat);
            vest.position.y = 0.1;
            body.add(vest);
            
            // ÿßŸÑŸÉÿ™ŸÅ ÿßŸÑÿ£ŸäŸÖŸÜ
            const shoulderGeo = new THREE.BoxGeometry(0.2, 0.2, 0.2);
            const shoulderMat = new THREE.MeshStandardMaterial({ color: skin.secondary });
            const shoulder = new THREE.Mesh(shoulderGeo, shoulderMat);
            shoulder.position.set(0.4, 0.2, 0);
            body.add(shoulder);
            
            // ÿßŸÑÿ±ÿ£ÿ≥
            const headGeo = new THREE.BoxGeometry(0.3, 0.35, 0.3);
            const headMat = new THREE.MeshStandardMaterial({ color: 0xffdbac });
            const head = new THREE.Mesh(headGeo, headMat);
            head.position.y = 0.6;
            body.add(head);
            
            // ÿßŸÑÿÆŸàÿ∞ÿ©
            const helmetGeo = new THREE.BoxGeometry(0.35, 0.15, 0.35);
            const helmetMat = new THREE.MeshStandardMaterial({ color: 0x2c3e50 });
            const helmet = new THREE.Mesh(helmetGeo, helmetMat);
            helmet.position.y = 0.2;
            head.add(helmet);
            
            // ÿßŸÑÿ∞ÿ±ÿßÿπŸäŸÜ
            const armGeo = new THREE.BoxGeometry(0.15, 0.6, 0.15);
            const armMat = new THREE.MeshStandardMaterial({ color: skin.color });
            
            const leftArm = new THREE.Mesh(armGeo, armMat);
            leftArm.position.set(-0.35, 0, 0);
            body.add(leftArm);
            
            const rightArm = new THREE.Mesh(armGeo, armMat);
            rightArm.position.set(0.35, 0, 0);
            body.add(rightArm);
            
            // ÿßŸÑÿ≥ÿßŸÇŸäŸÜ
            const legGeo = new THREE.BoxGeometry(0.18, 0.8, 0.18);
            const legMat = new THREE.MeshStandardMaterial({ color: 0x2c3e50 });
            
            const leftLeg = new THREE.Mesh(legGeo, legMat);
            leftLeg.position.set(-0.15, -0.8, 0);
            body.add(leftLeg);
            
            const rightLeg = new THREE.Mesh(legGeo, legMat);
            rightLeg.position.set(0.15, -0.8, 0);
            body.add(rightLeg);
            
            // ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπ ŸÑŸÑÿ≠ÿ±ŸÉÿ©
            group.userData = { body, head, leftArm, rightArm, leftLeg, rightLeg };
            
            return group;
        }
        
        // ======== Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑŸÑŸàÿ®Ÿä ========
        function rotateCharacter(direction) {
            if (direction === 'left') {
                characterRotation -= 0.5;
            } else {
                characterRotation += 0.5;
            }
            if (lobbyCharacter) {
                lobbyCharacter.rotation.y = characterRotation;
            }
        }
        
        function selectSkin(index) {
            selectedSkin = index;
            document.querySelectorAll('.skin-item').forEach((el, i) => {
                el.classList.toggle('selected', i === index);
            });
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ¥ÿÆÿµŸäÿ©
            if (lobbyCharacter) {
                lobbyScene.remove(lobbyCharacter);
                lobbyCharacter = createCharacterMesh(index);
                lobbyScene.add(lobbyCharacter);
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ£ŸÅÿßÿ™ÿßÿ±
            const avatars = ['üë§', 'üéñ', 'ü¶∏', 'ü§†'];
            document.getElementById('lobbyAvatar').textContent = avatars[index] || 'üë§';
        }
        
        function playEmote(emote) {
            if (!lobbyCharacter || isDancing) return;
            
            isDancing = true;
            const parts = lobbyCharacter.userData;
            const startTime = Date.now();
            
            function animateEmote() {
                const elapsed = (Date.now() - startTime) / 1000;
                
                if (emote.includes('dance')) {
                    // ÿ±ŸÇÿµÿ©
                    parts.leftArm.rotation.z = Math.sin(elapsed * 10) * 0.5;
                    parts.rightArm.rotation.z = Math.cos(elapsed * 10) * 0.5;
                    lobbyCharacter.position.y = Math.abs(Math.sin(elapsed * 5)) * 0.2;
                    lobbyCharacter.rotation.y += 0.02;
                } else if (emote === 'wave') {
                    // ÿ™ÿ≠Ÿäÿ©
                    parts.rightArm.rotation.z = Math.sin(elapsed * 5) * 0.3 - 0.5;
                    parts.rightArm.rotation.x = Math.sin(elapsed * 10) * 0.2;
                } else if (emote === 'salute') {
                    // ÿ™ÿ≠Ÿäÿ© ÿπÿ≥ŸÉÿ±Ÿäÿ©
                    parts.rightArm.rotation.z = -2.5;
                    parts.rightArm.rotation.x = 0;
                }
                
                if (elapsed < 3) {
                    requestAnimationFrame(animateEmote);
                } else {
                    // ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ∂ÿ®ÿ∑
                    parts.leftArm.rotation.set(0, 0, 0);
                    parts.rightArm.rotation.set(0, 0, 0);
                    lobbyCharacter.position.y = 0;
                    isDancing = false;
                }
            }
            
            animateEmote();
        }
        
        // ======== ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ© ========
        function startGame() {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'flex';
            
            AudioSystem.init();
            
            // ŸÖÿ≠ÿßŸÉÿßÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 3;
                if (progress > 100) progress = 100;
                document.getElementById('loadingProgress').style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                        document.getElementById('gameUI').style.display = 'block';
                        enterGame();
                    }, 500);
                }
            }, 50);
        }
        
        function enterGame() {
            createGameWorld();
            spawnPlayer();
            spawnBots();
            setupGameControls();
            
            gameActive = true;
            lastZoneShrink = Date.now();
            gameLoop();
        }
        
        function createGameWorld() {
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ¥ŸáÿØ
            while(scene.children.length > 0) {
                scene.remove(scene.children[0]);
            }
            
            // ÿ•ÿ∂ÿßÿ°ÿ©
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(100, 200, 100);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;
            scene.add(dirLight);
            
            // ÿßŸÑÿ£ÿ±ÿ∂
            const groundGeo = new THREE.PlaneGeometry(2000, 2000, 100, 100);
            const groundMat = new THREE.MeshStandardMaterial({ 
                color: 0x3d5c3d,
                roughness: 0.9
            });
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // ÿ™ŸÑÿßŸÑ
            const vertices = groundGeo.attributes.position.array;
            for (let i = 0; i < vertices.length; i += 3) {
                const x = vertices[i];
                const y = vertices[i + 1];
                vertices[i + 2] = Math.sin(x * 0.01) * Math.cos(y * 0.01) * 8;
            }
            groundGeo.computeVertexNormals();
            
            // ÿ®ÿ≠Ÿäÿ±ÿ©
            const lakeGeo = new THREE.CircleGeometry(200, 64);
            const lakeMat = new THREE.MeshStandardMaterial({ 
                color: 0x006994,
                roughness: 0.1,
                metalness: 0.8
            });
            const lake = new THREE.Mesh(lakeGeo, lakeMat);
            lake.rotation.x = -Math.PI / 2;
            lake.position.set(300, 0.5, 300);
            lake.name = 'water';
            scene.add(lake);
            
            // ÿ£ÿ¥ÿ¨ÿßÿ±
            for (let i = 0; i < 200; i++) {
                createTree();
            }
            
            // ŸÖÿ®ÿßŸÜŸä
            for (let i = 0; i < 20; i++) {
                createBuilding();
            }
            
            // ÿπŸÜÿßÿµÿ±
            for (let i = 0; i < 40; i++) {
                createItem();
            }
        }
        
        function createTree() {
            const x = (Math.random() - 0.5) * 1800;
            const z = (Math.random() - 0.5) * 1800;
            if (Math.abs(x) < 50 && Math.abs(z) < 50) return;
            
            const group = new THREE.Group();
            group.position.set(x, 0, z);
            
            // ÿ¨ÿ∞ÿπ
            const trunkGeo = new THREE.CylinderGeometry(0.3, 0.5, 4, 8);
            const trunkMat = new THREE.MeshStandardMaterial({ color: 0x4a3728 });
            const trunk = new THREE.Mesh(trunkGeo, trunkMat);
            trunk.position.y = 2;
            trunk.castShadow = true;
            group.add(trunk);
            
            // ÿ£Ÿàÿ±ÿßŸÇ
            const leavesGeo = new THREE.ConeGeometry(3, 6, 8);
            const leavesMat = new THREE.MeshStandardMaterial({ color: 0x0f5f0f });
            const leaves = new THREE.Mesh(leavesGeo, leavesMat);
            leaves.position.y = 5;
            leaves.castShadow = true;
            group.add(leaves);
            
            scene.add(group);
        }
        
        function createBuilding() {
            const x = (Math.random() - 0.5) * 1600;
            const z = (Math.random() - 0.5) * 1600;
            
            const width = 12 + Math.random() * 8;
            const depth = 12 + Math.random() * 8;
            const height = 6 + Math.random() * 4;
            
            const group = new THREE.Group();
            group.position.set(x, 0, z);
            
            // ÿßŸÑÿ¨ÿØÿ±ÿßŸÜ
            const wallMat = new THREE.MeshStandardMaterial({ color: 0xD2B48C });
            
            // ÿßŸÑÿ¨ÿØÿ±ÿßŸÜ ÿßŸÑÿ£ÿ±ÿ®ÿπÿ©
            const walls = [
                { size: [width, height, 0.5], pos: [0, height/2, -depth/2] },
                { size: [width, height, 0.5], pos: [0, height/2, depth/2] },
                { size: [0.5, height, depth], pos: [-width/2, height/2, 0] },
                { size: [0.5, height, depth], pos: [width/2, height/2, 0] }
            ];
            
            walls.forEach(w => {
                const geo = new THREE.BoxGeometry(...w.size);
                const mesh = new THREE.Mesh(geo, wallMat);
                mesh.position.set(...w.pos);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                group.add(mesh);
            });
            
            // ÿ≥ŸÇŸÅ
            const roofGeo = new THREE.ConeGeometry(Math.max(width, depth) * 0.8, 4, 4);
            const roofMat = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            const roof = new THREE.Mesh(roofGeo, roofMat);
            roof.position.y = height + 2;
            roof.rotation.y = Math.PI / 4;
            group.add(roof);
            
            // ÿ®ÿßÿ®
            const doorGeo = new THREE.BoxGeometry(2, 3.5, 0.2);
            const doorMat = new THREE.MeshStandardMaterial({ color: 0x4a3728 });
            const door = new THREE.Mesh(doorGeo, doorMat);
            door.position.set(0, 1.75, depth/2);
            door.name = 'door';
            group.add(door);
            
            scene.add(group);
            buildings.push(group);
        }
        
        function createItem() {
            const types = ['ammo', 'heal', 'weapon'];
            const type = types[Math.floor(Math.random() * types.length)];
            const x = (Math.random() - 0.5) * 1800;
            const z = (Math.random() - 0.5) * 1800;
            
            const group = new THREE.Group();
            group.position.set(x, 0.5, z);
            
            if (type === 'ammo') {
                // ÿµŸÜÿØŸàŸÇ ÿ∞ÿÆŸäÿ±ÿ©
                const box = new THREE.Mesh(
                    new THREE.BoxGeometry(0.6, 0.4, 0.4),
                    new THREE.MeshStandardMaterial({ color: 0x8B4513 })
                );
                group.add(box);
                
                // ÿ∑ŸÑŸÇÿßÿ™
                for (let i = 0; i < 3; i++) {
                    const bullet = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.04, 0.04, 0.25),
                        new THREE.MeshStandardMaterial({ color: 0xFFD700, metalness: 0.8 })
                    );
                    bullet.rotation.z = Math.PI / 2;
                    bullet.position.set(0, 0.3 + i * 0.08, 0);
                    group.add(bullet);
                }
                
                group.userData = { type: 'ammo', amount: 30 };
            } else if (type === 'heal') {
                // ÿ≠ŸÇŸäÿ®ÿ© ÿ•ÿ≥ÿπÿßŸÅ
                const box = new THREE.Mesh(
                    new THREE.BoxGeometry(0.5, 0.3, 0.4),
                    new THREE.MeshStandardMaterial({ color: 0xffffff })
                );
                group.add(box);
                
                // ÿµŸÑŸäÿ® ÿ£ÿ≠ŸÖÿ±
                const cross = new THREE.Mesh(
                    new THREE.PlaneGeometry(0.3, 0.3),
                    new THREE.MeshBasicMaterial({ color: 0xff0000 })
                );
                cross.rotation.x = -Math.PI / 2;
                cross.position.y = 0.16;
                group.add(cross);
                
                group.userData = { type: 'heal', amount: 50 };
            } else {
                // ÿ≥ŸÑÿßÿ≠
                const gun = new THREE.Mesh(
                    new THREE.BoxGeometry(0.8, 0.15, 0.1),
                    new THREE.MeshStandardMaterial({ color: 0x2c3e50 })
                );
                group.add(gun);
                
                group.userData = { type: 'weapon' };
            }
            
            group.userData.rotate = true;
            scene.add(group);
            items.push(group);
        }
        
        function spawnPlayer() {
            player = createCharacterMesh(selectedSkin);
            player.position.set(0, 1, 0);
            player.userData.isPlayer = true;
            player.userData.health = 100;
            player.userData.armor = 100;
            player.userData.ammo = [30, 30];
            player.userData.totalAmmo = 120;
            player.userData.stance = 'stand';
            player.userData.velocity = new THREE.Vector3();
            
            scene.add(player);
        }
        
        function spawnBots() {
            const count = difficulty === 'easy' ? 10 : difficulty === 'medium' ? 15 : difficulty === 'hard' ? 19 : 24;
            
            for (let i = 0; i < count; i++) {
                let x, z;
                do {
                    x = (Math.random() - 0.5) * 1800;
                    z = (Math.random() - 0.5) * 1800;
                } while (Math.sqrt(x*x + z*z) < 100);
                
                const bot = createCharacterMesh(Math.floor(Math.random() * 4));
                bot.position.set(x, 1, z);
                bot.userData.isPlayer = false;
                bot.userData.health = 100;
                bot.userData.armor = 50;
                bot.userData.ammo = [30, 0];
                bot.userData.ai = {
                    state: 'idle',
                    target: null,
                    lastDecision: 0,
                    accuracy: difficulty === 'easy' ? 0.1 : difficulty === 'medium' ? 0.25 : difficulty === 'hard' ? 0.4 : 0.6
                };
                
                scene.add(bot);
                bots.push(bot);
            }
        }
        
        // ======== ÿ£ŸÜÿ∏ŸÖÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ========
        let moveVector = { x: 0, y: 0 };
        let cameraRotation = { x: 0, y: 0 };
        
        function setupGameControls() {
            // ÿßŸÑÿ¨ŸàŸäÿ≥ÿ™ŸäŸÉ
            const joystick = document.getElementById('moveJoystick');
            const knob = document.getElementById('moveKnob');
            let active = false;
            let center = { x: 0, y: 0 };
            
            joystick.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = joystick.getBoundingClientRect();
                center = {
                    x: rect.left + rect.width / 2,
                    y: rect.top + rect.height / 2
                };
                active = true;
                updateJoystick(touch.clientX, touch.clientY);
            }, { passive: false });
            
            joystick.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (active) {
                    updateJoystick(e.touches[0].clientX, e.touches[0].clientY);
                }
            }, { passive: false });
            
            joystick.addEventListener('touchend', () => {
                active = false;
                knob.style.transform = 'translate(-50%, -50%)';
                moveVector = { x: 0, y: 0 };
            });
            
            function updateJoystick(x, y) {
                const maxDist = settings.joystickSize / 3;
                let dx = x - center.x;
                let dy = y - center.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist > maxDist) {
                    dx = (dx / dist) * maxDist;
                    dy = (dy / dist) * maxDist;
                }
                
                knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                moveVector = { 
                    x: dx / maxDist, 
                    y: dy / maxDist 
                };
            }
            
            // ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß (ÿßŸÑÿ¨ÿßŸÜÿ® ÿßŸÑÿ£ŸäŸÖŸÜ)
            let lookActive = false;
            let lookStart = { x: 0, y: 0 };
            
            document.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                if (touch.clientX > window.innerWidth / 2 && 
                    !e.target.closest('.btn-control') && 
                    !e.target.closest('.btn-action') &&
                    !e.target.closest('.map-container')) {
                    lookActive = true;
                    lookStart = { x: touch.clientX, y: touch.clientY };
                }
            }, { passive: false });
            
            document.addEventListener('touchmove', (e) => {
                if (lookActive) {
                    const touch = e.touches[0];
                    const dx = touch.clientX - lookStart.x;
                    const dy = touch.clientY - lookStart.y;
                    
                    cameraRotation.y -= dx * 0.005 * settings.sensitivity;
                    cameraRotation.x -= dy * 0.005 * settings.sensitivity;
                    cameraRotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, cameraRotation.x));
                    
                    lookStart = { x: touch.clientX, y: touch.clientY };
                }
            }, { passive: false });
            
            document.addEventListener('touchend', () => {
                lookActive = false;
            });
            
            // ÿ≤ÿ± ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑŸàÿ®Ÿä
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    togglePause();
                }
            });
        }
        
        // ======== ÿ≠ŸÑŸÇÿ© ÿßŸÑŸÑÿπÿ®ÿ© ========
        function gameLoop() {
            if (!gameActive || gamePaused) return;
            requestAnimationFrame(gameLoop);
            
            const delta = 0.016;
            
            updatePlayer(delta);
            updateBots(delta);
            updateBullets(delta);
            updateItems();
            updateZone();
            updateUI();
            
            renderer.render(scene, camera);
        }
        
        function updatePlayer(delta) {
            if (!player) return;
            
            const data = player.userData;
            const speed = data.stance === 'prone' ? 2 : data.stance === 'crouch' ? 4 : 8;
            
            // ÿßŸÑÿ≠ÿ±ŸÉÿ©
            if (moveVector.x !== 0 || moveVector.y !== 0) {
                const forward = new THREE.Vector3(Math.sin(cameraRotation.y), 0, Math.cos(cameraRotation.y));
                const right = new THREE.Vector3(Math.sin(cameraRotation.y + Math.PI/2), 0, Math.cos(cameraRotation.y + Math.PI/2));
                
                const moveDir = new THREE.Vector3()
                    .add(forward.multiplyScalar(-moveVector.y))
                    .add(right.multiplyScalar(moveVector.x));
                moveDir.normalize();
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿµÿ∑ÿØÿßŸÖ
                const newPos = player.position.clone().add(moveDir.multiplyScalar(speed * delta));
                if (newPos.y >= 0) {
                    player.position.copy(newPos);
                }
                
                player.rotation.y = cameraRotation.y + Math.PI;
                
                // ÿÆÿ∑Ÿàÿßÿ™
                if (Math.floor(Date.now() / 400) % 2 === 0) {
                    AudioSystem.playFootstep('grass');
                }
                
                // ÿ≠ÿ±ŸÉÿ© ÿßŸÑÿ£ÿ±ÿ¨ŸÑ
                const time = Date.now() * 0.01;
                data.leftLeg.rotation.x = Math.sin(time) * 0.5;
                data.rightLeg.rotation.x = Math.sin(time + Math.PI) * 0.5;
            } else {
                data.leftLeg.rotation.x = 0;
                data.rightLeg.rotation.x = 0;
            }
            
            // ÿßŸÑÿ¨ÿßÿ∞ÿ®Ÿäÿ©
            if (player.position.y > 0) {
                data.velocity.y -= 20 * delta;
                player.position.y += data.velocity.y * delta;
                
                if (player.position.y < 0) {
                    player.position.y = 0;
                    data.velocity.y = 0;
                }
            }
            
            // ÿßŸÑÿ≥ÿ®ÿßÿ≠ÿ©
            const distToLake = Math.sqrt(
                Math.pow(player.position.x - 300, 2) + 
                Math.pow(player.position.z - 300, 2)
            );
            
            if (distToLake < 200 && player.position.y < 2) {
                player.position.y = 1;
                data.velocity.y = 0;
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß
            const camDist = isAiming ? 2 : 5;
            const height = isAiming ? 1.2 : 2.5;
            
            camera.position.x = player.position.x - Math.sin(cameraRotation.y) * camDist;
            camera.position.z = player.position.z - Math.cos(cameraRotation.y) * camDist;
            camera.position.y = player.position.y + height;
            
            camera.lookAt(
                player.position.x + Math.sin(cameraRotation.y) * 10,
                player.position.y + 1.5,
                player.position.z + Math.cos(cameraRotation.y) * 10
            );
            
            // FOV ŸÑŸÑÿ≥ŸÉŸàÿ®
            camera.fov = isAiming ? 30 : 75;
            camera.updateProjectionMatrix();
        }
        
        function updateBots(delta) {
            const now = Date.now();
            
            bots.forEach(bot => {
                if (bot.userData.health <= 0) return;
                
                const ai = bot.userData.ai;
                const distToPlayer = bot.position.distanceTo(player.position);
                
                // ÿßÿ™ÿÆÿßÿ∞ ŸÇÿ±ÿßÿ±
                if (now - ai.lastDecision > 1000) {
                    ai.lastDecision = now;
                    
                    if (distToPlayer < 60 && Math.random() > 0.3) {
                        ai.target = player;
                        ai.state = 'attack';
                    } else {
                        ai.state = 'wander';
                        ai.wanderTarget = new THREE.Vector3(
                            bot.position.x + (Math.random() - 0.5) * 50,
                            0,
                            bot.position.z + (Math.random() - 0.5) * 50
                        );
                    }
                }
                
                // ÿ™ŸÜŸÅŸäÿ∞
                if (ai.state === 'attack' && ai.target) {
                    const dir = new THREE.Vector3().subVectors(ai.target.position, bot.position).normalize();
                    bot.rotation.y = Math.atan2(dir.x, dir.z);
                    
                    if (distToPlayer > 10) {
                        bot.position.add(dir.multiplyScalar(5 * delta));
                    }
                    
                    if (now - bot.userData.lastShot > 200 && Math.random() < ai.accuracy) {
                        botShoot(bot);
                        bot.userData.lastShot = now;
                    }
                } else if (ai.state === 'wander') {
                    const dir = new THREE.Vector3().subVectors(ai.wanderTarget, bot.position);
                    if (dir.length() > 1) {
                        dir.normalize();
                        bot.rotation.y = Math.atan2(dir.x, dir.z);
                        bot.position.add(dir.multiplyScalar(3 * delta));
                    }
                }
            });
        }
        
        function updateBullets(delta) {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.position.add(bullet.userData.velocity.clone().multiplyScalar(delta));
                bullet.userData.life -= delta;
                
                if (bullet.userData.life <= 0 || bullet.position.y < 0) {
                    scene.remove(bullet);
                    bullets.splice(i, 1);
                    continue;
                }
                
                // ÿßÿµÿ∑ÿØÿßŸÖ
                const targets = bullet.userData.shooter.userData.isPlayer ? bots : [player];
                for (let target of targets) {
                    if (target.userData.health > 0 && bullet.position.distanceTo(target.position) < 1.5) {
                        takeDamage(target, bullet.userData.damage);
                        
                        if (target.userData.isPlayer) {
                            AudioSystem.playHit();
                            showDamageOverlay();
                        } else {
                            showHitMarker();
                            totalDamage += bullet.userData.damage;
                        }
                        
                        scene.remove(bullet);
                        bullets.splice(i, 1);
                        break;
                    }
                }
            }
        }
        
        function updateItems() {
            items.forEach((item, index) => {
                if (item.userData.rotate) {
                    item.rotation.y += 0.02;
                    item.position.y = 0.5 + Math.sin(Date.now() * 0.003) * 0.1;
                }
                
                // ÿßŸÑÿ™ŸÇÿßÿ∑
                if (item.position.distanceTo(player.position) < 3) {
                    if (item.userData.type === 'ammo') {
                        player.userData.totalAmmo += item.userData.amount;
                        showNotification('+' + item.userData.amount + ' ÿ∞ÿÆŸäÿ±ÿ©');
                        scene.remove(item);
                        items.splice(index, 1);
                    } else if (item.userData.type === 'heal') {
                        player.userData.health = Math.min(100, player.userData.health + item.userData.amount);
                        AudioSystem.playReload(); // ÿµŸàÿ™ ÿπŸÑÿßÿ¨
                        showNotification('+' + item.userData.amount + ' ÿµÿ≠ÿ©');
                        scene.remove(item);
                        items.splice(index, 1);
                    }
                }
            });
        }
        
        function updateZone() {
            const now = Date.now();
            const elapsed = now - lastZoneShrink;
            const remaining = Math.max(0, 60 - Math.floor(elapsed / 1000));
            
            document.getElementById('zoneTimer').textContent = remaining;
            document.getElementById('zoneTimerDisplay').textContent = remaining;
            
            if (elapsed > 60000) {
                lastZoneShrink = now;
                zoneRadius *= 0.7;
                showNotification('ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¢ŸÖŸÜÿ© ÿ™ÿ™ŸÇŸÑÿµ!');
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©
            const safeZone = document.getElementById('minimapSafeZone');
            const dangerZone = document.getElementById('minimapDangerZone');
            const scale = 180 / 2000;
            safeZone.style.width = (zoneRadius * 2 * scale) + 'px';
            safeZone.style.height = (zoneRadius * 2 * scale) + 'px';
            
            // ÿ∂ÿ±ÿ± ÿÆÿßÿ±ÿ¨ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©
            const distToCenter = player.position.distanceTo(zoneCenter);
            if (distToCenter > zoneRadius) {
                if (Math.random() < 0.05) {
                    takeDamage(player, 1);
                    showDamageOverlay();
                }
            }
        }
        
        function updateUI() {
            if (!player) return;
            
            document.getElementById('currentAmmo').textContent = player.userData.ammo[currentWeapon];
            document.getElementById('totalAmmo').textContent = '/ ' + player.userData.totalAmmo;
            document.getElementById('killCount').textContent = kills;
            document.getElementById('playersLeft').textContent = bots.filter(b => b.userData.health > 0).length + 1;
            
            document.getElementById('healthBar').style.width = player.userData.health + '%';
            document.getElementById('armorBar').style.width = player.userData.armor + '%';
            
            const weapon = weapons[currentWeapon];
            document.getElementById('weaponName').textContent = weapon.name;
            document.getElementById('fireMode').textContent = weapon.mode;
        }
        
        // ======== Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ========
        function startFiring() {
            if (!gameActive || gamePaused) return;
            isFiring = true;
            fireLoop();
            document.getElementById('fireBtn').classList.add('active');
        }
        
        function stopFiring() {
            isFiring = false;
            document.getElementById('fireBtn').classList.remove('active');
        }
        
        function fireLoop() {
            if (!isFiring || !gameActive) return;
            
            const weapon = weapons[currentWeapon];
            if (player.userData.ammo[currentWeapon] > 0) {
                shoot(player);
                player.userData.ammo[currentWeapon]--;
                AudioSystem.playGunshot();
                
                if (player.userData.ammo[currentWeapon] === 0) {
                    setTimeout(reload, 100);
                }
                
                setTimeout(fireLoop, weapon.fireRate);
            }
        }
        
        function shoot(shooter) {
            const weapon = weapons[currentWeapon];
            const startPos = shooter.position.clone().add(new THREE.Vector3(0, 1.5, 0));
            const direction = new THREE.Vector3();
            
            if (shooter.userData.isPlayer) {
                camera.getWorldDirection(direction);
            } else {
                direction.subVectors(player.position, shooter.position).normalize();
            }
            
            // ÿØŸÇÿ© ÿßŸÑÿ®Ÿàÿ™
            if (!shooter.userData.isPlayer) {
                direction.x += (Math.random() - 0.5) * 0.1;
                direction.z += (Math.random() - 0.5) * 0.1;
            }
            
            const bullet = new THREE.Mesh(
                new THREE.CylinderGeometry(0.02, 0.02, 1),
                new THREE.MeshBasicMaterial({ color: 0xffff00 })
            );
            bullet.rotation.z = Math.PI / 2;
            bullet.rotation.y = Math.atan2(direction.x, direction.z);
            bullet.position.copy(startPos);
            bullet.userData = {
                velocity: direction.multiplyScalar(150),
                life: 2,
                damage: weapon.damage,
                shooter: shooter
            };
            
            scene.add(bullet);
            bullets.push(bullet);
            
            // ÿØÿÆÿßŸÜ
            const flash = new THREE.PointLight(0xffaa00, 2, 3);
            flash.position.copy(startPos);
            scene.add(flash);
            setTimeout(() => scene.remove(flash), 50);
        }
        
        function botShoot(bot) {
            if (bot.userData.ammo[0] <= 0) return;
            bot.userData.ammo[0]--;
            shoot(bot);
        }
        
        function takeDamage(character, amount) {
            if (character.userData.armor > 0) {
                const armorDamage = Math.min(character.userData.armor, amount * 0.5);
                character.userData.armor -= armorDamage;
                amount -= armorDamage;
            }
            
            character.userData.health -= amount;
            
            if (character.userData.health <= 0) {
                character.userData.health = 0;
                die(character);
            }
        }
        
        function die(character) {
            character.userData.body.rotation.x = -Math.PI / 2;
            
            if (!character.userData.isPlayer) {
                const index = bots.indexOf(character);
                if (index > -1) bots.splice(index, 1);
                
                kills++;
                showNotification('ŸÇÿ∂Ÿäÿ™ ÿπŸÑŸâ ÿπÿØŸà!');
                
                if (bots.length === 0) {
                    endGame(true);
                }
            } else {
                endGame(false);
            }
        }
        
        function jump() {
            if (player.userData.stance !== 'prone' && player.position.y === 0) {
                player.userData.velocity.y = 8;
            }
        }
        
        function toggleCrouch() {
            const data = player.userData;
            if (data.stance === 'crouch') {
                data.stance = 'stand';
                data.body.scale.y = 1;
                data.body.position.y = 0.4;
            } else {
                data.stance = 'crouch';
                data.body.scale.y = 0.6;
                data.body.position.y = 0.2;
            }
        }
        
        function toggleProne() {
            const data = player.userData;
            if (data.stance === 'prone') {
                data.stance = 'stand';
                data.body.rotation.x = 0;
                data.body.position.y = 0.4;
            } else {
                data.stance = 'prone';
                data.body.rotation.x = -Math.PI / 2;
                data.body.position.y = 0.1;
            }
        }
        
        function toggleADS() {
            isAiming = !isAiming;
            document.getElementById('adsBtn').style.background = isAiming ? 'rgba(255,215,0,0.3)' : '';
        }
        
        function reload() {
            const weapon = weapons[currentWeapon];
            const needed = weapon.magSize - player.userData.ammo[currentWeapon];
            
            if (needed > 0 && player.userData.totalAmmo >= needed) {
                AudioSystem.playReload();
                player.userData.ammo[currentWeapon] += needed;
                player.userData.totalAmmo -= needed;
                showNotification('ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...');
            }
        }
        
        function switchWeapon() {
            currentWeapon = (currentWeapon + 1) % weapons.length;
            showNotification(weapons[currentWeapon].name);
        }
        
        // ======== Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ========
        function showNotification(text) {
            const notif = document.getElementById('notification');
            notif.textContent = text;
            notif.classList.add('show');
            setTimeout(() => notif.classList.remove('show'), 2000);
        }
        
        function showDamageOverlay() {
            const overlay = document.getElementById('damageOverlay');
            overlay.classList.add('show');
            setTimeout(() => overlay.classList.remove('show'), 200);
        }
        
        function showHitMarker() {
            const marker = document.getElementById('hitMarker');
            marker.classList.add('active');
            setTimeout(() => marker.classList.remove('active'), 200);
        }
        
        function toggleBigMap() {
            const map = document.getElementById('bigMapScreen');
            if (map.style.display === 'block') {
                map.style.display = 'none';
            } else {
                map.style.display = 'block';
                drawBigMap();
            }
        }
        
        function drawBigMap() {
            const canvas = document.getElementById('bigMapCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const scale = Math.min(canvas.width, canvas.height) / 2000;
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            
            // ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ¢ŸÖŸÜÿ©
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(cx, cy, zoneRadius * scale, 0, Math.PI * 2);
            ctx.stroke();
            
            // ÿßŸÑŸÑÿßÿπÿ®
            ctx.fillStyle = '#ffff00';
            ctx.beginPath();
            ctx.arc(cx, cy, 8, 0, Math.PI * 2);
            ctx.fill();
            
            // ÿßŸÑÿ®Ÿàÿ™ÿßÿ™
            bots.forEach(bot => {
                if (bot.userData.health > 0) {
                    const x = cx + bot.position.x * scale;
                    const y = cy + bot.position.z * scale;
                    ctx.fillStyle = '#ff0000';
                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
        }
        
        // ======== ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ========
        function openSettings() {
            document.getElementById('settingsPanel').style.display = 'block';
            if (gameActive) gamePaused = true;
        }
        
        function closeSettings() {
            document.getElementById('settingsPanel').style.display = 'none';
            if (gameActive) {
                gamePaused = false;
                gameLoop();
            }
        }
        
        function updateSetting(type, value) {
            value = parseInt(value);
            if (type === 'joystick') {
                settings.joystickSize = value;
                document.getElementById('joystickSizeValue').textContent = value;
                document.querySelector('.joystick-container').style.width = value + 'px';
                document.querySelector('.joystick-container').style.height = value + 'px';
            } else if (type === 'sensitivity') {
                settings.sensitivity = value;
                document.getElementById('sensitivityValue').textContent = value;
            } else if (type === 'btnSize') {
                settings.btnSize = value;
                document.getElementById('btnSizeValue').textContent = value;
                document.querySelectorAll('.btn-control').forEach(btn => {
                    btn.style.width = value + 'px';
                    btn.style.height = value + 'px';
                });
            }
        }
        
        function setDifficulty(diff) {
            difficulty = diff;
            document.querySelectorAll('.diff-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === getDiffText(diff)) btn.classList.add('active');
            });
        }
        
        function getDiffText(diff) {
            return { easy: 'ÿ≥ŸáŸÑ', medium: 'ŸÖÿ™Ÿàÿ≥ÿ∑', hard: 'ÿµÿπÿ®', expert: 'ÿÆÿ®Ÿäÿ±' }[diff];
        }
        
        function togglePause() {
            if (!gameActive) return;
            gamePaused = !gamePaused;
            document.getElementById('pauseMenu').style.display = gamePaused ? 'flex' : 'none';
            if (!gamePaused) gameLoop();
        }
        
        function resumeGame() {
            gamePaused = false;
            document.getElementById('pauseMenu').style.display = 'none';
            gameLoop();
        }
        
        function exitToLobby() {
            location.reload();
        }
        
        // ======== ŸÜŸáÿßŸäÿ© ÿßŸÑŸÑÿπÿ®ÿ© ========
        function endGame(victory) {
            gameActive = false;
            document.getElementById('endScreen').style.display = 'flex';
            document.getElementById('endTitle').textContent = victory ? 'ÿßŸÜÿ™ÿµÿ±ÿ™!' : 'Ÿáÿ≤ŸÖÿ™';
            document.getElementById('endTitle').className = victory ? 'result-title victory' : 'result-title defeat';
            document.getElementById('endKills').textContent = kills;
            document.getElementById('endDamage').textContent = totalDamage;
            document.getElementById('endRank').textContent = victory ? '#1' : '#' + (bots.length + 2);
        }
        
        // ======== ŸÖÿ≥ÿßÿπÿØÿßÿ™ ========
        function setupEventListeners() {
            window.addEventListener('resize', () => {
                if (camera) {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                }
            });
            
            // ŸÖŸÜÿπ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≥ŸäÿßŸÇŸäÿ©
            document.addEventListener('contextmenu', e => e.preventDefault());
        }
    </script>
</body>
</html>'''

# ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ
with open('/mnt/kimi/output/kim_royale_final.html', 'w', encoding='utf-8') as f:
    f.write(final_game)

print("‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÑÿπÿ®ÿ© ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠!")
print(f"üìä ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖŸÑŸÅ: {len(final_game):,} ÿ≠ÿ±ŸÅ")
print("\nüéÆ ÿßŸÑŸÖŸÖŸäÿ≤ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©:")
print("1. üé• ŸÅŸäÿØŸäŸà ÿÆŸÑŸÅŸäÿ© ŸÑŸÑŸàÿ®Ÿä (ÿ∂ÿπ ŸÖŸÑŸÅ lobby_video.mp4 ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸÖÿ¨ŸÑÿØ)")
print("2. üï∫ ÿ¥ÿÆÿµŸäÿ© 3D ŸÖÿ™ÿ≠ÿ±ŸÉÿ© ŸÅŸä ÿßŸÑŸÑŸàÿ®Ÿä ŸÖÿπ ÿ±ŸÇÿµÿßÿ™")
print("3. üëï 4 ÿ≥ŸÉŸÜÿßÿ™ ŸÖÿÆÿ™ŸÑŸÅÿ© (ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿå ÿπÿ≥ŸÉÿ±Ÿäÿå ŸÉÿßŸàÿ®ŸàŸäÿå ŸÜŸäŸÜÿ¨ÿß)")
print("4. üéµ ŸÜÿ∏ÿßŸÖ ÿµŸàÿ™Ÿä ÿßÿ≠ÿ™ÿ±ÿßŸÅŸä ŸÖÿ™ÿπÿØÿØ ÿßŸÑÿ∑ÿ®ŸÇÿßÿ™")
print("5. üó∫Ô∏è ÿÆÿ±Ÿäÿ∑ÿ© ÿµÿ∫Ÿäÿ±ÿ© ÿØÿßÿ¶ÿ±Ÿäÿ© + ÿÆÿ±Ÿäÿ∑ÿ© ŸÉÿ®Ÿäÿ±ÿ© ÿ™ŸÅÿßÿπŸÑŸäÿ©")
print("6. üéØ ÿ≥ŸÉŸàÿ® ÿ≠ŸÇŸäŸÇŸä ŸÖÿπ ÿ™ŸÉÿ®Ÿäÿ± ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß")
print("7. üèä ŸÜÿ∏ÿßŸÖ ÿ≥ÿ®ÿßÿ≠ÿ© ŸÅŸä ÿßŸÑÿ®ÿ≠Ÿäÿ±ÿ©")
print("8. üè† ŸÖÿ®ÿßŸÜŸä ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿØÿÆŸàŸÑ")
print("9. ‚öôÔ∏è ÿ•ÿπÿØÿßÿØÿßÿ™ ŸÉÿßŸÖŸÑÿ© ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ÿÆÿµŸäÿµ")
print("10. ‚è∏Ô∏è ŸÇÿßÿ¶ŸÖÿ© ÿ™ŸàŸÇŸÅ ŸÑŸÑÿπÿ®ÿ©")
